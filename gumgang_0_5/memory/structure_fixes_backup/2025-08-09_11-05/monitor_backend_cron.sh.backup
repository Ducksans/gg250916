#!/bin/bash
# Gumgang Backend 모니터링 (Cron)
# 5분마다 실행되어 백엔드 상태 확인

LOG_FILE="/home/duksan/바탕화면/gumgang_0_5/backend/logs/monitor.log"

# 백엔드 체크 및 자동 재시작
if ! curl -s http://localhost:8001/health > /dev/null 2>&1; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Backend down, restarting..." >> "$LOG_FILE"
    /home/duksan/바탕화면/gumgang_0_5/auto_start_backend.sh start >> "$LOG_FILE" 2>&1
else
    # 정상 작동 로그 (하루에 한 번만)
    HOUR=$(date +%H)
    if [ "$HOUR" = "09" ]; then
        LAST_LOG=$(tail -1 "$LOG_FILE" 2>/dev/null | grep "Backend OK" | cut -d' ' -f1)
        TODAY=$(date +%Y-%m-%d)
        if [ "$LAST_LOG" != "$TODAY" ]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Backend OK" >> "$LOG_FILE"
        fi
    fi
fi
