# Task Protocol Guard - Pre-commit Hooks
# í• ë£¨ì‹œë„¤ì´ì…˜ ë° Protocol ìœ„ë°˜ ë°©ì§€
# Created: 2025-08-08

repos:
  # ê¸°ë³¸ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-yaml
        name: YAML ë¬¸ë²• ê²€ì‚¬
      - id: check-json
        name: JSON ë¬¸ë²• ê²€ì‚¬
      - id: check-added-large-files
        name: ëŒ€ìš©ëŸ‰ íŒŒì¼ ì°¨ë‹¨
        args: ['--maxkb=1000']
      - id: check-merge-conflict
        name: ë³‘í•© ì¶©ëŒ í‘œì‹œ ê²€ì‚¬
      - id: detect-private-key
        name: ê°œì¸ í‚¤ ê°ì§€
      - id: trailing-whitespace
        name: ì¤„ ë ê³µë°± ì œê±°
      - id: end-of-file-fixer
        name: íŒŒì¼ ë ê°œí–‰ ì¶”ê°€
      - id: mixed-line-ending
        name: ê°œí–‰ ë¬¸ì ì¼ê´€ì„±
        args: ['--fix=lf']

  # Python ì½”ë“œ ê²€ì‚¬
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        name: Python ì½”ë“œ í¬ë§·íŒ…
        language_version: python3
        files: \.py$

  # Task Protocol ê²€ì¦ (ì»¤ìŠ¤í…€ í›…)
  - repo: local
    hooks:
      - id: protocol-guard
        name: Task Protocol Guard ê²€ì¦
        entry: python protocol_guard.py --quiet
        language: python
        pass_filenames: false
        always_run: true
        stages: [commit]

      - id: task-id-format
        name: Task ID í˜•ì‹ ê²€ì¦
        entry: bash -c 'if grep -r "GG-[0-9]\{8\}-[0-9]\{3\}" --include="*.py" --include="*.json" . | grep -v "GG-20250108-0[0-1][0-9]" > /dev/null; then echo "âŒ ì˜ëª»ëœ Task ID í˜•ì‹ ê°ì§€!"; exit 1; fi'
        language: system
        pass_filenames: false

      - id: no-react-hallucination
        name: React/Next.js í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€
        entry: bash -c 'if grep -r "create-react-app\|next\s\+dev\|next\s\+build\|useEffect\|useState" --include="*.py" --include="*.js" --include="*.ts" --include="*.tsx" gumgang-v2/ 2>/dev/null; then echo "âš ï¸ React/Next.js ì½”ë“œ ê°ì§€! Taurië¥¼ ì‚¬ìš©í•˜ì„¸ìš”!"; exit 1; fi || exit 0'
        language: system
        pass_filenames: false
        always_run: true

      - id: no-wrong-port
        name: í¬íŠ¸ 8001 ì¼ê´€ì„± ê²€ì‚¬
        entry: bash -c 'if grep -r "localhost:3000.*backend\|:3000.*api" --include="*.py" --include="*.js" --include="*.ts" . 2>/dev/null; then echo "âŒ ë°±ì—”ë“œëŠ” í¬íŠ¸ 8001ì„ ì‚¬ìš©í•©ë‹ˆë‹¤!"; exit 1; fi || exit 0'
        language: system
        pass_filenames: false

      - id: backend-health-check
        name: ë°±ì—”ë“œ ì„œë²„ ìƒíƒœ í™•ì¸
        entry: bash -c 'curl -s http://localhost:8001/health > /dev/null 2>&1 || echo "âš ï¸ ê²½ê³ : ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ (í¬íŠ¸ 8001)"'
        language: system
        pass_filenames: false
        always_run: true

      - id: task-registry-exists
        name: Task Registry íŒŒì¼ ì¡´ì¬ í™•ì¸
        entry: bash -c 'if [ ! -f "task_tracking/master_registry.json" ]; then echo "âŒ master_registry.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"; exit 1; fi'
        language: system
        pass_filenames: false

      - id: check-date-consistency
        name: ë‚ ì§œ ì¼ê´€ì„± í™•ì¸ (2025ë…„ 8ì›”)
        entry: python -c "import datetime; print('ğŸ“… í˜„ì¬ ë‚ ì§œ:', datetime.datetime.now().strftime('%Yë…„ %mì›” %dì¼')); print('âš ï¸ TaskëŠ” 2025ë…„ 8ì›” ê¸°ì¤€ì…ë‹ˆë‹¤' if datetime.datetime.now().month != 8 else 'âœ… ë‚ ì§œ ì¼ì¹˜')"
        language: python
        pass_filenames: false
        always_run: true

      - id: token-usage-warning
        name: í† í° ì‚¬ìš©ëŸ‰ ê²½ê³ 
        entry: python -c "print('âš ï¸ í˜„ì¬ ì„¸ì…˜ í† í° ì‚¬ìš©ëŸ‰: ~40k/120k (33%)\nğŸ’¡ ë‚¨ì€ í† í°ìœ¼ë¡œ Task 006-007 ì™„ë£Œ ê°€ëŠ¥')"
        language: python
        pass_filenames: false
        always_run: true
        stages: [commit]

  # ë§ˆí¬ë‹¤ìš´ ë¦°í„°
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.38.0
    hooks:
      - id: markdownlint
        name: Markdown ë¦°íŒ…
        args: ['--fix']
        files: \.md$

# ì „ì—­ ì„¤ì •
default_language_version:
  python: python3

# ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ ë¹„í™œì„±í™” (í† í° ì ˆì•½)
# default_install_hook_types: [pre-commit]

exclude: |
  (?x)^(
    \.venv/.*|
    venv/.*|
    node_modules/.*|
    \.git/.*|
    __pycache__/.*|
    .*\.pyc|
    .*\.egg-info/.*|
    build/.*|
    dist/.*
  )$

# ì‹¤íŒ¨ ì‹œ ìë™ ìˆ˜ì • ì‹œë„
fail_fast: false
