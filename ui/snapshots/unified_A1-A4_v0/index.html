<!doctype html>
<html lang="ko" data-theme="dark">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>
            금강 UI — Unified A1–A4 (Tabs + Shortcuts + Theme + SessionMeta + A3
            Warnings)
        </title>
        <script>
            (function () {
                const head = document.head;
                const add = (t, hrefOrSrc) => {
                    const el = document.createElement(t);
                    if (t === 'link') { el.rel = 'stylesheet'; el.href = hrefOrSrc; }
                    else { el.src = hrefOrSrc; }
                    el.crossOrigin = 'anonymous';
                    head.appendChild(el);
                };
                // Auto overlay injection if present
                fetch('/ui/overlays/active.css', { method: 'HEAD' })
                    .then(r => { if (r.ok) add('link', '/ui/overlays/active.css'); });
                fetch('/ui/overlays/active.js', { method: 'HEAD' })
                    .then(r => { if (r.ok) add('script', '/ui/overlays/active.js'); });
                // Query-based one-off overlay (?overlay=/ui/overlays/exp/foo.css)
                try {
                    var u = new URL(window.location.href);
                    var ov = u.searchParams.get('overlay');
                    if (ov && typeof ov === 'string') {
                        // Restrict to UI root overlays path (CSS only)
                        if (/^\/ui\/overlays\/.+\.css$/i.test(ov)) {
                            fetch(ov, { method: 'HEAD' }).then(r => { if (r.ok) add('link', ov); });
                        }
                    }
                } catch (_) { }
            })();
        </script>
        <style>
            :root {
                --bg: #0b0c10;
                --fg: #e5e7eb;
                --muted: #94a3b8;
                --accent: #22c55e;
                --border: #1f2937;
                --panel: #0f172a;
                --panel-2: #111827;
                --shadow: 0 8px 28px rgba(0, 0, 0, 0.22);
                /* container width for wide screens (e.g., 1920x1080) */
                --container: clamp(1100px, 88vw, 1800px);
            }
            html[data-theme="light"] {
                --bg: #f8fafc;
                --fg: #0f172a;
                --muted: #475569;
                --accent: #16a34a;
                --border: #e2e8f0;
                --panel: #ffffff;
                --panel-2: #f8fafc;
                --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            }

            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                color: var(--fg);
                background:
                    radial-gradient(
                        900px 520px at 100% -20%,
                        rgba(34, 197, 94, 0.06),
                        transparent 50%
                    ),
                    linear-gradient(
                        180deg,
                        rgba(2, 6, 23, 0.82),
                        rgba(2, 6, 23, 0.62)
                    ),
                    var(--bg);
                font-family:
                    system-ui,
                    -apple-system,
                    "Segoe UI",
                    Roboto,
                    "Noto Sans KR",
                    "Apple SD Gothic Neo",
                    Arial,
                    sans-serif;
                line-height: 1.5;
                /* fullscreen stability */
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
            }

            header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: rgba(15, 23, 42, 0.65);
                border-bottom: 1px solid var(--border);
                backdrop-filter: blur(8px);
            }
            html[data-theme="light"] header {
                background: rgba(255, 255, 255, 0.85);
            }
            /* Low-FX stability mode (performance-first) */
            body.lowfx {
                --shadow: none;
                background: var(--bg) !important;
            }
            body.lowfx header, body.lowfx nav.tabs, body.lowfx section.panel, body.lowfx footer {
                box-shadow: none !important;
                -webkit-backdrop-filter: none !important;
                backdrop-filter: none !important;
                background: var(--panel) !important;
            }
            body.lowfx .btn { box-shadow: none !important; filter: none !important; }
            body.lowfx .warnbar { box-shadow: none !important; }
            /* Linux/Tauri resize ghosting mitigations */
            body[data-noblur="1"] header {
                -webkit-backdrop-filter: none;
                backdrop-filter: none;
            }
            header, nav.tabs, main, footer {
                will-change: transform;
                transform: translateZ(0);
                contain: layout paint;
            }
            section.panel, nav.tabs {
                backface-visibility: hidden;
            }
            /* Resize debounce mode to reduce ghosting during rapid window resize */
            body.resizing {
                pointer-events: none;
                cursor: progress;
                background: var(--bg);
            }
            body.resizing *, body.resizing *::before, body.resizing *::after {
                transition: none !important;
                animation: none !important;
                filter: none !important;
            }
            body.resizing header {
                box-shadow: none;
                -webkit-backdrop-filter: none;
                backdrop-filter: none;
            }
            body.resizing .btn {
                box-shadow: none;
            }

            .hdr {
                max-width: var(--container);
                margin: 0 auto;
                padding: 14px 16px 10px;
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 10px;
                align-items: center;
            }
            h1.title {
                margin: 0;
                font-size: 18px;
                letter-spacing: 0.1px;
            }

            .toolbar {
                display: inline-flex;
                gap: 8px;
                align-items: center;
            }
            .btn {
                appearance: none;
                border: 1px solid var(--border);
                background: var(--panel);
                color: var(--fg);
                border-radius: 8px;
                padding: 8px 10px;
                font-size: 13px;
                cursor: pointer;
                box-shadow: var(--shadow);
                transition: border-color .12s ease, box-shadow .12s ease, background-color .12s ease, transform .06s ease;
            }
            .btn:focus-visible {
                outline: 2px solid rgba(34, 197, 94, 0.35);
                outline-offset: 2px;
            }
            .btn:hover {
                border-color: rgba(34, 197, 94, 0.35);
                filter: brightness(1.05);
            }
            .btn:active {
                transform: translateY(1px);
                box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.18) inset;
                border-color: rgba(34, 197, 94, 0.45);
                background: linear-gradient(180deg, rgba(34, 197, 94, 0.10), transparent 40%), var(--panel);
            }
            .btn[aria-pressed="true"], .btn.is-pressed {
                outline: 2px solid rgba(34, 197, 94, 0.5);
                outline-offset: 1px;
                border-color: rgba(34, 197, 94, 0.55);
                background: linear-gradient(180deg, rgba(34, 197, 94, 0.12), transparent 45%), var(--panel);
            }
            /* Persistent highlight for last-pressed buttons */
            .btn.is-sticky {
                outline: 2px solid rgba(34, 197, 94, 0.75);
                outline-offset: 1px;
                border-color: rgba(34, 197, 94, 0.7);
                box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
                background: linear-gradient(180deg, rgba(34, 197, 94, 0.16), transparent 45%), var(--panel);
            }
            #a4-shortcuts .btn:active {
                outline: 2px solid rgba(34, 197, 94, 0.55);
                outline-offset: 1px;
            }

            p.diag {
                grid-column: 1 / -1;
                margin: 0;
                color: var(--muted);
                font-size: 12px;
                white-space: pre-wrap;
            }

            nav.tabs {
                max-width: var(--container);
                margin: 0 auto;
                display: flex;
                gap: 8px;
                padding: 8px 16px 12px;
                border-top: 1px solid transparent;
                border-bottom: 1px solid var(--border);
                background: rgba(15, 23, 42, 0.45);
            }
            html[data-theme="light"] nav.tabs {
                background: rgba(255, 255, 255, 0.85);
            }
            nav.tabs a {
                display: inline-block;
                padding: 8px 10px;
                font-size: 13px;
                color: var(--fg);
                text-decoration: none;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: var(--panel);
            }
            nav.tabs a[aria-current="page"] {
                outline: 1px solid rgba(34, 197, 94, 0.45);
                box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
            }

            main {
                max-width: var(--container);
                width: 100%;
                margin: 0 auto;
                padding: 16px;
            }
            section.panel {
                display: none;
                padding: 14px;
                border: 1px solid var(--border);
                border-radius: 12px;
                background: rgba(15, 23, 42, 0.55);
                width: 100%;
                overflow: auto;
            }
            html[data-theme="light"] section.panel {
                background: #fff;
            }
            section.panel.active {
                display: block;
            }
            section.panel h2 {
                margin: 0 0 8px;
                font-size: 16px;
            }
            section.panel p {
                margin: 0;
                color: var(--muted);
                font-size: 14px;
            }

            .grid {
                display: grid;
                grid-template-columns: max-content 1fr;
                gap: 6px 12px;
                align-items: baseline;
            }
            .label {
                color: var(--muted);
                font-size: 13px;
            }
            .mono {
                font-family:
                    ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
                font-size: 13px;
                word-break: break-all;
            }
            .row {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
            }

            footer {
                max-width: var(--container);
                margin: 18px auto 30px;
                padding: 0 16px;
                color: var(--muted);
                font-size: 12px;
                display: flex;
                gap: 12px;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            dialog#kbd-help {
                border: none;
                border-radius: 12px;
                padding: 14px 16px;
                background: var(--panel);
                color: var(--fg);
                box-shadow: var(--shadow);
                width: min(560px, 92vw);
            }
            dialog#kbd-help::backdrop {
                background: rgba(0, 0, 0, 0.45);
            }
            .kbd-grid {
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 6px 10px;
                font-size: 14px;
            }
            .kbd {
                background: var(--panel-2);
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 2px 6px;
                font-family:
                    ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
                font-size: 12px;
            }

            /* Tab warning badges */
            .tab-badge {
                margin-left: 6px;
                padding: 2px 6px;
                border-radius: 6px;
                font-size: 11px;
                border: 1px solid var(--border);
            }
            .tab-badge.warn { background: #d97706; color: #fff; }
            .tab-badge.error { background: #ef4444; color: #fff; }

            /* A3 warning banner */
            .warnbar {
                display: none;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                padding: 10px 12px;
                border: 1px solid var(--border);
                border-radius: 10px;
                background: rgba(245, 158, 11, 0.12);
            }
            .warnbar.show {
                display: flex;
            }
            .warnbar.warn {
                background: rgba(245, 158, 11, 0.12);
                border-color: rgba(245, 158, 11, 0.35);
            }
            .warnbar.error {
                background: rgba(239, 68, 68, 0.12);
                border-color: rgba(239, 68, 68, 0.35);
            }
            .warnbar .actions {
                display: inline-flex;
                gap: 8px;
            }
            .btn.accent {
                background: var(--accent);
                color: #06210f;
            }
            .btn.warn {
                background: #d97706;
                color: #fff;
                border-color: var(--border);
            }
            .btn.danger {
                background: #ef4444;
                color: #fff;
                border-color: var(--border);
            }
            /* A1 cumulative usage indicator levels */
            #a1-usage[data-level="ok"] { color: #22c55e !important; }
            #a1-usage[data-level="warn"] { color: #eab308 !important; }
            #a1-usage[data-level="error"] { color: #ef4444 !important; font-weight: 600; }
        </style>
        <script>(function(){var q=new URLSearchParams(location.search),s=(q.get('safe')||'').trim();var safe=s==='1'||s.toLowerCase()==='true';try{if(!safe){var t=document.createElement('script');t.src='/ui/tools/tokenizer/estimator.js';document.head.appendChild(t)}else{window.__GG_SAFE_MODE__=true}}catch(_){}})();</script>
    </head>

    <body>
        <header>
            <div class="hdr">
                <h1 class="title">금강 UI — Unified A1–A4</h1>
                <div class="toolbar" role="toolbar" aria-label="View controls">
                    <button
                        id="btn-theme"
                        class="btn"
                        type="button"
                        title="테마 토글 (T)"
                    >
                        다크
                    </button>
                    <button
                        id="btn-help"
                        class="btn"
                        type="button"
                        title="단축키 도움말 (?)"
                    >
                        도움말
                    </button>
                    <span id="safe-badge" class="label" style="padding: 2px 6px; border: 1px solid var(--border); border-radius: 6px; background: #d97706; color: #fff;" hidden>SAFE</span>
                </div>
                <p id="diag" class="diag" aria-live="polite">
                    • 기능 포함 미니멀(탭/단축키/테마/세션메타) • 쿼리 예:
                    ?session=GG-SESS-20250816-2249&date=20250816&version=v0 •
                    단축키: [1–4]=탭, Ctrl+←/→=탭이동, T=테마, ?=도움말,
                    Esc=닫기
                </p>
            </div>
            <nav class="tabs" aria-label="A1–A8 Tabs">
                <a href="#a1" id="tab-a1">A1 — 채팅<span id="badge-a1" class="tab-badge" hidden>WARN</span></a>
                <a href="#a2" id="tab-a2">A2 — 세션/태스크<span id="badge-a2" class="tab-badge" hidden>WARN</span></a>
                <a href="#a3" id="tab-a3">A3 — 도구 패널<span id="badge-a3" class="tab-badge" hidden>WARN</span></a>
                <a href="#a4" id="tab-a4">A4 — 상태/로그<span id="badge-a4" class="tab-badge" hidden>WARN</span></a>
                <a href="#a5" id="tab-a5">A5 — 회의(β)<span id="badge-a5" class="tab-badge" hidden>WARN</span></a>
                <a href="#a6" id="tab-a6">A6 — Atlas<span id="badge-a6" class="tab-badge" hidden>WARN</span></a>
                <a href="#a7" id="tab-a7">A7 — Business<span id="badge-a7" class="tab-badge" hidden>WARN</span></span></a>
                <a href="#a8" id="tab-a8">A8 — Roadmap<span id="badge-a8" class="tab-badge" hidden>WARN</span></span></a>
            </nav>
        </header>

        <!-- Global warning banner (persistent across tabs) -->
        <div id="global-warn" class="warnbar" aria-live="assertive" style="max-width: var(--container); margin:8px auto 0;"></div>

        <main></main>
            <!-- A5 -->
            <section id="a5" class="panel" aria-labelledby="tab-a5">
                <h2>A5 — 회의(β)</h2>
                <p class="label">회의 준비 탭입니다. 캡쳐/주석/녹화/공유 기능은 BT-10에서 연결됩니다.</p>
                <div id="a5-banner" class="warnbar" aria-live="assertive" style="margin:6px 0 8px; display:none;"></div>
                <div class="row" style="gap:8px; align-items:center">
                    <button id="btn-a5-notes" class="btn" type="button" title="회의 노트 열기" onclick="(function(){(window.ggA5Status&&ggA5Status('회의 노트는 곧 연결됩니다','ok'));(window.ggToast||alert)('회의 노트는 곧 연결됩니다');})()">회의 노트</button>
                    <button id="btn-a5-capture" class="btn" type="button" title="화면 캡쳐" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';try{const r=await fetch('http://127.0.0.1:8000/api/meetings/capture',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meetingId:sid,note:'A5 capture',payload:{source:'A5'},mode:(window.__GG_SAFE_MODE__?'SAFE':'NORMAL')})});if(r.ok){(window.ggA5Status&&ggA5Status('캡쳐 전송 완료','ok'));toast('캡쳐 전송 완료');}else{(window.ggA5Status&&ggA5Status('캡쳐 실패','warn'));toast('캡쳐 실패');}}catch(e){(window.ggA5Status&&ggA5Status('캡쳐 오류','warn'));toast('캡쳐 오류');}})()">캡쳐</button>
                    <button id="btn-a5-annotate" class="btn" type="button" title="주석 툴" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';try{const r=await fetch('http://127.0.0.1:8000/api/meetings/annotate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meetingId:sid,text:'A5 annotate',shapes:[],mode:(window.__GG_SAFE_MODE__?'SAFE':'NORMAL')})});if(r.ok){(window.ggA5Status&&ggA5Status('주석 이벤트 기록','ok'));toast('주석 이벤트 기록');}else{(window.ggA5Status&&ggA5Status('주석 실패','warn'));toast('주석 실패');}}catch(e){(window.ggA5Status&&ggA5Status('주석 오류','warn'));toast('주석 오류');}})()">주석</button>
                    <button id="btn-a5-record" class="btn" type="button" title="화면 녹화" aria-pressed="false" onclick="(async(el)=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';const on=el.getAttribute('aria-pressed')==='true';const url='http://127.0.0.1:8000/api/meetings/record/'+(on?'stop':'start');try{const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meetingId:sid,mode:(window.__GG_SAFE_MODE__?'SAFE':'NORMAL')})});if(r.ok){const next=!on;el.setAttribute('aria-pressed',next?'true':'false');if(window.ggSetRecordUI)window.ggSetRecordUI(next);if(on){(window.ggA5Status&&ggA5Status('녹화 중지','ok'));toast('녹화 중지');}else{(window.ggA5Status&&ggA5Status('녹화 시작','ok'));toast('녹화 시작');}setTimeout(function(){if(window.ggSyncRecordState)window.ggSyncRecordState();},150);}else{(window.ggA5Status&&ggA5Status('녹화 실패','warn'));toast('녹화 실패');}}catch(e){(window.ggA5Status&&ggA5Status('녹화 오류','warn'));toast('녹화 오류');}})(this)">녹화</button>
                    <input id="a5-file" type="file" accept="image/*,video/*,audio/*,application/pdf" style="display:inline-block; max-width: 46%; color: var(--fg); background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px;" />
                    <button id="btn-a5-upload" class="btn" type="button" title="파일 업로드 캡쳐" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';const f=(document.getElementById('a5-file')||{});if(!f||!f.files||!f.files[0]){(window.ggA5Status&&ggA5Status('파일을 선택하세요','warn'));toast('파일을 선택하세요');return;}const fd=new FormData();fd.append('meetingId',sid);fd.append('mode',(window.__GG_SAFE_MODE__?'SAFE':'NORMAL'));fd.append('file',f.files[0]);try{const r=await fetch('http://127.0.0.1:8000/api/meetings/capture/upload',{method:'POST',body:fd});if(r.ok){(window.ggA5Status&&ggA5Status('업로드 완료','ok'));toast('업로드 완료');if(window.ggA5FetchEvents)window.ggA5FetchEvents();}else{(window.ggA5Status&&ggA5Status('업로드 실패','warn'));toast('업로드 실패');}}catch(e){(window.ggA5Status&&ggA5Status('업로드 오류','warn'));toast('업로드 오류');}})()">업로드</button>
                    <button id="btn-a5-open-events" class="btn" type="button" title="events.jsonl 열기" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';const base=(window.ggBridgeBase?window.ggBridgeBase():'http://localhost:3037');try{await (window.ggPostJSON?window.ggPostJSON(base+'/api/open',{root:'status',path:'evidence/meetings/'+sid+'/events.jsonl'}):fetch(base+'/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:'evidence/meetings/'+sid+'/events.jsonl'})}));(window.ggA5Status&&ggA5Status('events.jsonl 열기 요청','ok'));toast('events.jsonl 열기 요청');}catch(e){(window.ggA5Status&&ggA5Status('열기 실패','warn'));toast('열기 실패');}})()">이벤트 열기</button>
                    <label class="mono" style="display:inline-flex;align-items:center;gap:6px;">
                        <input id="chk-a5-autorefresh" type="checkbox" onclick="(function(el){try{if(el.checked){if(window.__a5_auto)clearInterval(window.__a5_auto);window.__a5_auto=setInterval(function(){if(window.ggA5FetchEvents)window.ggA5FetchEvents();},5000);(window.ggA5Status&&ggA5Status('자동 새로고침 ON','ok'));}else{if(window.__a5_auto){clearInterval(window.__a5_auto);window.__a5_auto=null;}(window.ggA5Status&&ggA5Status('자동 새로고침 OFF','ok'));}}catch(_){}})(this)" /> 자동 새로고침 5s
                    </label>
                    <label class="mono" style="display:inline-flex;align-items:center;gap:6px;">
                        <input id="chk-a5-tz-local" type="checkbox" onclick="(function(el){try{localStorage.setItem('gg_a5_tz_local',el.checked?'1':'0');if(window.ggA5FetchEvents)window.ggA5FetchEvents();(window.ggA5Status&&ggA5Status(el.checked?'로컬 시간 표시 ON':'UTC 표시 ON','ok'));}catch(_){}})(this)" /> 로컬 시간
                    </label>
                    <button id="btn-a5-mini" class="btn" type="button" title="읽기 전용 보기" onclick="(async()=>{try{const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';const url='http://127.0.0.1:8000/api/meetings/'+encodeURIComponent(sid)+'/events?limit=200';const r=await fetch(url);const j=await r.json();var el=document.getElementById('a5-mini-view');if(!el){el=document.createElement('pre');el.id='a5-mini-view';el.className='mono';el.style.marginTop='8px';el.style.border='1px solid var(--border)';el.style.borderRadius='8px';el.style.background='var(--panel-2)';el.style.maxHeight='260px';el.style.overflow='auto';(document.getElementById('a5')||document.body).appendChild(el);}const arr=(j&&j.data&&j.data.events)||[];el.textContent=arr.map(e=>JSON.stringify(e)).join('\n');(window.ggA5Status&&ggA5Status('미니뷰어 갱신','ok'));}catch(e){(window.ggA5Status&&ggA5Status('미니뷰어 오류','warn'));}})()">읽기 전용 보기</button>
                </div>
            </section>
            <!-- A7 -->
            <section id="a7" class="panel" aria-labelledby="tab-a7">
                <h2>A7 — Business</h2>
                <iframe id="a7-business" title="Business ideas"
                        style="border:0; width:100%; height:68vh; background: var(--panel-2); border:1px solid var(--border); border-radius:12px;"
                        loading="lazy"></iframe>
            </section>

            <!-- A8 -->
            <section id="a8" class="panel" aria-labelledby="tab-a8">
                <h2>A8 — Roadmap</h2>
                <style>
                    .gg-rp { font: 13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); }
                    .gg-rp .hdr { display:flex; align-items:center; gap:10px; margin: 6px 0 10px; }
                    .gg-rp .chip { padding:2px 8px; border:1px solid var(--border); border-radius:999px; background:#0f1830; color:#cfe1ff; font-size:12px; }
                    .gg-rp .chip.on { background:#0e1730; border-color:#4b74d1; }
                    .gg-rp .badge { padding:2px 8px; border:1px solid var(--border); border-radius:6px; background:#0f1830; color:#cfe1ff; font-size:12px; }
                    .gg-rp .badge.ok { background: rgba(20,184,166,.12); border-color: rgba(20,184,166,.35); color:#14b8a6; }
                    .gg-rp .title { font-weight:700; color:#cfe1ff; margin-top: 6px; }
                    .gg-rp .st-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
                    .gg-rp .st { padding:3px 8px; border:1px solid var(--border); border-radius:999px; background:#0f1830; color:#d7e4ff; font-size:12px; cursor: default; }
                    .gg-rp .st.PASS { background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35); color:#22c55e; }
                    .gg-rp .st.STARTED { background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.35); color:#60a5fa; }
                    .gg-rp .st.BLOCKED { background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); color:#ef4444; }
                    .gg-rp .st.PLANNED { opacity:.85; }
                    .gg-rp .meta { color:#94a3b8; font-size:12px; margin-top:4px; }
                    /* status line styles */
                    .gg-rp .line { padding:4px 8px; border:1px solid var(--border); border-radius:8px; margin:4px 0; background:#0f1830; }
                    .gg-rp .line.status-PASS { background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.35); color:#d1fae5; }
                    .gg-rp .line.status-STARTED { background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.35); color:#dbeafe; }
                    .gg-rp .line.status-BLOCKED { background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.35); color:#fee2e2; }
                    .gg-rp .line.status-PLANNED { opacity:.95; }
                    .gg-rp .links a { color:#93c5fd; text-decoration:none; margin-left:10px; font-size:12px; }
                    .gg-rp .links a:hover { text-decoration:underline; }
                </style>
                <div id="a8-summary" class="gg-rp hdr">
                    <span class="chip" id="a8-l1" title="라운드 1 진행(완료 시 점등)">L1</span>
                    <span class="chip" id="a8-l2" title="라운드 2 진행(완료 시 점등)">L2</span>
                    <span class="chip" id="a8-l3" title="라운드 3 진행(완료 시 점등)">L3</span>
                    <span class="badge" id="a8-chain" title="체크포인트 체인 상태(OK=정상, —=미확인/오프라인)">CHAIN: —</span>
                    <span id="a8-next" class="badge" title="다음 수행 단계">NEXT: —</span>
                    <label class="badge" style="margin-left:8px">
                        상태
                        <select id="a8-filter" title="상태 필터">
                            <option value="ALL">전체</option>
                            <option value="PASS">완료</option>
                            <option value="STARTED">진행중</option>
                            <option value="BLOCKED">차단</option>
                            <option value="PLANNED">계획</option>
                        </select>
                    </label>
                    <span class="links">
                        <a href="#" id="a8-open-roadmap" rel="noopener" title="로드맵 문서를 시스템 기본 편집기로 열기(Bridge /api/open)">로드맵 문서 열기</a>
                        <a href="#" id="a8-browser-view" rel="noopener" title="브라우저에서 로드맵 미리보기(Bridge /api/fs/read)" style="margin-left:10px">브라우저 뷰</a>
                    </span>
                </div>
                <div id="a8-tree" class="gg-rp"></div>
                <dialog id="a8-evidence-modal" style="border:none;border-radius:12px;padding:14px 16px;background:var(--panel);color:var(--fg);box-shadow:var(--shadow);width:min(720px,92vw);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
                        <div id="a8-evm-title" style="font-weight:700;">증거 모두 보기</div>
                        <div>
                            <button type="button" class="btn" id="a8-evm-close">닫기</button>
                        </div>
                    </div>
                    <div id="a8-evm-body" style="max-height:min(60vh,560px);overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--panel);"></div>
                    <script>
                        (function(){
                            var dlg = document.getElementById('a8-evidence-modal');
                            var btn = document.getElementById('a8-evm-close');
                            if (btn && dlg) {
                                btn.onclick = function(){ try{ dlg.close(); }catch(_){ dlg.open=false; } };
                            }
                            window.__ggShowEvidenceModal = function(stId, evs){
                                try{
                                    var body = document.getElementById('a8-evm-body');
                                    var title = document.getElementById('a8-evm-title');
                                    if (!body || !title) return;
                                    title.textContent = '증거 모두 보기 — '+(stId||'');
                                    // Build list
                                    var html = '';
                                    if (!evs || !evs.length) {
                                        html = '<div class="label">증거가 없습니다.</div>';
                                    } else {
                                        html = evs.map(function(p, idx){
                                            var rp = (typeof p==='string' && p.indexOf('status/')===0) ? p.slice(7) : p;
                                            var esc = function(s){ return String(s).replace(/[&<>"]/g,function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c];}); };
                                            return ''+
                                            '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:8px;padding:8px;margin:6px 0;background:var(--panel);">'+
                                                '<div style="flex:1;min-width:0;"><div style="font:12px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;word-break:break-all;">'+esc(p)+'</div></div>'+
                                                '<div style="display:inline-flex;gap:6px;flex-shrink:0;">'+
                                                    '<button type="button" class="btn" data-open="'+esc(rp)+'">Open</button>'+
                                                    '<button type="button" class="btn" data-view="'+esc(rp)+'">View</button>'+
                                                '</div>'+
                                            '</div>';
                                        }).join('');
                                    }
                                    body.innerHTML = html;
                                    // Wire actions
                                    var baseB = (function(){ try{var v=localStorage.getItem('gg_bridge_url')||'http://127.0.0.1:3037'; return (''+v).replace(/\/+$/,'');}catch(_){return 'http://127.0.0.1:3037';} })();
                                    var baseS = (function(){ try{var v=localStorage.getItem('gg_backend_url')||'http://127.0.0.1:8000'; return (''+v).replace(/\/+$/,'');}catch(_){return 'http://127.0.0.1:8000';} })();
                                    Array.prototype.slice.call(body.querySelectorAll('button[data-open]')).forEach(function(b){
                                        b.onclick = function(){
                                            var rp = b.getAttribute('data-open')||'';
                                            fetch(baseB+'/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:rp})}).catch(function(){});
                                        };
                                    });
                                    Array.prototype.slice.call(body.querySelectorAll('button[data-view]')).forEach(function(b){
                                        b.onclick = function(){
                                            var rp = b.getAttribute('data-view')||'';
                                            // Open window synchronously to avoid popup blocker
                                            var w = window.open('about:blank','_blank');
                                            if(!w) return;
                                            var html='<!doctype html><html lang="ko"><head><meta charset="utf-8"><title>'+rp+'</title><style>body{font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;white-space:pre-wrap;color:#0f172a;background:#f8fafc}</style></head><body>불러오는 중…</body></html>';
                                            try { w.document.write(html); w.document.close(); } catch(_){}
                                            fetch(baseB+'/api/fs/read?rootId=status&path='+encodeURIComponent(rp))
                                                .then(function(r){ if(!r.ok) throw new Error(); return r.json(); })
                                                .then(function(j){
                                                    try{
                                                        w.document.body.textContent = (j && typeof j.content==='string') ? j.content : '파일 내용을 불러오지 못했습니다.';
                                                    }catch(_){}
                                                })
                                                .catch(function(){
                                                    try{ w.document.body.textContent = '파일 내용을 불러오지 못했습니다.'; }catch(_){}
                                                });
                                        };
                                    });
                                    // Open dialog
                                    try { dlg.showModal(); } catch(_) { dlg.open = true; }
                                }catch(_){}
                            };
                        })();
                    </script>
                </dialog>
                <script>
                    (function(){
                        function bb(){try{var v=localStorage.getItem('gg_backend_url')||'http://127.0.0.1:8000'; return (''+v).replace(/\/+$/,'');}catch(_){return 'http://127.0.0.1:8000';}}
                        function br(){try{var v=localStorage.getItem('gg_bridge_url')||'http://127.0.0.1:3037'; return (''+v).replace(/\/+$/,'');}catch(_){return 'http://127.0.0.1:3037';}}
                        function get(u){return fetch(u,{cache:'no-store'}).then(function(r){if(!r.ok)throw new Error(r.status);return r.json();});}
                        function setRounds(r){var n=(r.R1?1:0)+(r.R2?1:0)+(r.R3?1:0); ['a8-l1','a8-l2','a8-l3'].forEach(function(id,i){var e=document.getElementById(id); if(e) e.classList.toggle('on', i < n);});}
                        function setChain(meta){var b=document.getElementById('a8-chain'); if(!b)return; b.classList.remove('ok'); if(meta&&meta.chain_ok){b.classList.add('ok'); b.textContent='CHAIN: OK';} else {b.textContent='CHAIN: —';}}
                        function setNext(next){var e=document.getElementById('a8-next'); if(e) e.textContent='NEXT: '+(next||'—');}
                        function ymdK(ts){
                            if(!ts) return '';
                            try{
                                // 한국 표준시(Asia/Seoul) 날짜+시간
                                var d = new Date(ts);
                                var sDate = d.toLocaleDateString('ko-KR',{ timeZone:'Asia/Seoul', year:'2-digit', month:'2-digit', day:'2-digit' });
                                var sTime = d.toLocaleTimeString('ko-KR',{ timeZone:'Asia/Seoul', hour12:false, hour:'2-digit', minute:'2-digit' });
                                var parts=sDate.replace(/\s/g,'').replace(/\.$/,'').split('.');
                                var y=parts[0], m=parts[1], day=parts[2];
                                return y+'년'+m+'월'+day+'일 '+sTime;
                            }catch(_){ return ts; }
                        }
                        function renderNarrative(data){
                            var host=document.getElementById('a8-tree'); if(!host)return; host.innerHTML='';
                            (data.bts||[]).forEach(function(bt){
                                var sts=(bt.sts||[]);
                                // 상태 필터 적용 및 카운트
                                var f=(window.__a8_filter||'ALL');
                                var filtered=sts.filter(function(st){ var s=String(st.status||'PLANNED').toUpperCase(); return (f==='ALL'||s===f); });
                                if(filtered.length===0){ return; } // 이 BT는 표시하지 않음
                                var wrap=document.createElement('div'); wrap.className='bt';
                                var t=document.createElement('div'); t.className='title';
                                var anyStarted=sts.some(function(s){return String(s.status||'').toUpperCase()==='STARTED';});
                                var allPassed=sts.length>0 && sts.every(function(s){return String(s.status||'').toUpperCase()==='PASS';});
                                var btStatus = allPassed ? '진행완료' : (anyStarted ? '진행중' : '진행대기');
                                t.textContent='('+btStatus+') '+(bt.id||'')+' '+(bt.title||'');
                                wrap.appendChild(t);
                                // ST 내러티브 라인들
                                filtered.forEach(function(st){
                                    var s=String(st.status||'PLANNED').toUpperCase();
                                    var line=document.createElement('div'); line.className='meta line status-'+s;
                                    var msg='(진행대기)';
                                    if(s==='PASS'){
                                        // 완료: 시작/완료가 없으면 last_ts라도 표시
                                        var started = st.start_ts ? ymdK(st.start_ts)+' 시작' : (st.last_ts ? ymdK(st.last_ts)+' 시작' : '');
                                        var ended   = st.pass_ts   ? ymdK(st.pass_ts)+' 종료'   : (st.last_ts ? ymdK(st.last_ts)+' 종료'   : '');
                                        msg='(진행완료'+(started?(' | '+started):'')+(ended?(' '+ended):'')+')';
                                    }else if(s==='STARTED'){
                                        // 진행중: 시작 없으면 last_ts로 대체
                                        var begin = st.start_ts ? ymdK(st.start_ts) : (st.last_ts ? ymdK(st.last_ts) : '');
                                        msg='(진행중'+(begin?(' | '+begin+' 시작 진행중'):'')+')';
                                    }else if(s==='BLOCKED'){
                                        msg='(차단)';
                                    }else{
                                        msg='(계획)';
                                    }
                                    // 보조로 최근 갱신 시각 표시(이미 포함되지 않았을 때만)
                                    if(s!=='PASS' && s!=='STARTED' && st.last_ts){
                                        msg += ' | 최근: '+ymdK(st.last_ts);
                                    }
                                    line.textContent = msg+' '+(st.id||'')+' '+(st.title||'');
                                    // 증거 열기(첫 번째) 버튼
                                    var btn=document.createElement('button');
                                    btn.textContent='증거 열기';
                                    btn.className='btn';
                                    btn.style.marginLeft='8px';
                                    var evs=(st.evidence||[]);
                                    var ev=(evs[0]||'');
                                    if(ev){
                                        btn.title='증거 파일 열기';
                                        btn.onclick=function(e){
                                            e.stopPropagation();
                                            var p = (typeof ev === 'string' && ev.indexOf('status/') === 0) ? ev.slice(7) : ev;
                                            fetch(br()+'/api/open',{
                                                method:'POST',
                                                headers:{'Content-Type':'application/json'},
                                                body: JSON.stringify({root:'status', path:p})
                                            }).catch(function(){});
                                        };
                                    } else {
                                        btn.disabled=true;
                                        btn.title='증거 없음';
                                    }
                                    line.appendChild(btn);
                                    // 증거 모두 보기(모달)
                                    var btnAll=document.createElement('button');
                                    btnAll.textContent='증거 모두 보기';
                                    btnAll.className='btn';
                                    btnAll.style.marginLeft='6px';
                                    if(evs && evs.length){
                                        btnAll.title='모든 증거 파일 목록 보기';
                                        btnAll.onclick=function(e){
                                            e.stopPropagation();
                                            try{ if(window.__ggShowEvidenceModal) window.__ggShowEvidenceModal(st.id||'', evs); }catch(_){}
                                        };
                                    } else {
                                        btnAll.disabled=true;
                                        btnAll.title='증거 없음';
                                    }
                                    line.appendChild(btnAll);
                                    wrap.appendChild(line);
                                });
                                host.appendChild(wrap);
                            });
                            // 라운드별 ST 매핑 표시(L1/L2/L3)
                            // round_map display removed due to mismatch with current ST numbering (requested)
                        }
                        function tick(){
                            get(bb()+'/api/roadmap/progress').then(function(p){
                                var d=p&&p.data||{};
                                setRounds(d.rounds||{}); setChain(d.chain||null); setNext(d.next||'—');
                                renderNarrative(d);
                            }).catch(function(){ setNext('—'); });
                        }
                        var sf=document.getElementById('a8-filter');
                        if(sf){ window.__a8_filter=sf.value; sf.addEventListener('change',function(){ window.__a8_filter=this.value; tick(); }); }
                        var rm=document.getElementById('a8-open-roadmap');
                        if(rm){
                            rm.onclick=function(e){
                                e.preventDefault();
                                fetch(br()+'/api/open',{
                                    method:'POST',
                                    headers:{'Content-Type':'application/json'},
                                    body: JSON.stringify({root:'status', path:'roadmap/BT11_to_BT21_Compass_ko.md'})
                                }).catch(function(){});
                            };
                        }
                        var rmb=document.getElementById('a8-browser-view');
                        if(rmb){
                            rmb.onclick=function(e){
                                e.preventDefault();
                                // Load file content via Bridge and open in a new readable window to avoid hash-based tab switching.
                                fetch(br()+'/api/fs/read?rootId=status&path='+encodeURIComponent('roadmap/BT11_to_BT21_Compass_ko.md'))
                                    .then(function(r){ if(!r.ok) throw new Error('read failed'); return r.json(); })
                                    .then(function(j){
                                        var w=window.open('about:blank','_blank');
                                        if(!w){ return; }
                                        var html='<!doctype html><html lang="ko"><head><meta charset="utf-8"><title>BT11_to_BT21_Compass_ko.md</title><style>body{font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;white-space:pre-wrap;color:#0f172a;background:#f8fafc}</style></head><body></body></html>';
                                        w.document.write(html);
                                        w.document.close();
                                        var pre=w.document.body;
                                        pre.textContent = (j && typeof j.content === 'string') ? j.content : '로드맵 내용을 불러오지 못했습니다.';
                                    })
                                    .catch(function(){ /* ignore */ });
                            };
                        }
                        tick(); setInterval(tick,15000);
                    })();
                </script>
            </section>
            <!-- A1 -->
            <section id="a1" class="panel active" aria-labelledby="tab-a1">
                <h2>A1 — 채팅(Chat) <span id="gg-strict-badge" class="label" style="margin-left:8px; padding:2px 6px; border:1px solid var(--border); border-radius:6px;">엄격 사실 기반 모드</span></h2>
                <!-- Inline warning banner for A1 -->
                <div id="a1-warn" class="warnbar" aria-live="assertive" style="margin:6px 0 8px;"></div>

                <!-- Bridge health -->
                <div id="a1-info" class="label">로컬 브릿지 연결 확인 중…</div>

                <!-- Meeting Quick Panel (β) — drawer skeleton -->
                <div id="a1-meeting-drawer" aria-live="polite" style="display:none; position: fixed; right: 12px; top: 120px; width: 360px; max-width: 40vw; z-index: 2147483000; background: var(--panel); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 10px 12px;">
                    <div class="label" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                        <span>회의 퀵패널(β) — 스케치</span>
                        <button type="button" class="btn" title="닫기" onclick="(function(){var d=document.getElementById('a1-meeting-drawer'); if(d){ d.style.display='none'; }})();">닫기</button>
                    </div>
                    <div class="row" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                        <button id="btn-a1-notes" class="btn" type="button" title="회의 노트" onclick="(function(){(window.ggToast||alert)('회의 노트는 곧 연결됩니다');})()">회의 노트</button>
                        <button id="btn-a1-capture" class="btn" type="button" title="화면 캡쳐" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';try{const r=await fetch('http://127.0.0.1:8000/api/meetings/capture',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meetingId:sid,note:'A1 capture',payload:{source:'A1'},mode:(window.__GG_SAFE_MODE__?'SAFE':'NORMAL')})});toast(r.ok?'캡쳐 전송 완료':'캡쳐 실패');}catch(e){toast('캡쳐 오류');}})()">캡쳐</button>
                        <button id="btn-a1-annotate" class="btn" type="button" title="주석" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';try{const r=await fetch('http://127.0.0.1:8000/api/meetings/annotate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meetingId:sid,text:'A1 annotate',shapes:[],mode:(window.__GG_SAFE_MODE__?'SAFE':'NORMAL')})});toast(r.ok?'주석 이벤트 기록':'주석 실패');}catch(e){toast('주석 오류');}})()">주석</button>
                        <button id="btn-a1-record" class="btn" type="button" title="녹화" aria-pressed="false" onclick="(async(el)=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';const on=el.getAttribute('aria-pressed')==='true';const url='http://127.0.0.1:8000/api/meetings/record/'+(on?'stop':'start');try{const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({meetingId:sid,mode:(window.__GG_SAFE_MODE__?'SAFE':'NORMAL')})});if(r.ok){const next=!on;el.setAttribute('aria-pressed',next?'true':'false');if(window.ggSetRecordUI)window.ggSetRecordUI(next);toast(on?'녹화 중지':'녹화 시작');setTimeout(function(){if(window.ggSyncRecordState)window.ggSyncRecordState();},150);}else{toast('녹화 실패');}}catch(e){toast('녹화 오류');}})(this)">녹화</button>
                        <button id="btn-a1-open-events" class="btn" type="button" title="events.jsonl 열기" onclick="(async()=>{const toast=window.ggToast||alert;const sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';const base=(window.ggBridgeBase?window.ggBridgeBase():'http://localhost:3037');try{const r=await (window.ggPostJSON?window.ggPostJSON(base+'/api/open',{root:'status',path:'evidence/meetings/'+sid+'/events.jsonl'}):fetch(base+'/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:'evidence/meetings/'+sid+'/events.jsonl'})}));toast('events.jsonl 열기 요청');}catch(e){toast('열기 실패');}})()">이벤트 열기</button>
                    </div>
                    <p class="label" style="margin-top:10px;">BT-10에서 기능 연결 예정 • 저장 경로: status/meetings/&lt;sessionId&gt;/...</p>
                </div>

                <!-- Minimal chat UI -->
                <a id="skip-to-input" href="#chat-input" class="skip-link" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" onfocus="this.style.position='fixed';this.style.left='16px';this.style.top='16px';this.style.width='auto';this.style.height='auto';this.style.padding='6px 10px';this.style.zIndex='1000';" onblur="this.style.position='absolute';this.style.left='-9999px';this.style.top='auto';this.style.width='1px';this.style.height='1px';">본문 건너뛰고 입력으로</a>
                <script>(function(){try{var a=document.getElementById('skip-to-input');if(!a)return;var b=document.body||document.documentElement;var simple=b&&b.classList&&b.classList.contains('simple');if(!simple){a.setAttribute('aria-hidden','true');a.tabIndex=-1;}}catch(_){}})();</script>
                <div
                    id="a1-wrap">
                    <!-- Bridge URL + badges -->
                    <div class="row" style="gap: 6px; align-items: center">
                        <label
                            for="bridge-url"
                            class="label"
                            style="min-width: 60px"
                            >Bridge</label
                        >
                        <input
                            id="bridge-url"
                            type="text"
                            class="mono"
                            style="
                                flex: 1;
                                min-width: 260px;
                                padding: 6px 8px;
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                background: var(--panel);
                                color: var(--fg);
                            "
                        />
                        <span
                            id="engine-badge"
                            class="label"
                            style="
                                padding: 2px 6px;
                                border: 1px solid var(--border);
                                border-radius: 6px;
                            "
                            >engine: -</span
                        >
                        <span
                            id="conv-badge"
                            class="label"
                            style="
                                padding: 2px 6px;
                                border: 1px solid var(--border);
                                border-radius: 6px;
                            "
                            >conv: -</span
                        >
                        <span
                            id="backend-badge"
                            class="label"
                            style="
                                padding: 2px 6px;
                                border: 1px solid var(--border);
                                border-radius: 6px;
                            "
                            >backend: -</span
                        >
                        <span
                            id="rec-badge"
                            class="label"
                            style="
                                padding: 2px 6px;
                                border: 1px solid var(--border);
                                border-radius: 6px;
                            "
                            >recording: OFF</span
                        >
                        <span
                            id="mode-badge"
                            class="label"
                            style="
                                padding: 2px 6px;
                                border: 1px solid var(--border);
                                border-radius: 6px;
                            "
                            >mode: 회의</span
                        >
                        <button id="btn-open-proto-a1" class="btn" type="button" title="Proto A1 열기" onclick="(function(){ try{ window.open('/ui/proto/chat_view_A1/index.html','_blank','noopener'); } catch(e){ (window.ggToast||alert)('Proto A1 열기 실패'); } })()">Proto A1 열기</button>
                    </div>

                    <!-- Messages -->
                    <div
                        id="chat-msgs" role="feed" aria-live="polite"
                        class="mono"
                        style="
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            padding: 8px;
                            max-height: none;
                            overflow: auto;
                            background: var(--panel-2);
                        "
                    ></div>

                    <!-- Input + send -->
                    <textarea
                        id="chat-input"
                        class="mono"
                        rows="4"
                        placeholder="메시지를 입력하고 Ctrl+Enter로 보내기"
                        style="width: 100%; min-height: 88px"
                    ></textarea>
                    <div class="row" style="gap: 8px; align-items: center">
                        <button id="btn-send" class="btn" type="button">
                            보내기
                        </button>
                        <button id="btn-anchor" class="btn" type="button" title="무규칙 발화 앵커링">
                            앵커
                        </button>
                    </div>
                    <div id="anchor-result" class="mono" style="margin-top:6px; border:1px solid var(--border); border-radius:8px; padding:8px; max-height:220px; overflow:auto; background: var(--panel-2); display:none;"></div>
                    <div class="row" style="gap:8px; align-items:center; margin-top:6px">
                        <label for="budget-input" class="label" style="min-width:100px">Budget</label>
                        <input id="budget-input" class="mono" type="number" min="500" max="400000" placeholder="예: 272000" style="flex:1; min-width:160px; padding:6px 8px; border:1px solid var(--border); border-radius:8px;" />
                        <button id="btn-budget-apply" class="btn" type="button" title="토큰 예산 적용" onclick="(function(){try{var v=parseInt((document.getElementById('budget-input').value||'').trim(),10);if(!Number.isFinite(v)||v<=0){(window.ggToast||alert)('유효한 숫자를 입력하세요');return;}localStorage.setItem('gg_test_budget_tokens',String(v));if(window.syncA1UsageUI)syncA1UsageUI();if(window.A3&&typeof window.A3.evaluateUtilization==='function'){var g=window.getCumUsage?getCumUsage():0;window.A3.evaluateUtilization({total_tokens:g});}if(window.applyWarningState)applyWarningState();(window.ggToast||alert)('예산 적용: '+v.toLocaleString());}catch(_){(window.ggToast||alert)('예산 적용 실패');}})()">예산 적용</button>
                    </div>
                    <!-- Consent bar (natural-language mode guard v0) -->
                    <div id="consent-bar" class="warnbar" style="display:none; margin-top:6px;">
                        <div id="consent-text" class="mono">실행으로 넘어갈까요, 아니면 아이디어를 더 다듬을까요?</div>
                        <div class="actions">
                            <button id="btn-consent-exec" class="btn accent" type="button">실행</button>
                            <button id="btn-consent-discuss" class="btn" type="button">회의 계속</button>
                        </div>
                    </div>
                    <div id="a1-usage" class="mono" aria-live="polite" style="margin-top:6px; color: var(--muted); font-size: 12px;">
                        Σ usage: 0 / 0 (0%)
                    </div>
                </div>
            </section>

            <!-- A2 -->
            <section id="a2" class="panel" aria-labelledby="tab-a2">
                <h2>A2 — 세션/태스크</h2>

                <!-- Roadmap & Progress (BT/ST tree, powered by /api/roadmap/progress) -->
                <section id="gg-roadmap-progress" class="panel" aria-label="Roadmap & Progress" style="margin:10px 0 12px; padding:10px;">
                    <style>
                        /* Inline mini styles for status colors */
                        .gg-rp { font: 13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); }
                        .gg-rp .bt { margin: 8px 0; }
                        .gg-rp .bt .title { font-weight: 700; color: #cfe1ff; }
                        .gg-rp .st-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
                        .gg-rp .st { padding: 3px 8px; border:1px solid var(--border); border-radius: 999px; font-size: 12px; background:#0f1830; color:#d7e4ff; cursor: default; }
                        .gg-rp .st.PASS { background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.35); color:#22c55e; }
                        .gg-rp .st.STARTED { background: rgba(59,130,246,0.10); border-color: rgba(59,130,246,0.35); color:#60a5fa; }
                        .gg-rp .st.BLOCKED { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.35); color:#ef4444; }
                        .gg-rp .st.PLANNED { opacity:.85; }
                        .gg-rp .meta { color:#94a3b8; font-size:12px; margin-top:4px; }
                        .gg-rp .links a { color:#93c5fd; text-decoration:none; margin-left:10px; font-size:12px; }
                        .gg-rp .links a:hover { text-decoration:underline; }
                    </style>
                    <div class="gg-rp">
                        <div id="gg-rp-note" class="meta">로드맵 진행 현황을 불러오는 중…</div>
                        <div id="gg-rp-tree"></div>
                        <div class="links">
                            <a href="/ui/?path=/status/roadmap/BT11_to_BT21_Compass_ko.md" target="_blank" rel="noopener">로드맵 문서 열기</a>
                        </div>
                    </div>
                    <script>
                        (function(){
                            function backendBase(){
                                try{ var v=localStorage.getItem('gg_backend_url')||'http://127.0.0.1:8000'; return (''+v).replace(/\/+$/,''); }catch(_){ return 'http://127.0.0.1:8000'; }
                            }
                            function bridgeBase(){
                                try{ var v=localStorage.getItem('gg_bridge_url')||'http://127.0.0.1:3037'; return (''+v).replace(/\/+$/,''); }catch(_){ return 'http://127.0.0.1:3037'; }
                            }
                            function el(tag,cls,txt){ var e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
                            async function jget(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); }
                            function renderTree(data){
                                var host=document.getElementById('gg-rp-tree'); if(!host) return;
                                host.innerHTML='';
                                (data.bts||[]).forEach(function(bt){
                                    var btEl=el('div','bt');
                                    var t=el('div','title', (bt.id||'')+' — '+(bt.title||''));
                                    btEl.appendChild(t);
                                    var list=el('div','st-list');
                                    (bt.sts||[]).forEach(function(st){
                                        var chip=el('span','st '+(st.status||'PLANNED'), st.id||'');
                                        chip.title=(st.title||st.id||'')+(st.last_ts?(' @ '+st.last_ts):'');
                                        chip.onclick=function(){
                                            var ev=(st.evidence||[])[0];
                                            if(ev){ fetch(bridgeBase()+'/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:(ev||'')})}).catch(function(){}); }
                                        };
                                        list.appendChild(chip);
                                    });
                                    btEl.appendChild(list);
                                    host.appendChild(btEl);
                                });
                            }
                            async function tick(){
                                var note=document.getElementById('gg-rp-note');
                                try{
                                    var p=await jget(backendBase()+'/api/roadmap/progress');
                                    if(note) note.textContent='NEXT: '+(p&&p.data&&p.data.next||'—')+'  •  CHAIN: '+((p&&p.data&&p.data.chain&&p.data.chain.chain_ok)?'OK':'—');
                                    if(p&&p.data) renderTree(p.data);
                                }catch(e){
                                    if(note) note.textContent='진행 정보를 불러올 수 없습니다';
                                }
                            }
                            tick(); setInterval(tick,15000);
                        })();
                    </script>
                </section>

                <div class="grid" id="session-card" style="margin-top: 6px">
                    <div class="label">SESSION_ID</div>
                    <div id="meta-session" class="mono">-</div>
                    <div class="label">CAPTURE_DATE</div>
                    <div id="meta-date" class="mono">-</div>
                    <div class="label">SNAPSHOT</div>
                    <div id="meta-version" class="mono">v0</div>
                    <div class="label">SCREENSHOTS</div>
                    <div id="meta-path" class="mono">-</div>
                </div>
                <div
                    class="row"
                    style="margin-top: 10px; gap: 8px; align-items: center"
                >
                    <label
                        for="a2-session-id"
                        class="label"
                        style="min-width: 90px"
                        >Session</label
                    >
                    <input
                        id="a2-session-id"
                        class="mono"
                        style="
                            flex: 1;
                            min-width: 200px;
                            padding: 6px 8px;
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            background: var(--panel);
                            color: var(--fg);
                        "
                    />
                    <label
                        for="a2-task-id"
                        class="label"
                        style="min-width: 60px"
                        >Task</label
                    >
                    <input
                        id="a2-task-id"
                        class="mono"
                        style="
                            flex: 1;
                            min-width: 160px;
                            padding: 6px 8px;
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            background: var(--panel);
                            color: var(--fg);
                        "
                    />
                    <button
                        id="btn-save-scope"
                        class="btn"
                        type="button"
                        title="세션/태스크 저장"
                    >
                        저장
                    </button>
                    <button
                        id="btn-copy-meta"
                        class="btn"
                        type="button"
                        title="세션 메타 복사"
                    >
                        메타 복사
                    </button>
                </div>
            </section>

            <!-- A3 -->
            <section id="a3" class="panel" aria-labelledby="tab-a3">
                <h2>A3 — 도구 패널</h2>
                <p style="margin: 6px 0 10px">
                  <a href="/ui/snapshots/unified_A1-A4_v0/memory_inspector.html" target="_blank" rel="noopener noreferrer" class="btn">Open Memory Inspector v0 (RO)</a>
                  <span class="label" style="margin-left:8px">새 창에서 열립니다. 읽기 전용.</span>
                </p>

                <!-- Warning banner and sim buttons -->
                <div class="row" style="margin: 6px 0 8px">
                    <button
                        id="btnSimWarn"
                        class="btn warn"
                        type="button"
                        title="Simulate WARN"
                    >
                        Sim WARN
                    </button>
                    <button
                        id="btnSimError"
                        class="btn danger"
                        type="button"
                        title="Simulate ERROR"
                    >
                        Sim ERROR
                    </button>
                </div>
                <div id="warnBanner" class="warnbar warn" aria-live="assertive">
                    <div id="warnText">
                        Threshold warning: context usage high.
                    </div>
                    <div class="actions">
                        <button
                            id="btnSummarize"
                            class="btn accent"
                            type="button"
                        >
                            Summarize then continue
                        </button>
                        <button id="btnAbort" class="btn danger" type="button">
                            Abort
                        </button>
                    </div>
                </div>

                <!-- Tokenizer (offline estimator) -->
                <div class="grid" style="margin: 12px 0 10px">
                    <div class="label">Tokenizer</div>
                    <div class="mono">Heuristic estimator (T0) — offline</div>
                </div>
                <div class="row" style="margin: 6px 0 6px">
                    <label for="tk-model" class="label" style="min-width: 80px"
                        >Model</label
                    >
                    <select
                        id="tk-model"
                        class="mono"
                        style="flex: 1; min-width: 280px"
                    ></select>
                </div>
                <div class="row" style="margin: 0 0 10px">
                    <label
                        for="tk-encoding"
                        class="label"
                        style="min-width: 80px"
                        >Encoding</label
                    >
                    <select
                        id="tk-encoding"
                        class="mono"
                        style="flex: 1; min-width: 280px"
                    ></select>
                </div>
                <div class="row" style="margin: 6px 0 10px">
                    <label
                        for="tokenizer-text"
                        class="label"
                        style="min-width: 80px"
                        >Input</label
                    >
                    <textarea
                        id="tokenizer-text"
                        class="mono"
                        rows="4"
                        style="flex: 1; min-width: 280px"
                    ></textarea>
                </div>
                <div id="tokenizer-board" style="margin-top: 10px"></div>
                <p class="label" style="margin-top: 8px">
                    모델/인코딩/Max/Current/Headroom/상태를 표시하고, 측정
                    버튼으로 현재 입력을 계측합니다.
                </p>
            </section>

            <!-- A4 -->
            <section id="a4" class="panel" aria-labelledby="tab-a4">
                <h2>A4 — 상태/로그</h2>
                <div class="row" style="margin: 6px 0 8px; gap: 6px; align-items: center">
                    <span
                        id="a4-upstream-badge"
                        class="label"
                        style="
                            padding: 2px 6px;
                            border: 1px solid var(--border);
                            border-radius: 6px;
                        "
                    >upstream: -</span>
                    <span
                        id="a4-cache-badge"
                        class="label"
                        style="
                            padding: 2px 6px;
                            border: 1px solid var(--border);
                            border-radius: 6px;
                        "
                        hidden
                    >cache: -</span>
                    <button id="btn-a4-copy-req" class="btn" type="button" title="마지막 request_id 복사">
                        req_id 복사
                    </button>
                </div>
                <div class="row" style="margin: 6px 0 8px">
                    <label
                        for="ops-input"
                        class="label"
                        style="min-width: 120px"
                        >Ops Log (1줄)</label
                    >
                    <input
                        id="ops-input"
                        class="mono"
                        placeholder="오늘 바뀐 점 1줄"
                        style="
                            flex: 1;
                            min-width: 280px;
                            padding: 6px 8px;
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            background: var(--panel);
                            color: var(--fg);
                        "
                    />
                    <button id="btn-ops-log" class="btn" type="button">
                        기록
                    </button>
                </div>
                <p id="ops-status" class="label">
                    좌측 상단의 도움말(?)을 참고하세요. 상태 라인은 하단에
                    표시됩니다.
                </p>
                <div id="a4-shortcuts" class="row" style="margin: 8px 0; gap: 8px; align-items: center">
                    <span class="label" style="min-width: 120px">Evidence</span>
                    <button id="btn-copy-runtime-jsonl" class="btn" type="button" title="ui_runtime_*.jsonl 경로 복사">runtime.jsonl 경로</button>
                    <button id="btn-copy-tab-p95" class="btn" type="button" title="ui_tab_nav_p95_*.json 경로 복사">tab p95 경로</button>
                    <button id="btn-copy-rt-summary" class="btn" type="button" title="현재 Runtime Summary 본문 복사">요약 복사</button>
                    <button id="btn-open-runtime-jsonl" class="btn" type="button" title="runtime.jsonl 파일 열기">runtime.jsonl 열기</button>
                    <button id="btn-open-tab-p95" class="btn" type="button" title="tab p95 파일 열기">tab p95 열기</button>
                </div>
                <div id="rt-summary" class="row" style="margin: 8px 0; gap: 8px; align-items: center">
                    <span class="label" style="min-width: 120px">Runtime Summary</span>
                    <button id="btn-rt-refresh" class="btn" type="button">새로고침</button>
                    <button id="btn-rt-save" class="btn" type="button" title="요약 저장">요약 저장</button>
                </div>
                <div id="rt-summary-body" class="mono" style="font-size: 12px; white-space: pre-wrap; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: var(--panel-2);"></div>
                <div id="auto-tools" class="row" style="margin: 8px 0; gap: 8px; align-items: center">
                    <span class="label" style="min-width: 120px">Automation</span>
                    <button id="btn-tab-p95" class="btn" type="button" title="탭 전환 100회 측정 후 저장">p95 측정</button>
                    <button id="btn-error-storm" class="btn warn" type="button" title="에러/경고 이벤트 다량 발생(로깅 확인)">에러 스톰</button>
                </div>
                <div id="auto-out" class="mono" style="font-size: 12px; white-space: pre-wrap; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: var(--panel-2);"></div>
            </section>
            <!-- A6 -->
            <section id="a6" class="panel" aria-labelledby="tab-a6">
                <h2>A6 — Atlas</h2>
                <div class="row" style="margin: 6px 0 8px; gap: 6px; align-items: center">
                    <span class="label">Checkpoints(읽기 전용)</span>
                </div>
                <iframe
                    id="a6-checkpoints"
                    title="A6 Checkpoints"
                    src="about:blank"
                    style="width: 100%; height: calc(100vh - 260px); border: 1px solid var(--border); border-radius: 8px; background: var(--panel);"
                ></iframe>
                <div class="row" style="margin: 10px 0 8px; gap: 6px; align-items: center">
                    <span class="label">SSV Summary(β)</span>
                </div>
                <iframe
                    id="a6-ssv-summary"
                    title="A6 SSV Summary"
                    src="about:blank"
                    style="width: 100%; height: 340px; border: 1px solid var(--border); border-radius: 8px; background: var(--panel);"
                ></iframe>
                <div class="row" style="margin: 6px 0 8px; gap: 6px; align-items: center">
                    <span class="label">3D Graph(실험)</span>
                </div>
                <iframe
                    id="a6-3d-viewer"
                    title="A6 3D Viewer (local spike)"
                    src="about:blank"
                    style="width: 100%; height: 420px; border: 1px solid var(--border); border-radius: 8px; background: var(--panel);"
                    loading="lazy"
                ></iframe>
                <script>
                    (function () {
                        try {
                            var base = (localStorage.getItem("gg_backend_url") || "http://127.0.0.1:8000").replace(/\/+$/, "");
                            var cp = document.getElementById("a6-checkpoints");
                            if (cp) cp.src = "/ui/proto/atlas_A6/checkpoints.html?base=" + encodeURIComponent(base);
                            var ssv = document.getElementById("a6-ssv-summary");
                            if (ssv) ssv.src = "/ui/proto/atlas_A6/ssv_summary.html?base=" + encodeURIComponent(base);
                            var v3d = document.getElementById("a6-3d-viewer");
                            if (v3d) v3d.src = "/ui/proto/atlas_A6/3d_local.html?mode=local";
                            var biz = document.getElementById("a7-business");
                            if (biz) biz.src = "/ui/proto/atlas_A7/business.html?base=" + encodeURIComponent(base);
                        } catch (_) {}
                    })();
                </script>
            </section>
        </main>

        <footer>
            <div id="status" aria-live="polite">Ready.</div>
            <div id="ts" aria-label="Rendered timestamp" class="mono"></div>
        </footer>

        <!-- Help dialog -->
        <dialog id="kbd-help" aria-label="Keyboard shortcuts">
            <form method="dialog" style="margin: 0">
                <h3 style="margin: 0 0 8px; font-size: 16px">단축키</h3>
                <div class="kbd-grid">
                    <div class="kbd">1 / 2 / 3 / 4</div>
                    <div>각 탭으로 이동</div>
                    <div class="kbd">Ctrl + ← / →</div>
                    <div>이전/다음 탭</div>
                    <div class="kbd">T</div>
                    <div>다크/라이트 테마 토글</div>
                    <div class="kbd">?</div>
                    <div>도움말 열기/닫기</div>
                    <div class="kbd">Esc</div>
                    <div>대화상자 닫기</div>
                </div>
                <div
                    style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 8px;
                        margin-top: 12px;
                    "
                >
                    <button class="btn" value="cancel" type="submit">
                        닫기 (Esc)
                    </button>
                </div>
            </form>
        </dialog>

        <script>
            (function () {
                "use strict";

                // ---------- Utilities ----------
                var $ = function (sel, ctx) {
                    return (ctx || document).querySelector(sel);
                };
                var $$ = function (sel, ctx) {
                    return Array.from((ctx || document).querySelectorAll(sel));
                };
                function onReady(fn) {
                    if (document.readyState === "loading")
                        document.addEventListener("DOMContentLoaded", fn, {
                            once: true,
                        });
                    else fn();
                }
                function setStatus(msg) {
                    var el = $("#status");
                    if (el) el.textContent = msg;
                }

                // ---------- Global warning/UI helpers ----------
                function applyWarningState() {
                    var st = window.lastWarning || null;
                    updateGlobalWarning(st);
                    updateA1Inline(st);
                    updateTabBadges(st);
                }
                function updateGlobalWarning(st) {
                    var el = $("#global-warn");
                    if (!el) return;
                    if (!st) {
                        el.textContent = "";
                        el.classList.remove("warn","error","show");
                        return;
                    }
                    el.textContent = (st.severity === "error" ? "ERROR — " : "WARN — ") + (st.message || "");
                    el.classList.remove("warn","error");
                    el.classList.add(st.severity === "error" ? "error" : "warn","show");
                }
                function updateA1Inline(st) {
                    var el = $("#a1-warn");
                    if (!el) return;
                    if (!st) {
                        el.textContent = "";
                        el.classList.remove("warn","error","show");
                        return;
                    }
                    el.textContent = (st.severity === "error" ? "ERROR — " : "WARN — ") + (st.message || "");
                    el.classList.remove("warn","error");
                    el.classList.add(st.severity === "error" ? "error" : "warn","show");
                }
                function updateTabBadges(st) {
                    var ids = ["a1","a2","a3","a4","a5","a6","a7","a8"];
                    ids.forEach(function(id){
                        var b = document.getElementById("badge-"+id);
                        if (!b) return;
                        if (!st) {
                            b.textContent = "";
                            b.classList.remove("warn","error");
                            b.hidden = true;
                            return;
                        }
                        b.textContent = st.severity === "error" ? "ERROR" : "WARN";
                        b.classList.remove("warn","error");
                        b.classList.add(st.severity === "error" ? "error" : "warn");
                        b.hidden = false;
                    });
                }

                // ---------- Tabs / Navigation ----------
                                var ORDER = ["#a1", "#a2", "#a3", "#a4", "#a5", "#a6", "#a7", "#a8"];
                var VALID = ORDER.reduce(function (m, h) {
                    m[h] = true;
                    return m;
                }, {});
                var DEFAULT_HASH = "#a1";
                var __gg_last_nav_key_ts = 0;

                function activate(hash) {
                    var h = hash || location.hash || DEFAULT_HASH;
                    if (!VALID[h]) h = DEFAULT_HASH;

                    ORDER.forEach(function (id) {
                        var sec = $(id);
                        if (sec) sec.classList.toggle("active", id === h);
                    });
                    ORDER.forEach(function (id) {
                        var tab = $("#tab-" + id.slice(1));
                        if (tab) {
                            if (id === h)
                                tab.setAttribute("aria-current", "page");
                            else tab.removeAttribute("aria-current");
                        }
                    });
                    try {
                        history.replaceState(null, "", h);
                    } catch (_) {}
                    setStatus("탭 전환: " + h.slice(1).toUpperCase());
                    try { applyWarningState(); } catch (_) {}
                    try {
                        var t0 = (typeof __gg_last_nav_key_ts === "number" && __gg_last_nav_key_ts > 0) ? __gg_last_nav_key_ts : null;
                        var lat = t0 != null && typeof performance !== "undefined" && performance.now ? Math.round(performance.now() - t0) : null;
                        __gg_last_nav_key_ts = 0;
                        var base = ((localStorage.getItem("gg_bridge_url") || "http://localhost:3037") + "").replace(/\/+$/, "");
                        var line = new Date().toISOString() + " " + h + (lat != null ? (" " + lat + "ms") : "") + "\n";
                        var key = "gg_ui_tab_nav_log";
                        var prev = "";
                        try { prev = localStorage.getItem(key) || ""; } catch (_) {}
                        var body = prev + line;
                        fetch(base + "/api/save", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                root: "status",
                                path: "evidence/ui_tab_nav.log",
                                content: body,
                                overwrite: true,
                                ensureDirs: true
                            })
                        }).catch(function(){});
                        try { localStorage.setItem(key, body); } catch (_) {}
                    } catch (_) {}
                }

                // ---------- Theme ----------
                var THEME_KEY = "gg_theme";
                function prefersDark() {
                    return !!(
                        window.matchMedia &&
                        window.matchMedia("(prefers-color-scheme: dark)")
                            .matches
                    );
                }
                function applyTheme(theme) {
                    var t =
                        theme ||
                        localStorage.getItem(THEME_KEY) ||
                        (prefersDark() ? "dark" : "light");
                    document.documentElement.setAttribute("data-theme", t);
                    try {
                        localStorage.setItem(THEME_KEY, t);
                    } catch (_) {}
                    var btn = $("#btn-theme");
                    if (btn) btn.textContent = t === "dark" ? "다크" : "라이트";
                    setStatus("테마: " + (t === "dark" ? "Dark" : "Light"));
                }
                function toggleTheme() {
                    var cur =
                        document.documentElement.getAttribute("data-theme") ||
                        "dark";
                    applyTheme(cur === "dark" ? "light" : "dark");
                }

                // ---------- Session Meta ----------
                function yyyymmdd(d) {
                    var y = d.getFullYear(),
                        m = String(d.getMonth() + 1).padStart(2, "0"),
                        dd = String(d.getDate()).padStart(2, "0");
                    return "" + y + m + dd;
                }
                function parseQuery() {
                    var q = new URLSearchParams(location.search);
                    return {
                        session: (q.get("session") || "GG-SESS-LOCAL").trim(),
                        date: (q.get("date") || yyyymmdd(new Date())).trim(),
                        version: (q.get("version") || "v0").trim(),
                    };
                }
                function renderSessionMeta() {
                    var meta = parseQuery();
                    var path =
                        "gumgang_meeting/ui/logs/ui_unified_" +
                        meta.date +
                        "_" +
                        meta.version +
                        "_" +
                        meta.session +
                        "/screenshots/";
                    var s = $("#meta-session"),
                        d = $("#meta-date"),
                        v = $("#meta-version"),
                        p = $("#meta-path");
                    if (s) s.textContent = meta.session;
                    if (d) d.textContent = meta.date;
                    if (v) v.textContent = meta.version;
                    if (p) p.textContent = path;
                    var btn = $("#btn-copy-meta");
                    if (btn)
                        btn.onclick = function () {
                            var text = [
                                "SESSION_ID=" + meta.session,
                                "DATE=" + meta.date,
                                "VERSION=" + meta.version,
                                "SCREENSHOTS=" + path,
                            ].join("\n");
                            var copy = function (t) {
                                if (
                                    navigator.clipboard &&
                                    navigator.clipboard.writeText
                                )
                                    return navigator.clipboard.writeText(t);
                                var ta = document.createElement("textarea");
                                ta.value = t;
                                ta.style.position = "fixed";
                                ta.style.left = "-9999px";
                                document.body.appendChild(ta);
                                ta.focus();
                                ta.select();
                                var ok = false;
                                try {
                                    ok = document.execCommand("copy");
                                } catch (_) {
                                    ok = false;
                                }
                                document.body.removeChild(ta);
                                return ok
                                    ? Promise.resolve()
                                    : Promise.reject(new Error("copy failed"));
                            };
                            copy(text)
                                .then(function () {
                                    setStatus(
                                        "세션 메타를 클립보드로 복사했습니다.",
                                    );
                                })
                                .catch(function () {
                                    setStatus(
                                        "클립보드 복사 실패. 권한/브라우저 상태를 확인하세요.",
                                    );
                                });
                        };
                }

                // ---------- Help dialog ----------
                var help;
                function toggleHelp() {
                    if (!help) help = $("#kbd-help");
                    if (!help) return;
                    if (help.open) help.close();
                    else help.showModal();
                }

                // ---------- Keyboard ----------
                function isEditableTarget(t) {
                    return (
                        !!t &&
                        (t.tagName === "INPUT" ||
                            t.tagName === "TEXTAREA" ||
                            t.isContentEditable)
                    );
                }
                function gotoIndex(i) {
                    var L = ORDER.length;
                    var idx = ((i % L) + L) % L;
                    activate(ORDER[idx]);
                }

                // ---------- A1: Bridge + Chat ----------
                var historyMsgs = [];

                // Minimal Compact v0 device — dynamic UI + one-time system injection support
                function wireCompactUI() {
                    try {
                        // Defaults
                        if (localStorage.getItem("gg_compact_enabled") == null) {
                            localStorage.setItem("gg_compact_enabled", "true");
                        }
                        if (!localStorage.getItem("gg_compact_text")) {
                            localStorage.setItem(
                                "gg_compact_text",
                                "[compact:v0] 동반자; 합의 중심 노삽질. 리듬=Echo→Delta→Consent→Execute. 태그=INT, CT, OK, TODO, RISK, LOG, HOLD. 모드=회의/실행, 토큰 높을 때 간략/사람말 다운시프트. 답변은 간결, 근거·메타 포함. 실행 전 Consent 확인."
                            );
                        }
                        if (!localStorage.getItem("gg_compact_inject_next")) {
                            localStorage.setItem("gg_compact_inject_next", "0");
                        }
                    } catch (_) {}

                    // A1: insert Compact toggle + New Thread button just above the chat input
                    var ta = document.getElementById("chat-input");
                    if (ta && ta.parentNode && !document.getElementById("compact-toggle")) {
                        var row = document.createElement("div");
                        row.className = "row";
                        row.style.gap = "8px";
                        row.style.alignItems = "center";

                        var lab = document.createElement("label");
                        lab.className = "label";
                        lab.textContent = "Compact v0";
                        lab.setAttribute("for", "compact-toggle");

                        var chk = document.createElement("input");
                        chk.type = "checkbox";
                        chk.id = "compact-toggle";
                        chk.style.verticalAlign = "middle";
                        try {
                            chk.checked = (localStorage.getItem("gg_compact_enabled") || "true") !== "false";
                        } catch (_) {
                            chk.checked = true;
                        }
                        chk.addEventListener("change", function () {
                            try {
                                localStorage.setItem("gg_compact_enabled", chk.checked ? "true" : "false");
                            } catch (_) {}
                            window.setTimeout(function () {
                                setStatus("Compact v0: " + (chk.checked ? "ON" : "OFF"));
                            }, 0);
                        });

                        var btnNew = document.createElement("button");
                        btnNew.id = "btn-new-thread";
                        btnNew.type = "button";
                        btnNew.className = "btn";
                        btnNew.textContent = "새 스레드";
                        btnNew.title = "대화 기록 초기화 및 1회성 Compact 주입 준비";
                        btnNew.addEventListener("click", function () {
                            try {
                                // Reset local history and conv
                                historyMsgs.length = 0;
                                var msgs = document.getElementById("chat-msgs");
                                if (msgs) msgs.textContent = "";
                                localStorage.removeItem("gg_last_conv");
                                var convEl = document.getElementById("conv-badge");
                                if (convEl) convEl.textContent = "conv: -";
                                // Reset cumulative usage
                                localStorage.setItem("gg_cum_tokens", "0");
                                // Clear A4 meta to avoid stale badges
                                localStorage.removeItem("gg_last_request_id");
                                localStorage.removeItem("gg_last_upstream_model");
                                localStorage.removeItem("gg_last_cache_ratio");
                                try { if (typeof syncA4Meta === "function") syncA4Meta(); } catch (_){}
                                // Mark one-time injection if enabled
                                var enabled = (localStorage.getItem("gg_compact_enabled") || "true") !== "false";
                                if (enabled) localStorage.setItem("gg_compact_inject_next", "1");
                                else localStorage.setItem("gg_compact_inject_next", "0");
                                } catch (_) {}
                                try { syncA1UsageUI(); } catch (_) {}
                                setStatus("A1: 새 스레드 준비 완료 (Compact " + (((localStorage.getItem("gg_compact_enabled") || "true") !== "false") ? "ON" : "OFF") + ")");
                        });

                        row.appendChild(lab);
                        row.appendChild(chk);
                        row.appendChild(btnNew);
                        ta.parentNode.insertBefore(row, ta);
                    }

                    // A4: add Cheatsheet button next to Ops-Log button
                    var opsBtn = document.getElementById("btn-ops-log");
                    if (opsBtn && opsBtn.parentNode && !document.getElementById("btn-compact-cheatsheet")) {
                        var csBtn = document.createElement("button");
                        csBtn.id = "btn-compact-cheatsheet";
                        csBtn.className = "btn";
                        csBtn.type = "button";
                        csBtn.title = "Compact v0 요약 보기";
                        csBtn.textContent = "치트시트";
                        opsBtn.parentNode.appendChild(csBtn);

                        // Create cheatsheet dialog once
                        var dlg = document.getElementById("compact-cheatsheet");
                        if (!dlg) {
                            dlg = document.createElement("dialog");
                            dlg.id = "compact-cheatsheet";
                            dlg.setAttribute("aria-label", "Compact v0 cheatsheet");
                            dlg.innerHTML =
                                '<form method="dialog" style="margin:0">' +
                                '<h3 style="margin:0 0 8px; font-size:16px">Compact v0 — 우리 약속</h3>' +
                                '<div class="mono" id="compact-cheatsheet-body" style="white-space:pre-wrap; font-size:13px; line-height:1.4"></div>' +
                                '<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">' +
                                '<button class="btn" value="cancel" type="submit">닫기</button>' +
                                "</div>" +
                                "</form>";
                            document.body.appendChild(dlg);
                        }

                        csBtn.addEventListener("click", function () {
                            var body = document.getElementById("compact-cheatsheet-body");
                            var txt =
                                (localStorage.getItem("gg_compact_text") ||
                                    "[compact:v0] 동반자; 합의 중심 노삽질. 리듬=Echo→Delta→Consent→Execute. 태그=INT, CT, OK, TODO, RISK, LOG, HOLD. 모드=회의/실행, 토큰 높을 때 간략/사람말 다운시프트. 답변은 간결, 근거·메타 포함. 실행 전 Consent 확인.") +
                                "\n\n- 리듬: Echo→Delta→Consent→Execute\n- 태그: INT, CT, OK, TODO, RISK, LOG, HOLD\n- 모드: 회의/실행(토큰 높을 때 다운시프트)\n- 주입: 새 스레드 시작 시 1회성 system 주입(토글 ON)";
                            if (body) body.textContent = txt;
                            try {
                                dlg.showModal();
                            } catch (_) {
                                alert(txt);
                            }
                        });
                    }
                }

                // Ensure wiring on DOM ready (separate from other init paths)
                onReady(setupModeGuard);
                onReady(syncModeBadge);
                onReady(wireEOD);
                onReady(wireCompactUI);
                onReady(syncA1UsageUI);
                onReady(wireA4MetaUI);
                onReady(wireRuntimeSummaryUI);
                onReady(wireAutomationUI);
                // ---------- Mode guard v0 + EOD trigger helpers ----------
                var GG_MODE_KEY = "gg_mode"; // "discuss" | "execute"
                function getMode() {
                    var m = (localStorage.getItem(GG_MODE_KEY) || "discuss").trim();
                    return m === "execute" ? "execute" : "discuss";
                }
                function setMode(m) {
                    try { localStorage.setItem(GG_MODE_KEY, m === "execute" ? "execute" : "discuss"); } catch (_){}
                    syncModeBadge();
                }
                function syncModeBadge() {
                    var el = document.getElementById("mode-badge");
                    var m = getMode();
                    if (el) {
                        var t = "mode: " + (m === "execute" ? "실행" : "회의") + (window.__GG_SAFE_MODE__ ? " • SAFE" : "");
                        el.textContent = t;
                    }
                    // Toolbar SAFE badge toggle
                    try {
                        var tb = document.querySelector(".toolbar");
                        var badge = document.getElementById("safe-badge");
                        if (window.__GG_SAFE_MODE__) {
                            if (!badge && tb) {
                                badge = document.createElement("span");
                                badge.id = "safe-badge";
                                badge.className = "label";
                                badge.textContent = "SAFE";
                                badge.style.padding = "2px 6px";
                                badge.style.border = "1px solid var(--border)";
                                badge.style.borderRadius = "6px";
                                badge.style.background = "#d97706";
                                badge.style.color = "#fff";
                                tb.appendChild(badge);
                            } else if (badge) {
                                badge.hidden = false;
                            }
                        } else if (badge) {
                            badge.hidden = true;
                        }
                    } catch (_) {}
                }
                function getWords(key, fallback) {
                    try {
                        var raw = localStorage.getItem(key);
                        if (!raw) return fallback;
                        var arr = JSON.parse(raw);
                        return Array.isArray(arr) && arr.length ? arr : fallback;
                    } catch (_) { return fallback; }
                }
                var DEFAULT_EXEC_WORDS = ["이제 시작해 주세요","한 번 적용해 볼까요","적용 부탁합니다","진행하죠","실행해줘","바로 가자","반영해주세요","적용합시다"];
                var DEFAULT_DISC_WORDS = ["이렇게 해보면 어때요","더 좋은 아이디어 있을까요","조금 더 고민해볼까요","대안이 있을까요","질문이 있어요","어떨까요"];
                var DEFAULT_EOD_WORDS = ["오늘 마감합니다","오늘 마감","오늘 정리해 주세요","오늘은 여기까지 마감합니다"];
                function scoreIntent(text) {
                    var t = (text || "").trim();
                    var execWords = getWords("gg_mode_words_execute", DEFAULT_EXEC_WORDS);
                    var discWords = getWords("gg_mode_words_discuss", DEFAULT_DISC_WORDS);
                    var s = { exec:0, discuss:0, hits:[] };
                    execWords.forEach(function(w){ if (t.indexOf(w) >= 0){ s.exec++; s.hits.push(w);} });
                    discWords.forEach(function(w){ if (t.indexOf(w) >= 0){ s.discuss++; s.hits.push(w);} });
                    if (/[?？]$/.test(t)) s.discuss++;
                    if (/실행|적용|진행/.test(t)) s.exec++;
                    return s;
                }
                function isEOD(text) {
                    var t = (text || "").trim();
                    var eod = getWords("gg_mode_words_eod", DEFAULT_EOD_WORDS);
                    return eod.some(function(w){ return t.indexOf(w) >= 0; });
                }
                var _pendingConsent = null; // { text, proceed }
                function showConsentBar(hits) {
                    var bar = document.getElementById("consent-bar");
                    var txt = document.getElementById("consent-text");
                    var bExec = document.getElementById("btn-consent-exec");
                    var bDisc = document.getElementById("btn-consent-discuss");
                    if (!bar || !bExec || !bDisc) return;
                    if (txt) txt.textContent = "실행으로 넘어갈까요, 아니면 아이디어를 더 다듬을까요?" + (hits && hits.length ? " (" + hits.join(", ") + ")" : "");
                    bar.style.display = "flex";
                    bExec.onclick = function(){ setMode("execute"); bar.style.display="none"; window.__gg_skip_consent_once = true; if (_pendingConsent && typeof _pendingConsent.proceed==="function") _pendingConsent.proceed(); _pendingConsent = null; };
                    bDisc.onclick = function(){ setMode("discuss"); bar.style.display="none"; _pendingConsent = null; };
                }
                function preSendGuard(text, proceed) {
                    // One-shot bypass after explicit consent
                    if (window.__gg_skip_consent_once) {
                        try { window.__gg_skip_consent_once = false; } catch (_){ window.__gg_skip_consent_once = false; }
                        return true;
                    }
                    var s = scoreIntent(text);
                    var mode = getMode();
                    if (s.exec > s.discuss + 1) { setMode("execute"); return true; }
                    if (s.discuss > s.exec + 1) { setMode("discuss"); return true; }
                    // ambiguous — honor current mode when explicitly chosen
                    if (mode === "execute") return true;
                    // otherwise ask
                    _pendingConsent = { text: text, proceed: proceed };
                    showConsentBar(s.hits);
                    return false;
                }
                function setupModeGuard() {
                    if (!localStorage.getItem(GG_MODE_KEY)) setMode("discuss");
                    syncModeBadge();
                }
                function wireEOD() {
                    // no-op; reserved for future UI controls
                }
                function triggerEOD(summaryText) {
                    var bridge = ($("#bridge-url").value || "http://localhost:3037").replace(/\/+$/, "");
                    var scope = getSessionScope();
                    var convId = (localStorage.getItem("gg_last_conv") || "").trim() || undefined;
                    var meta = {
                        model: (localStorage.getItem("gg_openai_model") || "-"),
                        upstream_model: (localStorage.getItem("gg_last_upstream_model") || "-"),
                        request_id: (localStorage.getItem("gg_last_request_id") || "-"),
                        cache_ratio: (localStorage.getItem("gg_last_cache_ratio") || "-"),
                        sigma_usage: (localStorage.getItem("gg_cum_tokens") || "0"),
                        budget: getTestBudgetTokens()
                    };
                    var opsPayload = "[ops] EOD — " + (summaryText || "오늘 마감") +
                        " | meta: model=" + meta.model + ", up=" + meta.upstream_model +
                        ", req=" + meta.request_id + ", cache_ratio=" + meta.cache_ratio +
                        ", Σ=" + meta.sigma_usage + "/" + meta.budget +
                        (window.lastWarning ? (", warn=" + (window.lastWarning.severity || "")) : "");
                    // Try /api/eod first
                    return fetch(bridge + "/api/eod", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            sessionId: scope.sessionId,
                            taskId: scope.taskId,
                            convId: convId,
                            summary: summaryText || null,
                            meta: meta
                        })
                    }).then(function(r){
                        if (r && r.ok) return r.json();
                        // fallback to /api/chat ops log
                        return fetch(bridge + "/api/chat", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                messages: historyMsgs.concat([{ role:"user", content: opsPayload }]),
                                sessionId: scope.sessionId,
                                taskId: scope.taskId,
                                convId: convId
                            })
                        }).then(function(rr){ return rr.json(); });
                    });
                }
                function addChatMsg(role, content) {
                    var msgs = $("#chat-msgs");
                    if (!msgs) return;
                    var div = document.createElement("div");
                    div.style.margin = "4px 0";
                    var r = document.createElement("span");
                    r.textContent = role + ": ";
                    r.style.opacity = ".8";
                    r.style.fontSize = "12px";
                    r.style.marginRight = "6px";
                    var c = document.createElement("span");
                    c.textContent = content;
                    div.appendChild(r);
                    div.appendChild(c);
                    msgs.appendChild(div);
                    msgs.scrollTop = msgs.scrollHeight;
                }

                function checkBridgeHealth() {
                    var base = (
                        localStorage.getItem("gg_bridge_url") ||
                        "http://localhost:3037"
                    ).replace(/\/+$/, "");
                    var info = $("#a1-info");
                    $("#bridge-url").value = base;
                    if (info) info.textContent = "로컬 브릿지 연결 확인 중…";
                    fetch(base + "/health")
                        .then(function (r) {
                            return r.json().catch(function () {
                                return null;
                            });
                        })
                        .then(function (j) {
                            if (!info) return;
                            if (j && j.ok && j.env && j.env.hasApiKey) {
                                info.textContent =
                                    "브릿지 연결 OK — 모델 호출 가능 (" +
                                    (j.env.model || "-") +
                                    ")";
                            } else if (j && j.ok) {
                                info.textContent =
                                    "브릿지 연결 OK — API 키 미설정";
                            } else {
                                info.textContent = "브릿지 응답 오류";
                            }
                        })
                        .catch(function () {
                            if (info)
                                info.textContent =
                                    "브릿지 미연결 또는 네트워크 오류";
                        });
                }

                function getSessionScope() {
                    var qs = new URLSearchParams(location.search);
                    var lsSession = (
                        localStorage.getItem("gg_session_id") || ""
                    ).trim();
                    var lsTask = (
                        localStorage.getItem("gg_task_id") || ""
                    ).trim();
                    return {
                        sessionId: (
                            lsSession ||
                            qs.get("session") ||
                            "GG-SESS-LOCAL"
                        ).trim(),
                        taskId: (
                            lsTask ||
                            qs.get("task") ||
                            "TASK-ROOT"
                        ).trim(),
                    };
                }

                function sendChat() {
                    if (window.__GG_SAFE_MODE__) { addChatMsg("assistant", "SAFE_MODE: chat disabled"); setStatus("SAFE_MODE: chat disabled"); return; }
                    var ta = $("#chat-input");
                    var btn = $("#btn-send");
                    var msgsEl = $("#chat-msgs");
                    if (!ta || !btn || !msgsEl) return;
                    var text = (ta.value || "").trim();
                    if (!text) return;
                    // EOD trigger intercept
                    if (isEOD(text)) {
                        addChatMsg("assistant", "EOD 기록을 시작합니다…");
                        triggerEOD(text).then(function(){
                            addChatMsg("assistant", "EOD 기록 완료");
                        }).catch(function(){
                            addChatMsg("assistant", "EOD 기록 실패 — 네트워크/브릿지 상태를 확인하세요");
                        });
                        btn.disabled = false;
                        ta.disabled = false;
                        return;
                    }
                    // Natural-language mode guard (ask on ambiguity)
                    var proceedAfterConsent = function(){ sendChat(); };
                    if (!preSendGuard(text, proceedAfterConsent)) {
                        // hold until user chooses in consent bar
                        btn.disabled = false;
                        ta.disabled = false;
                        return;
                    }
                    if (window.lastWarning && window.lastWarning.severity === "error") {
                        var proceed = window.confirm("현재 ERROR 수준 경고가 활성화되어 있습니다. 그래도 전송할까요? (권장: 요약 후 계속)");
                        if (!proceed) { setStatus("A1: 전송 취소됨(오류 경고)"); return; }
                    }

                    var bridge = (
                        $("#bridge-url").value || "http://localhost:3037"
                    ).replace(/\/+$/, "");
                    addChatMsg("user", text);
                    // ST-1206: Inject Recent dropdown (once) and append user turn to threads (best-effort)
                    (function injectRecentAndAppendUser(){
                        try {
                            var backend = (localStorage.getItem("gg_backend_url") || "http://127.0.0.1:8000").replace(/\/+$/, "");
                            // Inject Recent dropdown if missing
                            if (!document.getElementById("recent-threads")) {
                                var host = document.querySelector(".toolbar") || document.querySelector("header");
                                if (host) {
                                    var label = document.createElement("label");
                                    label.className = "btn";
                                    label.style.marginLeft = "6px";
                                    label.textContent = "Recent";
                                    // Add Refresh button for Recent list
                                    var btnRefresh = document.createElement("button");
                                    btnRefresh.type = "button";
                                    btnRefresh.className = "btn";
                                    btnRefresh.style.marginLeft = "6px";
                                    btnRefresh.title = "Refresh Recent";
                                    btnRefresh.textContent = "↻";
                                    var sel = document.createElement("select");
                                    sel.id = "recent-threads";
                                    sel.style.marginLeft = "6px";
                                    label.appendChild(sel);
                                    label.appendChild(btnRefresh);
                                    host.appendChild(label);
                                    // Populate from server (with preselect & placeholder logic)
                                    function populateRecent(){
                                        fetch(backend + "/api/threads/recent?limit=20")
                                            .then(function(r){ return r.json(); })
                                            .then(function(obj){
                                                if (!obj || !obj.ok || !obj.data || !Array.isArray(obj.data.items)) return;
                                                sel.innerHTML = "";
                                                var current = (localStorage.getItem("gg_last_conv") || "").trim();
                                                // Placeholder only when no current convId
                                                if (!current) {
                                                    var o = document.createElement("option");
                                                    o.value = "";
                                                    o.textContent = "—";
                                                    sel.appendChild(o);
                                                }
                                                obj.data.items.forEach(function(it){
                                                    var opt = document.createElement("option");
                                                    opt.value = it.convId;
                                                    var title = it.title || "(제목 없음)";
                                                    var chips = (it.top_tags || []).slice(0,3).map(function(t){ return "#"+t; }).join(" ");
                                                    var last = it.last_ts ? (" · " + it.last_ts) : "";
                                                    opt.textContent = title + " · " + it.convId + last + (chips ? (" · " + chips) : "");
                                                    if (current && it.convId === current) { opt.selected = true; }
                                                    sel.appendChild(opt);
                                                });
                                            }).catch(function(){});
                                    }
                                    populateRecent();
                                    btnRefresh.addEventListener("click", populateRecent);
                                    // On change, load and render thread
                                    sel.addEventListener("change", function(){
                                        var id = sel.value;
                                        if (!id) return;
                                        fetch(backend + "/api/threads/read?convId=" + encodeURIComponent(id))
                                            .then(function(r){ return r.json(); })
                                            .then(function(obj){
                                                if (!obj || !obj.ok || !obj.data || !Array.isArray(obj.data.turns)) return;
                                                var msgs = document.getElementById("chat-msgs");
                                                if (!msgs) return;
                                                msgs.innerHTML = "";
                                                obj.data.turns.forEach(function(t){
                                                    addChatMsg(t.role, t.text);
                                                });
                                                try { localStorage.setItem("gg_last_conv", id); } catch(_){}
                                                var convEl = document.getElementById("conv-badge");
                                                if (convEl) convEl.textContent = "conv: " + id;
                                            }).catch(function(){});
                                    });
                                }
                            }
                            // Append user turn
                            var tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || null);
                            var conv = (localStorage.getItem("gg_last_conv") || null);
                            var payload = { convId: conv || undefined, role: "user", text: text, refs: [], meta: { tz_client: tz } };
                            fetch(backend + "/api/threads/append", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload)
                            }).catch(function(){});
                        } catch(_) {}
                    })();

                    // ST-1205: recall + evidence + session save (user/assistant turns)
                    var backend = (localStorage.getItem("gg_backend_url") || "http://127.0.0.1:8000").replace(/\/+$/, "");
                    (function () {
                        try {
                            // Save user turn
                            fetch(backend + "/api/memory/store", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    tier: "ultra_short",
                                    text: text,
                                    refs: [],
                                    mode: (window.__GG_SAFE_MODE__ ? "SAFE" : "NORMAL"),
                                    sessionId: scope.sessionId,
                                }),
                            }).catch(function () {});
                        } catch (_) {}
                    })();

                    var __recallRefs = [];
                    try { window.__a1RecallBullets = ""; } catch (_) {}
                    try {
                        window.__a1RecallPromise = new Promise(function(resolve){
                            try {
                                var u = new URL(backend + "/api/memory/search");
                                u.searchParams.set("q", text);
                                u.searchParams.set("k", "5");
                                u.searchParams.set("need_fresh", "1");
                                u.searchParams.set("self_rag", "1");
                                fetch(u.toString(), { method: "GET" })
                                    .then(function (r) { return r.json(); })
                                    .then(function (sr) {
                                        if (!sr || !sr.ok || !sr.data) { resolve(null); return; }
                                        var items = Array.isArray(sr.data.items) ? sr.data.items.slice(0, 3) : [];
                                        var evPath = sr.data.evidence_path || null;
                                        if (!items.length) { resolve(null); return; }

                                        __recallRefs = items.map(function (h) {
                                            return h.path + "#L" + (h.line_from || 0) + "-" + (h.line_to || 0);
                                        });
                                        var bullets = items
                                            .map(function (h, i) {
                                                return i + 1 + ". " + h.text + " (" + h.path + "#L" + h.line_from + "-" + h.line_to + ")";
                                            })
                                            .join("\n");
                                        try { window.__a1RecallBullets = bullets; } catch (_) {}

                                        var reply =
                                            "질문: " + text +
                                            "\n\n관련 메모 상위 " + items.length + "건:\n" + bullets +
                                            "\n\n근거 인용: " + __recallRefs.join(", ") +
                                            (evPath ? "\n검색 로그: " + evPath : "");

                                        // Render evidence (collapsed) + Open Log
                                        try {
                                            var msgs = document.getElementById("chat-msgs");
                                            if (msgs) {
                                                var wrap = document.createElement("div");
                                                wrap.style.margin = "4px 0";
                                                var det = document.createElement("details");
                                                det.open = false;
                                                var sum = document.createElement("summary");
                                                sum.textContent = "증거 " + items.length + "건";
                                                det.appendChild(sum);
                                                var pre = document.createElement("pre");
                                                pre.className = "mono";
                                                pre.style.whiteSpace = "pre-wrap";
                                                pre.style.wordBreak = "break-word";
                                                pre.textContent = reply;
                                                det.appendChild(pre);
                                                wrap.appendChild(det);
                                                if (evPath) {
                                                    var openBtn = document.createElement("button");
                                                    openBtn.type = "button";
                                                    openBtn.className = "btn";
                                                    openBtn.style.marginLeft = "6px";
                                                    openBtn.textContent = "로그 열기";
                                                    openBtn.addEventListener("click", function(){
                                                        try{
                                                            var rel = evPath.replace(/^status\//, "");
                                                            fetch(bridge + "/api/open", {
                                                                method: "POST",
                                                                headers: { "Content-Type": "application/json" },
                                                                body: JSON.stringify({ root: "status", path: rel })
                                                            }).catch(function(){});
                                                        }catch(_){}
                                                    });
                                                    wrap.appendChild(openBtn);
                                                }
                                                msgs.appendChild(wrap);
                                                msgs.scrollTop = msgs.scrollHeight;
                                            }
                                        } catch (_) {}

                                        // Save assistant evidence turn (marked)
                                        try {
                                            fetch(backend + "/api/memory/store", {
                                                method: "POST",
                                                headers: { "Content-Type": "application/json" },
                                                body: JSON.stringify({
                                                    tier: "ultra_short",
                                                    text: reply,
                                                    refs: __recallRefs,
                                                    weight: { kind: "a1_evidence" },
                                                    mode: (window.__GG_SAFE_MODE__ ? "SAFE" : "NORMAL"),
                                                    sessionId: scope.sessionId,
                                                }),
                                            }).catch(function () {});
                                        } catch (_) {}

                                        resolve({ refs: __recallRefs.slice(0), bullets: bullets, evidence_path: evPath });
                                    })
                                    .catch(function () { resolve(null); });
                            } catch (_) { resolve(null); }
                        });
                    } catch (_) { window.__a1RecallPromise = Promise.resolve(null); }

                    var pending = document.createElement("div");
                    pending.className = "mono";
                    pending.style.margin = "4px 0";

                    // Warm, witty progressive pending with elapsed time and rotating tips
                    // Structure: "assistant: " + <span id=st>status</span> [+ Cancel button at soft stage]
                    var roleSpan = document.createElement("span");
                    roleSpan.textContent = "assistant: ";
                    var statusSpan = document.createElement("span");
                    statusSpan.textContent = "생각을 꺼내는 중이에요…";
                    pending.appendChild(roleSpan);
                    pending.appendChild(statusSpan);

                    // Cancel button (appears at soft stage)
                    var cancelBtn = document.createElement("button");
                    cancelBtn.type = "button";
                    cancelBtn.className = "btn";
                    cancelBtn.style.marginLeft = "8px";
                    cancelBtn.style.padding = "2px 6px";
                    cancelBtn.style.fontSize = "11px";
                    cancelBtn.hidden = true;
                    cancelBtn.textContent = "취소";
                    pending.appendChild(cancelBtn);

                    msgsEl.appendChild(pending);
                    msgsEl.scrollTop = msgsEl.scrollHeight;

                    btn.disabled = true;
                    ta.disabled = true;
                    var done = false;
                    var cancelled = false;

                    // Configurable thresholds (ms)
                    var slowMs = parseInt((localStorage.getItem("gg_timeout_slow_ms") || "12000"), 10);
                    var softMs = parseInt((localStorage.getItem("gg_timeout_soft_ms") || "45000"), 10);
                    var hardMs = parseInt((localStorage.getItem("gg_timeout_hard_ms") || "90000"), 10);
                    var tipEvery = parseInt((localStorage.getItem("gg_loading_tips_interval_ms") || "8000"), 10);

                    function parseTips(key, def) {
                        try {
                            var raw = localStorage.getItem(key);
                            if (!raw) return def;
                            var arr = JSON.parse(raw);
                            return Array.isArray(arr) && arr.length ? arr : def;
                        } catch (_) {
                            return def;
                        }
                    }

                    var tipsInit = parseTips("gg_loading_tips_init", [
                        "생각을 꺼내는 중이에요…",
                        "실마리를 모으는 중…",
                        "첫 수를 고르고 있어요…",
                    ]);
                    var tipsSlow = parseTips("gg_loading_tips_slow", [
                        "카드 한 장 더 뽑아 볼게요… (+{s}초)",
                        "조금만 더 다듬는 중이에요 (+{s}초)",
                        "좋은 비유를 찾는 중… (+{s}초)",
                    ]);
                    var tipsSoft = parseTips("gg_loading_tips_soft", [
                        "좋은 답을 위해 곱씹는 중… (+{s}초) — 취소 가능",
                        "한 턴만 더 고민 중입니다 (+{s}초) — 취소 가능",
                        "경우의 수를 돌려보고 있어요 (+{s}초) — 취소 가능",
                    ]);
                    var tipsHard = parseTips("gg_loading_tips_hard", [
                        "깊게 고민 중… (+{s}초)",
                        "멀리 왔네요… (+{s}초)",
                        "정교함을 조금 더 챙기는 중… (+{s}초)",
                    ]);

                    var startTs = Date.now();
                    var lastTipAt = 0;
                    var lastTipIdx = -1;
                    var stage = "init"; // init | slow | soft | hard

                    function pickTip(list, s) {
                        if (!Array.isArray(list) || list.length === 0) return "";
                        var idx = Math.floor(Math.random() * list.length);
                        if (idx === lastTipIdx) idx = (idx + 1) % list.length;
                        lastTipIdx = idx;
                        return list[idx].replace("{s}", String(s));
                    }

                    function updateStageAndTip() {
                        if (done || cancelled) return;
                        var now = Date.now();
                        var elapsed = Math.floor((now - startTs) / 1000);

                        // Stage transition
                        var prev = stage;
                        if (now - startTs >= hardMs) stage = "hard";
                        else if (now - startTs >= softMs) stage = "soft";
                        else if (now - startTs >= slowMs) stage = "slow";
                        else stage = "init";

                        // Show cancel at soft+
                        cancelBtn.hidden = !(stage === "soft" || stage === "hard");

                        // Rotate tip every tipEvery ms or when stage changes
                        if (prev !== stage || now - lastTipAt >= tipEvery) {
                            var tip = "";
                            if (stage === "init") tip = pickTip(tipsInit, elapsed);
                            else if (stage === "slow") tip = pickTip(tipsSlow, elapsed);
                            else if (stage === "soft") tip = pickTip(tipsSoft, elapsed);
                            else tip = pickTip(tipsHard, elapsed);

                            try {
                                statusSpan.textContent = tip;
                            } catch (_) {}
                            lastTipAt = now;
                        }
                    }

                    var pendingTick = setInterval(updateStageAndTip, 500);
                    updateStageAndTip();

                    cancelBtn.addEventListener("click", function () {
                        if (done || cancelled) return;
                        cancelled = true;
                        try { clearInterval(pendingTick); } catch (_) {}
                        statusSpan.textContent = "취소되었습니다";
                        btn.disabled = false;
                        ta.disabled = false;
                    });

                    // Append user's message to local history
                    historyMsgs.push({ role: "user", content: text });
                    ta.value = "";

                    // Build payload with optional one-time Compact system prompt
                    var msgsToSend = historyMsgs.slice();
                    try {
                        var compactEnabled = (localStorage.getItem("gg_compact_enabled") || "true") !== "false";
                        var injectCompact = compactEnabled && localStorage.getItem("gg_compact_inject_next") === "1";
                        if (injectCompact) {
                            var ctext =
                                localStorage.getItem("gg_compact_text") ||
                                "[compact:v0] 동반자; 합의 중심 노삽질. 리듬=Echo→Delta→Consent→Execute. 태그=INT, CT, OK, TODO, RISK, LOG, HOLD. 모드=회의/실행, 토큰 높을 때 간략/사람말 다운시프트. 답변은 간결, 근거·메타 포함. 실행 전 Consent 확인.";
                            msgsToSend.unshift({ role: "system", content: ctext });
                            localStorage.setItem("gg_compact_inject_next", "0");
                        }
                    } catch (_) {}

                    var scope = getSessionScope();
                    var convId =
                        (localStorage.getItem("gg_last_conv") || "").trim() ||
                        null;

                    (function(){
                        // C: inject recall summary into prompt when enabled (deterministic: wait for recall via Promise.race with timeout)
                        var cfg = (function(){
                            try{
                                if (window.ggRecallPromptConfig) return window.ggRecallPromptConfig();
                                var en = (localStorage.getItem("gg_recall_prompt_on") || "false") !== "false";
                                var mr = parseInt(localStorage.getItem("gg_recall_prompt_max_refs") || "3", 10);
                                if (!Number.isFinite(mr) || mr <= 0) mr = 3;
                                mr = Math.min(5, mr);
                                var st = localStorage.getItem("gg_recall_prompt_style") || "system";
                                if (st !== "system" && st !== "context") st = "system";
                                return { enabled: en, maxRefs: mr, style: st };
                            }catch(_){
                                return { enabled:false, maxRefs:3, style:"system" };
                            }
                        })();
                        var baseWait = parseInt((localStorage.getItem("gg_recall_inject_wait_ms") || "2000"), 10);
                        var waitMs = Math.max(0, Math.min(5000, baseWait || 2000));
                        function withTimeout(p, ms){
                            return new Promise(function(resolve){
                                var to = setTimeout(function(){ resolve(null); }, Math.max(0, Math.min(5000, ms)));
                                Promise.resolve(p).then(function(v){ try{ clearTimeout(to);}catch(_){ } resolve(v); }).catch(function(){ try{ clearTimeout(to);}catch(_){ } resolve(null); });
                            });
                        }
                        var baseP = (typeof window !== "undefined" && window.__a1RecallPromise) ? window.__a1RecallPromise : Promise.resolve(null);
                        var recP = cfg.enabled ? withTimeout(baseP, waitMs) : Promise.resolve(null);
                        recP
                        .then(function(rec){
                            try { window.__gg_last_evidence_path = (rec && rec.evidence_path) ? rec.evidence_path : null; } catch(_){}
                            var msgsFinal = msgsToSend.slice();
                            if (rec && ((rec.refs && rec.refs.length) || (rec.bullets && rec.bullets.length))) {
                                var refs = (rec.refs || []).slice(0, cfg.maxRefs || 3);
                                var bullets = rec.bullets || "";
                                var injText =
                                    "[엄격 사실 기반] 아래 근거를 1순위로 사용하여 한 문단으로 답하라. 반드시 근거 1–3과 evidence_path를 말미에 포함하라. 최근성 우선, 상충 시 근거 우선.\n" +
                                    (bullets ? (bullets + "\n\n") : "") +
                                    (refs.length ? ("Refs:\n- " + refs.join("\n- ")) : "");
                                var role = (cfg.style === "system") ? "system" : "user";
                                msgsFinal.unshift({ role: role, content: injText });
                            }
                            // Strict gate: if no refs after waiting, block model call and show guidance
                            if (!(rec && rec.refs && rec.refs.length)) {
                                try {
                                    var msgs = document.getElementById("chat-msgs");
                                    if (msgs) {
                                        var wrap0 = document.createElement("div");
                                        wrap0.style.margin = "4px 0";
                                        var det0 = document.createElement("details");
                                        det0.open = false;
                                        var sum0 = document.createElement("summary");
                                        sum0.textContent = "증거 0건(근거 부족)";
                                        det0.appendChild(sum0);
                                        var pre0 = document.createElement("pre");
                                        pre0.className = "mono";
                                        pre0.style.whiteSpace = "pre-wrap";
                                        pre0.style.wordBreak = "break-word";
                                        var evp = rec && rec.evidence_path ? ("\n검색 로그: " + rec.evidence_path) : "";
                                        pre0.textContent = "근거 부족 — 최근 메모에서 활용 가능한 근거가 없습니다." + evp;
                                        det0.appendChild(pre0);
                                        wrap0.appendChild(det0);
                                        msgs.appendChild(wrap0);
                                        msgs.scrollTop = msgs.scrollHeight;
                                    }
                                } catch (_) {}
                                pending.textContent = "assistant: 근거 부족 — 답변 생성 보류";
                                btn.disabled = false;
                                ta.disabled = false;
                                done = true;
                                try { clearInterval(pendingTick); } catch (_) {}
                                return Promise.reject({ _gg_skip: true });
                            }
                            return fetch(bridge + "/api/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    messages: msgsFinal,
                                    sessionId: scope.sessionId,
                                    taskId: scope.taskId,
                                    convId: convId || undefined,
                                    model:
                                        localStorage.getItem("gg_openai_model") ||
                                        undefined,
                                }),
                            });
                        })
                        .then(function (r) {
                            return r.json().catch(function () {
                                return {
                                    ok: false,
                                    error: { message: "Invalid JSON" },
                                };
                            });
                        })
                        .then(function (resp) {
                            if (!resp || !resp.ok) {
                                var msg =
                                    resp && resp.error && resp.error.message
                                        ? resp.error.message
                                        : "요청 실패";
                                pending.textContent =
                                    "assistant: 오류 — " + msg;
                                btn.disabled = false;
                                ta.disabled = false;
                                done = true;
                                try { clearInterval(pendingTick); } catch (_) {}
                                return;
                            }
                            var newConv =
                                (resp.data && resp.data.convId) || convId;
                            if (newConv) {
                                try {
                                    localStorage.setItem(
                                        "gg_last_conv",
                                        newConv,
                                    );
                                } catch (_) {}
                            }
                            var convEl = $("#conv-badge");
                            if (convEl)
                                convEl.textContent =
                                    "conv: " + (newConv || "-");

                            var content =
                                resp.data &&
                                resp.data.message &&
                                resp.data.message.content
                                    ? resp.data.message.content
                                    : "";
                            historyMsgs.push({
                                role: "assistant",
                                content: content,
                            });
                            // ST-1206: Append assistant turn with refs/evidence_path (best-effort)
                            (function(){
                                try {
                                    var backend = (localStorage.getItem("gg_backend_url") || "http://127.0.0.1:8000").replace(/\/+$/, "");
                                    var conv = (localStorage.getItem("gg_last_conv") || newConv || null);
                                    var payload = {
                                        convId: conv || undefined,
                                        role: "assistant",
                                        text: content,
                                        refs: (__recallRefs && __recallRefs.length ? __recallRefs : []),
                                        meta: { evidence_path: (window.__gg_last_evidence_path || null) }
                                    };
                                    fetch(backend + "/api/threads/append", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify(payload)
                                    }).catch(function(){});
                                } catch(_) {}
                            })();
                            try {
                                var elapsedSec = Math.floor((Date.now() - startTs) / 1000);
                                statusSpan.textContent = content + " (+" + elapsedSec + "초)";
                            } catch (_) {
                                pending.textContent = "assistant: " + content;
                            }

                            var engEl = $("#engine-badge");
                            if (engEl)
                                engEl.textContent =
                                    "engine: " +
                                    ((resp.data && resp.data.model) || "-");
                            // Save last meta for EOD/logging
                            try {
                                var rid = resp && resp.data && resp.data.request_id;
                                var upm = resp && resp.data && resp.data.upstream_model;
                                if (rid) localStorage.setItem("gg_last_request_id", rid);
                                if (upm) localStorage.setItem("gg_last_upstream_model", upm);
                                var u = resp && resp.data && resp.data.usage;
                                var pt = u && Number(u.prompt_tokens || 0);
                                var ctok = u && u.prompt_tokens_details && Number(u.prompt_tokens_details.cached_tokens || 0);
                                if (Number.isFinite(pt) && Number.isFinite(ctok) && pt > 0) {
                                    var ratio = (ctok / pt).toFixed(3);
                                    localStorage.setItem("gg_last_cache_ratio", String(ratio));
                                } else {
                                    try { localStorage.removeItem("gg_last_cache_ratio"); } catch (_) {}
                                }
                            } catch (_){}
                            try { syncA4Meta(); } catch (_){}

                            // A1 -> A3: pass usage for evaluation
                            try {
                                if (
                                    window.A3 &&
                                    typeof window.A3.evaluateUtilization ===
                                        "function"
                                )
                                    window.A3.evaluateUtilization(
                                        resp.data && resp.data.usage,
                                    );
                                try { applyWarningState(); } catch (_) {}
                            } catch (_) {}
                            // A1 cumulative usage update (real usage preferred, fallback heuristic)
                            try {
                                var added = 0;
                                var u = resp && resp.data && resp.data.usage;
                                if (u && (Number.isFinite(u.total_tokens) || Number.isFinite(u.prompt_tokens) || Number.isFinite(u.completion_tokens))) {
                                    var tt = Number(u.total_tokens);
                                    if (!Number.isFinite(tt)) {
                                        tt = Number(u.prompt_tokens || 0) + Number(u.completion_tokens || 0);
                                    }
                                    added = Math.max(0, Math.floor(tt || 0));
                                } else {
                                    var approxUser = Math.ceil((text || "").length / 4);
                                    var approxAsst = Math.ceil((content || "").length / 4);
                                    added = Math.max(0, approxUser + approxAsst);
                                }
                                addToCumUsage(added);
                            } catch (_) {}

                            btn.disabled = false;
                            ta.disabled = false;
                            done = true;
                            try { clearInterval(pendingTick); } catch (_) {}
                            // removed legacy hard timeout; using pendingTick interval instead
                        })
                        .catch(function (err) {
                            if (cancelled) return;
                            if (err && err._gg_skip) {
                                // Strict gate skip — already handled UI
                                return;
                            }
                            pending.textContent =
                                "assistant: 네트워크 오류 — " +
                                (err && err.message
                                    ? err.message
                                    : String(err));
                            btn.disabled = false;
                            ta.disabled = false;
                            done = true;
                            try { clearInterval(pendingTick); } catch (_) {}
                        });
                    })();
                }

                // ---------- A3: Warnings + Tokenizer ----------
                function clamp(n, min, max) {
                    return Math.min(max, Math.max(min, n));
                }
                function pad2(n) {
                    return (n < 10 ? "0" : "") + n;
                }
                function hhmmss(d) {
                    return (
                        pad2(d.getHours()) +
                        ":" +
                        pad2(d.getMinutes()) +
                        ":" +
                        pad2(d.getSeconds())
                    );
                }

                function getTestBudgetTokens() {
                    var v = parseInt(
                        (
                            localStorage.getItem("gg_test_budget_tokens") || ""
                        ).trim(),
                        10,
                    );
                    if (!Number.isFinite(v) || v <= 0) return 272000;
                    return clamp(v, 500, 400000);
                }
                function estimateTokensFromA1() {
                    var msgs = $("#chat-msgs");
                    if (!msgs) return null;
                    var text = (msgs.textContent || "").trim();
                    if (!text) return 0;
                    return Math.ceil(text.length / 4);
                }
                // ---------- A1 cumulative usage helpers ----------
                function getCumUsage() {
                    var n = parseInt((localStorage.getItem("gg_cum_tokens") || "0").trim(), 10);
                    return Number.isFinite(n) && n > 0 ? n : 0;
                }
                function setCumUsage(n) {
                    try {
                        var v = Math.max(0, Math.floor(Number(n) || 0));
                        localStorage.setItem("gg_cum_tokens", String(v));
                    } catch (_) {}
                    syncA1UsageUI();
                }
                function addToCumUsage(n) {
                    var cur = getCumUsage();
                    var add = Math.max(0, Math.floor(Number(n) || 0));
                    setCumUsage(cur + add);
                }
                function resetCumUsage() {
                    setCumUsage(0);
                }
                function syncA1UsageUI() {
                    var el = document.getElementById("a1-usage");
                    if (!el) return;
                    var cum = getCumUsage();
                    var budget = getTestBudgetTokens();
                    var ratio = budget > 0 ? cum / budget : 0;
                    var pct = Math.round(ratio * 100);
                    var level = ratio >= 0.95 ? "ERROR" : ratio >= 0.85 ? "WARN" : "OK";
                    var note =
                        level === "OK"
                            ? "below threshold"
                            : level === "WARN"
                            ? "close to limit"
                            : "near/exceed limit";
                    el.textContent = "Σ usage: " + cum + " / " + budget + " (" + pct + "%) — " + note;
                    try { el.setAttribute("data-level", level.toLowerCase()); } catch (_) {}
                    // Trigger global warning banner based on cumulative usage
                    try {
                        if (window.A3 && typeof window.A3.evaluateUtilization === "function") {
                            window.A3.evaluateUtilization({ total_tokens: cum });
                        }
                    } catch (_) {}
                    try { applyWarningState(); } catch (_) {}
                }

                window.A3 = window.A3 || {};
                (function A3_Warnings_Init() {
                    var warnBanner = $("#warnBanner");
                    var warnText = $("#warnText");
                    var btnSimWarn = $("#btnSimWarn");
                    var btnSimError = $("#btnSimError");
                    var btnSummarize = $("#btnSummarize");
                    var btnAbort = $("#btnAbort");

                    function showWarning(severity, message) {
                        window.lastWarning = { severity: severity, message: message, ts: new Date().toISOString() };
                        if (warnText) warnText.textContent = message || "Threshold warning";
                        if (warnBanner) {
                            warnBanner.classList.remove("warn","error");
                            warnBanner.classList.add(severity === "error" ? "error" : "warn","show");
                        }
                        try { applyWarningState(); } catch (_) {}
                        try { window.dispatchEvent(new CustomEvent("gg:warn", { detail: window.lastWarning })); } catch (_) {}
                        setStatus("A3: " + (severity === "error" ? "ERROR" : "WARN") + " — " + (message || ""));
                    }
                    function hideWarning() {
                        window.lastWarning = null;
                        if (warnBanner) warnBanner.classList.remove("show");
                        try { applyWarningState(); } catch (_) {}
                        try { window.dispatchEvent(new CustomEvent("gg:warn", { detail: null })); } catch (_) {}
                    }
                    function recordWarningAction(action) {
                        try {
                            console.info("[A3] action", {
                                action: action,
                                last: window.lastWarning,
                            });
                        } catch (_) {}
                    }
                    function evaluateUtilization(usage) {
                        var budget = getTestBudgetTokens();
                        var total = null;
                        if (usage && typeof usage === "object") {
                            if (Number.isFinite(usage.total_tokens))
                                total = usage.total_tokens;
                            else {
                                var pt = Number(usage.prompt_tokens || 0);
                                var ct = Number(usage.completion_tokens || 0);
                                total = pt + ct;
                            }
                        }
                        if (!Number.isFinite(total))
                            total = getCumUsage();
                        if (!Number.isFinite(total) || total <= 0) return;
                        var ratio = total / budget;
                        var pct = Math.round(ratio * 100);
                        if (ratio >= 0.95) {
                            showWarning(
                                "error",
                                "Context usage " +
                                    total +
                                    " / " +
                                    budget +
                                    " (" +
                                    pct +
                                    "%) — test budget",
                            );
                        } else if (ratio >= 0.85) {
                            showWarning(
                                "warn",
                                "Context usage " +
                                    total +
                                    " / " +
                                    budget +
                                    " (" +
                                    pct +
                                    "%) — test budget",
                            );
                        } else {
                            hideWarning();
                            setStatus(
                                "A3: usage " +
                                    total +
                                    "/" +
                                    budget +
                                    " (" +
                                    pct +
                                    "%) — below threshold",
                            );
                        }
                    }

                    if (btnSimWarn)
                        btnSimWarn.addEventListener("click", function () {
                            showWarning(
                                "warn",
                                "Simulated WARN: context usage ≥ 85%",
                            );
                        });
                    if (btnSimError)
                        btnSimError.addEventListener("click", function () {
                            showWarning(
                                "error",
                                "Simulated ERROR: context usage ≥ 95%",
                            );
                        });
                    if (btnSummarize)
                        btnSummarize.addEventListener("click", function () {
                            recordWarningAction("summarize_then_continue");
                            setStatus("A3: summarizing…");
                            setTimeout(function () {
                                hideWarning();
                                setStatus(
                                    "A3: (simulated) summary completed @ " +
                                        hhmmss(new Date()),
                                );
                            }, 300);
                        });
                    if (btnAbort)
                        btnAbort.addEventListener("click", function () {
                            recordWarningAction("abort");
                            hideWarning();
                            setStatus("A3: aborted due to warning");
                        });

                    // Observe A1 message DOM for heuristic path
                    var msgs = $("#chat-msgs");
                    if (msgs && window.MutationObserver) {
                        var tid = null;
                        var obs = new MutationObserver(function () {
                            if (tid) clearTimeout(tid);
                            tid = setTimeout(function () {
                                try {
                                    evaluateUtilization(null);
                                } catch (_) {}
                            }, 150);
                        });
                        obs.observe(msgs, {
                            childList: true,
                            subtree: true,
                            characterData: true,
                        });
                    }

                    window.A3.showWarning = showWarning;
                    window.A3.hideWarning = hideWarning;
                    window.A3.recordWarningAction = recordWarningAction;
                    window.A3.evaluateUtilization = evaluateUtilization;
                    Object.defineProperty(window.A3, "lastWarning", {
                        get: function () {
                            return window.lastWarning || null;
                        },
                    });
                })();

                // Tokenizer boot (requires GGTokenizer from estimator.js)
                function bootTokenizer() {
                    if (!window.GGTokenizer) return;
                    GGTokenizer.loadModelTable(
                        "/ui/tools/tokenizer/model_table.json",
                    ).then(function (table) {
                        var input = $("#tokenizer-text");
                        var selModel = $("#tk-model");
                        var selEnc = $("#tk-encoding");

                        var gpt5 =
                            Array.isArray(table.models) &&
                            table.models.find(function (m) {
                                return (
                                    m &&
                                    typeof m.id === "string" &&
                                    m.id.indexOf("openai/gpt-5") === 0
                                );
                            });
                        var defaultModelId = gpt5
                            ? gpt5.id
                            : "openai/gpt-4o-2024-05-13";

                        // models
                        if (selModel && Array.isArray(table.models)) {
                            table.models.forEach(function (m) {
                                var opt = document.createElement("option");
                                opt.value = m.id;
                                opt.textContent = m.display || m.id;
                                if (m.id === defaultModelId)
                                    opt.selected = true;
                                selModel.appendChild(opt);
                            });
                        }

                        function populateEncodings(encId) {
                            if (!selEnc) return;
                            while (selEnc.firstChild)
                                selEnc.removeChild(selEnc.firstChild);
                            Object.keys(table.encodings || {}).forEach(
                                function (k) {
                                    var e = table.encodings[k];
                                    var opt = document.createElement("option");
                                    opt.value = k;
                                    opt.textContent =
                                        e && e.display ? e.display : k;
                                    if (k === encId) opt.selected = true;
                                    selEnc.appendChild(opt);
                                },
                            );
                        }

                        var meta = GGTokenizer.resolveModel(
                            defaultModelId,
                            table,
                        );
                        var initialEncoding =
                            (meta && meta.encoding) ||
                            (table.defaults && table.defaults.encoding) ||
                            "cl100k_base";
                        populateEncodings(initialEncoding);

                        var ctrl = GGTokenizer.renderBoard("#tokenizer-board", {
                            modelId: defaultModelId,
                            table: table,
                            textProvider: function () {
                                return (input && input.value) || "";
                            },
                        });

                        if (selModel)
                            selModel.addEventListener("change", function () {
                                var id = selModel.value;
                                var m = GGTokenizer.resolveModel(id, table);
                                var enc =
                                    (m && m.encoding) ||
                                    (selEnc && selEnc.value) ||
                                    initialEncoding;
                                populateEncodings(enc);
                                ctrl.updateModel({
                                    modelId: id,
                                    encodingId: enc,
                                    contextWindow: m && m.context_window,
                                });
                                ctrl.measureNow();
                            });
                        if (selEnc)
                            selEnc.addEventListener("change", function () {
                                ctrl.updateModel({ encodingId: selEnc.value });
                                ctrl.measureNow();
                            });
                    });
                }

                // ---------- A4: One-line ops log ----------

                // A4 meta badges + request_id copy
                function syncA4Meta() {
                    var upEl = document.getElementById("a4-upstream-badge");
                    var cacheEl = document.getElementById("a4-cache-badge");
                    if (upEl) {
                        var up = ((localStorage.getItem("gg_last_upstream_model") || "-") + "").trim();
                        upEl.textContent = "upstream: " + (up && up !== "" ? up : "-");
                    }
                    if (cacheEl) {
                        var ratio = ((localStorage.getItem("gg_last_cache_ratio") || "") + "").trim();
                        var num = Number(ratio);
                        if (!ratio || ratio === "-" || String(ratio).toLowerCase() === "nan" || !Number.isFinite(num)) {
                            cacheEl.hidden = true;
                        } else {
                            cacheEl.textContent = "cache: " + num.toFixed(3);
                            cacheEl.hidden = false;
                        }
                    }
                }

                function wireA4MetaUI() {
                    // initial sync
                    try { syncA4Meta(); } catch (_) {}
                    // wire copy button
                    var btn = document.getElementById("btn-a4-copy-req");
                    if (btn) {
                        btn.addEventListener("click", function () {
                            var rid = ((localStorage.getItem("gg_last_request_id") || "") + "").trim();
                            var opsStatus = document.getElementById("ops-status");
                            if (!rid) {
                                if (opsStatus) opsStatus.textContent = "request_id 없음 (아직 수신되지 않음)";
                                else setStatus("request_id 없음");
                                return;
                            }
                            var copy = function (t) {
                                if (navigator.clipboard && navigator.clipboard.writeText)
                                    return navigator.clipboard.writeText(t);
                                var ta = document.createElement("textarea");
                                ta.value = t;
                                ta.style.position = "fixed";
                                ta.style.left = "-9999px";
                                document.body.appendChild(ta);
                                ta.focus();
                                ta.select();
                                var ok = false;
                                try { ok = document.execCommand("copy"); } catch (_) { ok = false; }
                                document.body.removeChild(ta);
                                return ok ? Promise.resolve() : Promise.reject(new Error("copy failed"));
                            };
                            copy(rid).then(function(){
                                if (opsStatus) opsStatus.textContent = "request_id 복사됨: " + rid;
                                else setStatus("request_id 복사됨");
                            }).catch(function(){
                                if (opsStatus) opsStatus.textContent = "클립보드 복사 실패. 권한/브라우저 상태를 확인하세요.";
                                else setStatus("클립보드 복사 실패");
                            });
                        });
                    }
                    // periodic refresh (hide ratio when unavailable)
                    try {
                        if (!window.__a4_meta_timer) {
                            window.__a4_meta_timer = setInterval(function(){
                                try { syncA4Meta(); } catch (_) {}
                            }, 2000);
                        }
                    } catch (_) {}
                }
                // ---------- A4: Runtime summary (from localStorage JSONL buffer) ----------
                function parseRuntimeSummary() {
                    var bestKey = null;
                    try {
                        for (var i = 0; i < localStorage.length; i++) {
                            var k = localStorage.key(i);
                            if (k && k.indexOf("gg_ui_runtime_jsonl_") === 0) {
                                if (!bestKey || k > bestKey) bestKey = k;
                            }
                        }
                    } catch (_) {}
                    var raw = "";
                    if (bestKey) {
                        try { raw = localStorage.getItem(bestKey) || ""; } catch (_) {}
                    }
                    var lines = (raw || "").split("\n");
                    var counts = { error: 0, unhandledrejection: 0, console_error: 0, console_warn: 0, lines: 0 };
                    var lastErr = null;
                    lines.forEach(function (ln) {
                        if (!ln || !ln.trim()) return;
                        try {
                            var obj = JSON.parse(ln);
                            counts.lines++;
                            if (obj && obj.type) {
                                if (obj.type === "error") { counts.error++; lastErr = obj; }
                                else if (obj.type === "unhandledrejection") { counts.unhandledrejection++; lastErr = obj; }
                                else if (obj.type === "console.error") counts.console_error++;
                                else if (obj.type === "console.warn") counts.console_warn++;
                            }
                        } catch (_) {}
                    });
                    return { key: bestKey, counts: counts, last_error: lastErr };
                }
                function renderRuntimeSummary() {
                    var tgt = document.getElementById("rt-summary-body");
                    var s = parseRuntimeSummary();
                    var text = "";
                    text += "key: " + (s.key || "-") + "\n";
                    text += "lines: " + s.counts.lines + "\n";
                    text += "error: " + s.counts.error + ", unhandledrejection: " + s.counts.unhandledrejection + "\n";
                    text += "console.error: " + s.counts.console_error + ", console.warn: " + s.counts.console_warn + "\n";
                    if (s.last_error) {
                        text += "last: " + (s.last_error.ts || "-") + " — " + (s.last_error.msg || "-") + "\n";
                    } else {
                        text += "last: -\n";
                    }
                    if (tgt) tgt.textContent = text;
                    return s;
                }
                function wireRuntimeSummaryUI() {
                    renderRuntimeSummary();
                    // util: copy text to clipboard with fallback
                    function copy(t) {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            return navigator.clipboard.writeText(t);
                        }
                        return new Promise(function (resolve, reject) {
                            try {
                                var ta = document.createElement("textarea");
                                ta.value = t;
                                ta.style.position = "fixed";
                                ta.style.left = "-9999px";
                                document.body.appendChild(ta);
                                ta.focus();
                                ta.select();
                                var ok = false;
                                try { ok = document.execCommand("copy"); } catch (_) { ok = false; }
                                document.body.removeChild(ta);
                                if (ok) resolve(); else reject(new Error("copy failed"));
                            } catch (e) { reject(e); }
                        });
                    }
                    // Mark button as the last-pressed in the A4 shortcuts group (persistent)
                    function markSticky(el) {
                        try {
                            var group = document.querySelectorAll("#a4-shortcuts .btn");
                            Array.prototype.forEach.call(group, function(b){
                                b.classList.remove("is-sticky");
                                b.removeAttribute("aria-selected");
                            });
                            el.classList.add("is-sticky");
                            el.setAttribute("aria-selected","true");
                        } catch (_) {}
                    }
                    var btnR = document.getElementById("btn-rt-refresh");
                    var btnS = document.getElementById("btn-rt-save");
                    if (btnR) btnR.addEventListener("click", function () { renderRuntimeSummary(); });
                    if (btnS) btnS.addEventListener("click", function () {
                        var data = renderRuntimeSummary();
                        var scope = getSessionScope();
                        var d = new Date();
                        var dateStr = yyyymmdd(d);
                        var file = "evidence/ui_runtime_summary_" + dateStr + "_" + scope.sessionId + ".json";
                        var bridge = ((document.getElementById("bridge-url") && document.getElementById("bridge-url").value) || localStorage.getItem("gg_bridge_url") || "http://localhost:3037").replace(/\/+$/, "");
                        var body = JSON.stringify({
                            generated_at: new Date().toISOString(),
                            session: scope.sessionId,
                            key: data.key,
                            counts: data.counts,
                            last_error: data.last_error || null
                        }, null, 2);
                        fetch(bridge + "/api/save", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                root: "status",
                                path: file,
                                content: body,
                                overwrite: true,
                                ensureDirs: true
                            })
                        }).then(function (r) {
                            if (!r || !r.ok) throw new Error("save failed");
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "요약 저장: " + file;
                        }).catch(function (e) {
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "요약 저장 실패: " + (e && e.message ? e.message : String(e));
                        });
                    });
                    // Evidence shortcut: copy current Runtime Summary text
                    var btnCopySummary = document.getElementById("btn-copy-rt-summary");
                    if (btnCopySummary) btnCopySummary.addEventListener("click", function () {
                        try { markSticky(btnCopySummary); } catch(_){}
                        var el = document.getElementById("rt-summary-body");
                        var text = (el && el.textContent) || "";
                        copy(text).then(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "요약 본문 복사됨 (" + (text.length) + " chars)";
                        }).catch(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "요약 복사 실패 — 권한/브라우저 확인";
                        });
                    });
                    // Evidence shortcut: copy path to today's runtime jsonl
                    var btnCopyRuntime = document.getElementById("btn-copy-runtime-jsonl");
                    if (btnCopyRuntime) btnCopyRuntime.addEventListener("click", function () {
                        try { markSticky(btnCopyRuntime); } catch(_){}
                        var scope = getSessionScope();
                        var dateStr = yyyymmdd(new Date());
                        var path = "evidence/ui_runtime_" + dateStr + "_" + scope.sessionId + ".jsonl";
                        copy(path).then(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "경로 복사됨: " + path;
                        }).catch(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "경로 복사 실패(runtime.jsonl)";
                        });
                    });
                    // Evidence shortcut: copy path to today's tab p95 json
                    var btnCopyP95 = document.getElementById("btn-copy-tab-p95");
                    if (btnCopyP95) btnCopyP95.addEventListener("click", function () {
                        try { markSticky(btnCopyP95); } catch(_){}
                        var scope = getSessionScope();
                        var dateStr = yyyymmdd(new Date());
                        var path = "evidence/ui_tab_nav_p95_" + dateStr + "_" + scope.sessionId + ".json";
                        copy(path).then(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "경로 복사됨: " + path;
                        }).catch(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "경로 복사 실패(tab p95)";
                        });
                    });
                    // Evidence shortcut: open today's runtime jsonl via bridge
                    var btnOpenRuntime = document.getElementById("btn-open-runtime-jsonl");
                    if (btnOpenRuntime) btnOpenRuntime.addEventListener("click", function () {
                        try { markSticky(btnOpenRuntime); } catch(_){}
                        var scope = getSessionScope();
                        var dateStr = yyyymmdd(new Date());
                        var path = "evidence/ui_runtime_" + dateStr + "_" + scope.sessionId + ".jsonl";
                        var bridge = ((document.getElementById("bridge-url") && document.getElementById("bridge-url").value) || localStorage.getItem("gg_bridge_url") || "http://localhost:3037").replace(/\/+$/, "");
                        fetch(bridge + "/api/open", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ root: "status", path: path })
                        }).then(function (r) {
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = (r && r.ok) ? ("열기 요청: " + path) : "열기 실패(runtime.jsonl)";
                        }).catch(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "열기 실패(runtime.jsonl)";
                        });
                    });
                    // Evidence shortcut: open today's tab p95 json via bridge
                    var btnOpenP95 = document.getElementById("btn-open-tab-p95");
                    if (btnOpenP95) btnOpenP95.addEventListener("click", function () {
                        try { markSticky(btnOpenP95); } catch(_){}
                        var scope = getSessionScope();
                        var dateStr = yyyymmdd(new Date());
                        var path = "evidence/ui_tab_nav_p95_" + dateStr + "_" + scope.sessionId + ".json";
                        var bridge = ((document.getElementById("bridge-url") && document.getElementById("bridge-url").value) || localStorage.getItem("gg_bridge_url") || "http://localhost:3037").replace(/\/+$/, "");
                        fetch(bridge + "/api/open", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ root: "status", path: path })
                        }).then(function (r) {
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = (r && r.ok) ? ("열기 요청: " + path) : "열기 실패(tab p95)";
                        }).catch(function(){
                            var s = document.getElementById("ops-status");
                            if (s) s.textContent = "열기 실패(tab p95)";
                        });
                    });
                    // A4: Recent open dropdown (today's evidence)
                    try {
                        var group = document.getElementById("a4-shortcuts");
                        if (group) {
                            var sel = document.getElementById("sel-open-recent");
                            if (!sel) {
                                sel = document.createElement("select");
                                sel.id = "sel-open-recent";
                                sel.className = "mono";
                                sel.title = "오늘 Evidence 선택";
                                sel.style.minWidth = "240px";
                                sel.style.padding = "6px 8px";
                                sel.style.border = "1px solid var(--border)";
                                sel.style.borderRadius = "8px";
                                sel.style.background = "var(--panel)";
                                sel.style.color = "var(--fg)";
                                group.appendChild(sel);
                                var btnRecent = document.getElementById("btn-open-recent");
                                if (!btnRecent) {
                                    btnRecent = document.createElement("button");
                                    btnRecent.id = "btn-open-recent";
                                    btnRecent.type = "button";
                                    btnRecent.className = "btn";
                                    btnRecent.title = "선택 파일 열기";
                                    btnRecent.textContent = "최근 열기";
                                    group.appendChild(btnRecent);
                                }
                                btnRecent.addEventListener("click", function(){
                                    var val = sel && sel.value;
                                    if (!val) return;
                                    var bridge = ((document.getElementById("bridge-url") && document.getElementById("bridge-url").value) || localStorage.getItem("gg_bridge_url") || "http://localhost:3037").replace(/\/+$/, "");
                                    fetch(bridge + "/api/open", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({ root: "status", path: val })
                                    }).then(function (r) {
                                        var s = document.getElementById("ops-status");
                                        if (s) s.textContent = (r && r.ok) ? ("열기 요청: " + val) : "열기 실패(최근 열기)";
                                    }).catch(function(){
                                        var s = document.getElementById("ops-status");
                                        if (s) s.textContent = "열기 실패(최근 열기)";
                                    });
                                });
                            }
                            // populate options with today's evidence candidates
                            (function(){
                                var scope = getSessionScope();
                                var dateStr = yyyymmdd(new Date());
                                var candidates = [
                                    { label: "runtime.jsonl", path: "evidence/ui_runtime_" + dateStr + "_" + scope.sessionId + ".jsonl" },
                                    { label: "tab p95.json", path: "evidence/ui_tab_nav_p95_" + dateStr + "_" + scope.sessionId + ".json" },
                                    { label: "runtime_summary.json", path: "evidence/ui_runtime_summary_" + dateStr + "_" + scope.sessionId + ".json" }
                                ];
                                sel.innerHTML = "";
                                for (var i = 0; i < candidates.length; i++) {
                                    var o = document.createElement("option");
                                    o.value = candidates[i].path;
                                    o.textContent = candidates[i].label + " — " + candidates[i].path;
                                    sel.appendChild(o);
                                }
                            })();
                        }
                    } catch(_) {}
                }
                // ---------- A4: Automation (tab-nav p95 and error storm) ----------
                function wireAutomationUI() {
                    var p95Btn = document.getElementById("btn-tab-p95");
                    var stormBtn = document.getElementById("btn-error-storm");
                    var out = document.getElementById("auto-out");
                    function setOut(t){ if(out) out.textContent = t; }
                    if (p95Btn) {
                        p95Btn.addEventListener("click", function () {
                            setOut("측정 시작: 탭 전환 100회…");
                            measureTabNavP95(100).then(function (res) {
                                setOut("p95: " + res.p95_ms + " ms (n=" + res.count + ")\n파일: " + res.path);
                                var s = document.getElementById("ops-status");
                                if (s) s.textContent = "p95 저장: " + res.path;
                            }).catch(function (e) {
                                setOut("측정 실패: " + (e && e.message ? e.message : String(e)));
                            });
                        });
                    }
                    if (stormBtn) {
                        stormBtn.addEventListener("click", function () {
                            setOut("에러 스톰 시작(약 2초)…");
                            triggerErrorStorm(50, 40).then(function () {
                                setOut("에러 스톰 완료 — A4 요약 새로고침으로 반영 확인");
                            });
                        });
                    }
                }
                function measureTabNavP95(runs) {
                    runs = Math.max(10, Math.floor(Number(runs) || 100));
                    return new Promise(function (resolve) {
                        var lats = [];
                        for (var i = 0; i < runs; i++) {
                            var tgt = ORDER[i % ORDER.length];
                            var t0 = (performance && performance.now) ? performance.now() : Date.now();
                            activate(tgt);
                            var t1 = (performance && performance.now) ? performance.now() : Date.now();
                            lats.push(Math.max(0, t1 - t0));
                        }
                        var arr = lats.slice().sort(function (a, b) { return a - b; });
                        var idx = Math.max(0, Math.min(arr.length - 1, Math.ceil(arr.length * 0.95) - 1));
                        var p95 = Math.round(arr[idx]);
                        // Save evidence
                        var scope = getSessionScope();
                        var d = new Date();
                        var file = "evidence/ui_tab_nav_p95_" + ("" + d.getFullYear() + String(d.getMonth() + 1).padStart(2, "0") + String(d.getDate()).padStart(2, "0")) + "_" + scope.sessionId + ".json";
                        var bridge = ((document.getElementById("bridge-url") && document.getElementById("bridge-url").value) || localStorage.getItem("gg_bridge_url") || "http://localhost:3037").replace(/\/+$/, "");
                        var body = JSON.stringify({ generated_at: new Date().toISOString(), session: scope.sessionId, count: arr.length, p95_ms: p95, min_ms: Math.round(arr[0]), max_ms: Math.round(arr[arr.length - 1]), latencies_ms: lats }, null, 2);
                        fetch(bridge + "/api/save", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ root: "status", path: file, content: body, overwrite: true, ensureDirs: true })
                        }).then(function(){ resolve({ p95_ms: p95, count: arr.length, path: file }); })
                          .catch(function(){ resolve({ p95_ms: p95, count: arr.length, path: file }); });
                    });
                }
                function triggerErrorStorm(errors, warns) {
                    errors = Math.max(1, Math.floor(Number(errors) || 50));
                    warns = Math.max(1, Math.floor(Number(warns) || 40));
                    return new Promise(function (resolve) {
                        var i = 0, j = 0;
                        function tick() {
                            if (i < errors) {
                                setTimeout(function(){ try { throw new Error("storm:error#" + i); } catch(e) { console.error(e.message); } }, 0);
                                i++;
                                setTimeout(tick, 10);
                                return;
                            }
                            if (j < warns) {
                                console.warn("storm:warn#" + j);
                                j++;
                                setTimeout(tick, 10);
                                return;
                            }
                            resolve();
                        }
                        // Add some unhandled rejections too
                        setTimeout(function(){ Promise.reject(new Error("storm:unhandled")); }, 0);
                        tick();
                    });
                }
                function wireOpsLog() {
                    var opsInput = $("#ops-input");
                    var opsBtn = $("#btn-ops-log");
                    var opsStatus = $("#ops-status");
                    if (!opsBtn) return;

                    opsBtn.addEventListener("click", function () {
                        var txt = ((opsInput && opsInput.value) || "").trim();
                        if (!txt) {
                            if (opsStatus)
                                opsStatus.textContent =
                                    "빈 로그는 기록하지 않습니다.";
                            return;
                        }

                        var bridge = (
                            $("#bridge-url").value || "http://localhost:3037"
                        ).replace(/\/+$/, "");
                        var scope = getSessionScope();
                        var convId =
                            (
                                localStorage.getItem("gg_last_conv") || ""
                            ).trim() || null;
                        var msg = "[ops] " + txt;
                        var msgs = historyMsgs.concat([
                            { role: "user", content: msg },
                        ]);

                        fetch(bridge + "/api/chat", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                messages: msgs,
                                sessionId: scope.sessionId,
                                taskId: scope.taskId,
                                convId: convId || undefined,
                                model:
                                    localStorage.getItem("gg_openai_model") ||
                                    undefined,
                            }),
                        })
                            .then(function (r) {
                                return r.json().catch(function () {
                                    return {
                                        ok: false,
                                        error: { message: "Invalid JSON" },
                                    };
                                });
                            })
                            .then(function (resp) {
                                if (!resp || !resp.ok) {
                                    if (opsStatus)
                                        opsStatus.textContent =
                                            "기록 실패: " +
                                            (resp &&
                                            resp.error &&
                                            resp.error.message
                                                ? resp.error.message
                                                : "요청 실패");
                                    return;
                                }
                                var newConv =
                                    (resp.data && resp.data.convId) || convId;
                                if (newConv) {
                                    try {
                                        localStorage.setItem(
                                            "gg_last_conv",
                                            newConv,
                                        );
                                    } catch (_) {}
                                    var convEl = $("#conv-badge");
                                    if (convEl)
                                        convEl.textContent = "conv: " + newConv;
                                }
                                // A1 -> A3: evaluate utilization with real usage if available (ops-log response)
                                try {
                                  if (
                                      window.A3 &&
                                      typeof window.A3.evaluateUtilization ===
                                          "function"
                                  )
                                      window.A3.evaluateUtilization(
                                          resp.data && resp.data.usage,
                                      );
                                  try { applyWarningState(); } catch (_) {}
                                } catch (_) {}
                                // Store upstream/request_id/cache ratio for A4 and refresh badges
                                try {
                                  var rid = resp && resp.data && resp.data.request_id;
                                  var upm = resp && resp.data && resp.data.upstream_model;
                                  if (rid) localStorage.setItem("gg_last_request_id", rid);
                                  if (upm) localStorage.setItem("gg_last_upstream_model", upm);
                                  var u = resp && resp.data && resp.data.usage;
                                  var pt = u && Number(u.prompt_tokens || 0);
                                  var ctok = u && u.prompt_tokens_details && Number(u.prompt_tokens_details.cached_tokens || 0);
                                  if (Number.isFinite(pt) && Number.isFinite(ctok) && pt > 0) {
                                    var ratio = (ctok / pt).toFixed(3);
                                    localStorage.setItem("gg_last_cache_ratio", String(ratio));
                                  }
                                  try { if (typeof syncA4Meta === "function") syncA4Meta(); } catch (_){}
                                } catch (_){}
                                if (opsStatus) opsStatus.textContent = "기록 완료";
                                if (opsStatus)
                                    opsStatus.textContent = "기록 완료";
                            })
                            .catch(function (e) {
                                if (opsStatus)
                                    opsStatus.textContent =
                                        "네트워크 오류: " +
                                        (e && e.message
                                            ? e.message
                                            : String(e));
                            });
                    });
                }

                // ---------- Init ----------
                onReady(function () {
                    // Timestamp
                    var ts = $("#ts");
                    if (ts) {
                        var now = new Date();
                        var kstText;
                        try {
                            kstText = new Intl.DateTimeFormat("ko-KR", {
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit",
                                hour: "2-digit",
                                minute: "2-digit",
                                second: "2-digit",
                                hour12: false,
                                timeZone: "Asia/Seoul",
                            })
                                .format(now)
                                .replace(/\./g, "-")
                                .replace(/\s+/g, " ")
                                .replace(/- /g, "-")
                                .trim();
                        } catch (_) {
                            var ms =
                                now.getTime() + now.getTimezoneOffset() * 60000;
                            var k = new Date(ms + 9 * 3600000);
                            var pad = function (n) {
                                return String(n).padStart(2, "0");
                            };
                            kstText =
                                k.getFullYear() +
                                "-" +
                                pad(k.getMonth() + 1) +
                                "-" +
                                pad(k.getDate()) +
                                " " +
                                pad(k.getHours()) +
                                ":" +
                                pad(k.getMinutes()) +
                                ":" +
                                pad(k.getSeconds());
                        }
                        ts.textContent =
                            "Rendered at: " +
                            kstText +
                            " KST | UTC: " +
                            now.toISOString();
                    }

                    // Theme + buttons (Auto-seed Strict Grounded Mode defaults once per profile)
                                        (function(){
                                            var SEED_VER = "SGM_v1";
                                            try {
                                                var cur = localStorage.getItem("gg_config_version") || "";
                                                if (cur !== SEED_VER) {
                                                    localStorage.setItem("gg_recall_prompt_on","true");
                                                    localStorage.setItem("gg_recall_prompt_style","system");
                                                    localStorage.setItem("gg_recall_prompt_max_refs","3");
                                                    localStorage.setItem("gg_recall_inject_wait_ms","2000");
                                                    localStorage.setItem("gg_strict_grounded_mode","on");
                                                    localStorage.setItem("gg_config_version", SEED_VER);
                                                }
                                            } catch (_){}
                                        })();
                                        applyTheme();
                                        try { applyWarningState(); } catch(_) {}
                                        window.addEventListener("gg:warn", function(){ try { applyWarningState(); } catch(_) {} });
                                        // Show Strict badge with current settings
                                        try {
                                            var b = document.getElementById("gg-strict-badge");
                                            if (b) {
                                                var on = (localStorage.getItem("gg_strict_grounded_mode")||"on") !== "off";
                                                var wait = localStorage.getItem("gg_recall_inject_wait_ms") || "2000";
                                                var style = localStorage.getItem("gg_recall_prompt_style") || "system";
                                                b.textContent = on ? ("엄격 사실 기반 모드 ON · wait="+wait+"ms · style="+style) : "Strict OFF";
                                            }
                                        } catch(_){}
                    var themeBtn = $("#btn-theme");
                    var helpBtn = $("#btn-help");
                    if (themeBtn)
                        themeBtn.addEventListener("click", toggleTheme);
                    if (helpBtn) helpBtn.addEventListener("click", toggleHelp);

                    // Session meta + A2 wiring
                    renderSessionMeta();
                    var a2Session = $("#a2-session-id");
                    var a2Task = $("#a2-task-id");
                    var btnScope = $("#btn-save-scope");
                    var scope = getSessionScope();
                    if (a2Session) a2Session.value = scope.sessionId;
                    if (a2Task) a2Task.value = scope.taskId;
                    if (btnScope)
                        btnScope.addEventListener("click", function () {
                            var s =
                                ((a2Session && a2Session.value) || "").trim() ||
                                "GG-SESS-LOCAL";
                            var t =
                                ((a2Task && a2Task.value) || "").trim() ||
                                "TASK-ROOT";
                            try {
                                localStorage.setItem("gg_session_id", s);
                                localStorage.setItem("gg_task_id", t);
                                setStatus("세션/태스크 저장: " + s + " / " + t);
                            } catch (_) {}
                        });

                    // Bridge config input
                    var inUrl = $("#bridge-url");
                    if (inUrl) {
                        inUrl.value =
                            localStorage.getItem("gg_bridge_url") ||
                            "http://localhost:3037";
                        inUrl.addEventListener("change", function () {
                            localStorage.setItem(
                                "gg_bridge_url",
                                inUrl.value.trim(),
                            );
                            checkBridgeHealth();
                        });
                    }
                    checkBridgeHealth();

                    // Chat send handlers
                    var btnSend = $("#btn-send");
                    var btnAnchor = $("#btn-anchor");
                    var ta = $("#chat-input");
                    if (btnSend) btnSend.addEventListener("click", sendChat);
                    if (btnAnchor) btnAnchor.addEventListener("click", function(){
                        var text = (ta && ta.value || "").trim();
                        if (!text) { try { (window.ggToast||alert)("입력된 내용이 없습니다"); } catch(_){} return; }
                        var scope = getSessionScope();
                        var safe = window.__GG_SAFE_MODE__ ? "SAFE" : "NORMAL";
                        var el = document.getElementById("anchor-result");
                        if (el) { el.style.display = "block"; el.textContent = "앵커링 요청 중이에요…"; }
                        fetch("http://127.0.0.1:8000/api/memory/anchor", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ speech: text, k: 3, maxCards: 5, sessionId: scope.sessionId, mode: safe })
                        }).then(function(r){ return r.json().catch(function(){ return null; }); })
                        .then(function(j){
                            if (!el) return;
                            if (!j || !j.ok) { el.textContent = "앵커링 실패"; return; }
                            var d = j.data || {};
                            function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;"); }
                            var html = "";
                            html += "<div style='margin-bottom:6px; color:#94a3b8'>speech: "+esc(d.speech)+"</div>";
                            var cards = d.cards||[];
                            if (cards.length){
                                html += "<div><b>최근 카드</b></div>";
                                for (var i=0;i<cards.length;i++){
                                    var c = cards[i]||{};
                                    html += "<div style='margin:4px 0; padding:4px 6px; border-left:3px solid var(--border)'>";
                                    html += "<div class='mono' style='font-size:12px; color:#94a3b8'>"+esc(c.utc_ts)+" • "+esc(c.scope)+" • "+esc(c.run_id)+"</div>";
                                    html += "<div>"+esc(c.decision||'')+"</div>";
                                    if (c.next_step) html += "<div style='opacity:.8'>→ "+esc(c.next_step)+"</div>";
                                    if (c.evidence) html += "<div class='mono' style='font-size:12px; opacity:.8'>"+esc(c.evidence)+"</div>";
                                    html += "</div>";
                                }
                            } else {
                                html += "<div>최근 카드 없음</div>";
                            }
                            var evs = d.evidence||[];
                            if (evs.length){
                                html += "<div style='margin-top:8px'><b>근거</b></div>";
                                for (var k=0;k<evs.length;k++){
                                    var e = evs[k]||{};
                                    html += "<div style='margin:4px 0; padding:4px 6px; border-left:3px solid var(--border)'>";
                                    html += "<div class='mono' style='font-size:12px; color:#94a3b8'>"+esc(e.tier)+" • score="+esc(e.score)+" • "+esc(e.ts||'')+"</div>";
                                    html += "<div>"+esc(e.text||'')+"</div>";
                                    if (e.path) html += "<div class='mono' style='font-size:12px; opacity:.8'>"+esc(e.path)+"#L"+esc(e.line_from||'?')+"-"+esc(e.line_to||'?')+"</div>";
                                    html += "</div>";
                                }
                            } else {
                                html += "<div style='margin-top:8px'>근거 없음</div>";
                            }
                            // Meeting snapshot (events tail + record status) when implied by speech
                            var m = d.meeting || null;
                            if (m) {
                                html += "<div id='meeting-snapshot' style='margin-top:8px'><b>회의 스냅샷</b></div>";
                                var rs = (m.record_status)||{};
                                html += "<div id='meeting-status-line' class='mono' style='font-size:12px; color:#94a3b8'>state="+esc(rs.state||'OFF')+" • started="+esc(rs.started_at||'-')+" • stopped="+esc(rs.stopped_at||'-')+" • dur="+esc(String(rs.duration_sec||0))+"s</div>";
                                if (m.events && m.events.length) {
                                    html += "<div class='mono' style='font-size:12px; opacity:.8'>"+esc(m.events_path||'')+"</div>";
                                    for (var i2=0;i2<m.events.length;i2++) {
                                        var ev = m.events[i2]||{};
                                        html += "<div style='margin:4px 0; padding:4px 6px; border-left:3px solid var(--border)'>";
                                        html += "<div class='mono' style='font-size:12px; color:#94a3b8'>"+esc(ev.ts||'')+" • "+esc(ev.type||'')+"</div>";
                                        if (ev.note) html += "<div>"+esc(ev.note)+"</div>";
                                        if (ev.attachment) html += "<div class='mono' style='font-size:12px; opacity:.8'>(첨부) "+esc(ev.attachment)+"</div>";
                                        html += "</div>";
                                    }
                                } else {
                                    html += "<div style='opacity:.8'>회의 이벤트 없음</div>";
                                }
                                // controls
                                html += "<div style='margin-top:6px; display:flex; gap:8px; flex-wrap:wrap'>";
                                html += "<button id='btn-open-meet-events' class='btn' type='button'>회의 이벤트 열기</button>";
                                html += "<button id='btn-refresh-record-status' class='btn' type='button'>녹화 상태 새로고침</button>";
                                html += "</div>";
                            }
                            if (d.evidence_path) {
                                html += "<div style='margin-top:8px'><button class='btn' type='button' id='btn-open-anchor-evidence'>증거 열기</button> <span class='mono' style='font-size:12px;opacity:.7'>"+esc(d.evidence_path)+"</span></div>";
                            }
                            el.innerHTML = html;
                            var openBtn = document.getElementById("btn-open-anchor-evidence");
                            if (openBtn && d.evidence_path && window.ggOpenAttachment) {
                                openBtn.addEventListener("click", function(){
                                    var p = String(d.evidence_path);
                                    if (/^status\//.test(p)) p = p.slice(7);
                                    window.ggOpenAttachment(p);
                                });
                            }
                            // Meeting events open
                            var openMeetBtn = document.getElementById("btn-open-meet-events");
                            if (openMeetBtn && d.meeting && d.meeting.events_path && window.ggOpenAttachment) {
                                openMeetBtn.addEventListener("click", function(){
                                    var p = String(d.meeting.events_path || "");
                                    if (/^status\//.test(p)) p = p.slice(7);
                                    window.ggOpenAttachment(p);
                                });
                            }
                            // Refresh record status
                            var refreshBtn = document.getElementById("btn-refresh-record-status");
                            if (refreshBtn) {
                                refreshBtn.addEventListener("click", function(){
                                    try {
                                        var sid = String(d.session_id || "GG-SESS-LOCAL");
                                        var url = "http://127.0.0.1:8000/api/meetings/" + encodeURIComponent(sid) + "/record/status";
                                        fetch(url).then(function(r){ if(!r.ok) throw new Error("bad"); return r.json(); }).then(function(j){
                                            var data = j && j.data || {};
                                            var line = document.getElementById("meeting-status-line");
                                            if (!line) return;
                                            var dur = Number(data.duration_sec||0);
                                            line.textContent = "state=" + (data.state||"OFF") + " • started=" + (data.started_at||"-") + " • stopped=" + (data.stopped_at||"-") + " • dur=" + String(dur) + "s";
                                        }).catch(function(){
                                            var line = document.getElementById("meeting-status-line");
                                            if (line) line.textContent = "상태 갱신 실패";
                                        });
                                    } catch (_) {}
                                });
                            }
                        }).catch(function(){
                            if (el) el.textContent = "앵커링 오류";
                        });
                    });
                    if (ta)
                        ta.addEventListener("keydown", function (e) {
                            if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
                                e.preventDefault();
                                sendChat();
                            }
                        });

                    // Tokenizer
                    if (!window.__GG_SAFE_MODE__) {
                        (function waitTokenizer(startTs){
                            if (window.GGTokenizer) {
                                try { bootTokenizer(); } catch (_){}
                                return;
                            }
                            var now = Date.now();
                            if (!startTs) startTs = now;
                            if (now - startTs > 15000) { try { setStatus("Tokenizer not ready (timeout)"); } catch(_){} return; }
                            setTimeout(function(){ waitTokenizer(startTs); }, 150);
                        })();
                    } else {
                        setStatus("SAFE_MODE: tokenizer disabled");
                    }

                    // Ops log
                    wireOpsLog();

                    // Default hash + activation
                    if (!location.hash || !VALID[location.hash]) {
                        try {
                            history.replaceState(null, "", DEFAULT_HASH);
                        } catch (_) {
                            location.hash = DEFAULT_HASH;
                        }
                    }
                    activate();

                    // Listeners
                    window.addEventListener("hashchange", function () {
                        activate();
                    });
                    window.addEventListener("keydown", function (e) {
                        if (isEditableTarget(e.target)) return;
                        // Help
                        if (e.key === "?" || (e.shiftKey && e.key === "/")) {
                            e.preventDefault();
                            toggleHelp();
                            return;
                        }
                        // Theme toggle
                        if (e.key === "t" || e.key === "T") {
                            e.preventDefault();
                            toggleTheme();
                            return;
                        }
                        // Quick reload (when layout breaks, keyboard first)
                        if (e.key === "r" || e.key === "R") {
                            e.preventDefault();
                            try { location.reload(); } catch (_) {}
                            return;
                        }
                        // Hard repaint (Ctrl+Shift+R): try to recover without full reload
                        if (e.ctrlKey && e.shiftKey && (e.key === "R" || e.key === "r")) {
                            e.preventDefault();
                            try {
                                var b = document.body;
                                b.style.willChange = "transform";
                                void b.offsetHeight;
                                b.style.transform = "translateZ(0)";
                                setTimeout(function(){ try { b.style.transform=""; b.style.willChange="auto"; } catch(_){ } }, 120);
                            } catch(_){}
                            return;
                        }
                        // Low-FX toggle (Ctrl+Shift+L)
                        if (e.ctrlKey && e.shiftKey && (e.key === "L" || e.key === "l")) {
                            e.preventDefault();
                            try {
                                var isOn = ((localStorage.getItem("gg_lowfx") || "0") === "1");
                                localStorage.setItem("gg_lowfx", isOn ? "0" : "1");
                                document.body.classList.toggle("lowfx", !isOn);
                            } catch(_){}
                            return;
                        }
                        // Tab direct selection
                        if (/^[1-4]$/.test(e.key)) {
                            e.preventDefault();
                            __gg_last_nav_key_ts = (typeof performance !== "undefined" && performance.now) ? performance.now() : 0;
                            gotoIndex(parseInt(e.key, 10) - 1);
                            return;
                        }
                        // Tab prev/next
                        if (
                            e.ctrlKey &&
                            (e.key === "ArrowLeft" || e.key === "ArrowRight")
                        ) {
                            e.preventDefault();
                            var cur = ORDER.indexOf(
                                VALID[location.hash]
                                    ? location.hash
                                    : DEFAULT_HASH,
                            );
                            __gg_last_nav_key_ts = (typeof performance !== "undefined" && performance.now) ? performance.now() : 0;
                            gotoIndex(cur + (e.key === "ArrowRight" ? 1 : -1));
                            return;
                        }
                        // Close help
                        if (e.key === "Escape" && help && help.open) {
                            e.preventDefault();
                            help.close();
                        }
                    });
                });
            })();
        </script>
        <script>(function(){'use strict';var q=new URLSearchParams(location.search),SAFE=(q.get('safe')||'').trim();SAFE=SAFE==='1'||SAFE.toLowerCase()==='true'||(function(){try{return localStorage.getItem('gg_safe_mode')==='1'}catch(_){return false}})();try{window.__GG_SAFE_MODE__=SAFE}catch(_){}
function B(){var e=document.getElementById('bridge-url'),v=(e&&e.value)||localStorage.getItem('gg_bridge_url')||'http://localhost:3037';return v.replace(/\/+$/,'')}
function T(){return new Date().toISOString()}
function D(d){return''+d.getFullYear()+('0'+(d.getMonth()+1)).slice(-2)+('0'+d.getDate()).slice(-2)}
function S(){try{return (localStorage.getItem('gg_session_id')||'GG-SESS-LOCAL').trim()}catch(_){return 'GG-SESS-LOCAL'}}
var buf=[],tid=null,hdr='';try{hdr=JSON.stringify({type:'boot',ts:T(),ua:navigator.userAgent,safe_mode:SAFE})+'\n'}catch(_){}
function en(o){try{buf.push(JSON.stringify(o));if(!tid)tid=setTimeout(fl,800)}catch(_){}}
function fl(){tid=null;if(!buf.length)return;var d=new Date(),k='gg_ui_runtime_jsonl_'+D(d)+'_'+S(),name='evidence/ui_runtime_'+D(d)+'_'+S()+'.jsonl';var prev='';try{prev=localStorage.getItem(k)||''}catch(_){ }var base=prev&&prev.length?prev:hdr;var body=base+buf.join('\n')+(buf.length?'\n':'');buf.length=0;fetch(B()+'/api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:name,content:body,overwrite:true,ensureDirs:true})}).catch(function(){});try{localStorage.setItem(k,body)}catch(_){}}
document.addEventListener('DOMContentLoaded',function(){try{document.body.setAttribute('data-safe',SAFE?'1':'0')}catch(_){ }if(SAFE){var n=document.getElementById('diag');if(n)n.textContent=(n.textContent+' • SAFE_MODE ON').trim()}try{var bb=document.getElementById('backend-badge');if(bb){bb.textContent='backend: …';fetch('http://127.0.0.1:8000/api/health').then(function(r){if(!r.ok)throw new Error('bad');return r.json()}).then(function(){bb.textContent='backend: OK';bb.style.color='#22c55e';}).catch(function(){bb.textContent='backend: OFF';bb.style.color='#ef4444';(window.ggToast||alert)('백엔드 연결 실패');});}}catch(_){ }try{window.ggA5Status=function(m,k){var el=document.getElementById('a5-banner');if(!el)return;el.textContent=m;el.style.display='block';el.className='warnbar'+(k==='ok'?'':' warn');setTimeout(function(){try{el.style.display='none'}catch(_){ }},2200);};}catch(_){ }try{var a5=document.getElementById('a5');if(a5){var listId='a5-events';var list=document.getElementById(listId);if(!list){list=document.createElement('div');list.id=listId;list.className='mono';list.style.marginTop='8px';list.style.border='1px solid var(--border)';list.style.borderRadius='8px';list.style.background='var(--panel-2)';list.style.maxHeight='220px';list.style.overflow='auto';a5.appendChild(list);}var ref=document.getElementById('btn-a5-refresh');if(!ref){ref=document.createElement('button');ref.id='btn-a5-refresh';ref.type='button';ref.className='btn';ref.title='이벤트 새로고침';ref.textContent='새로고침';var openBtn=document.getElementById('btn-a5-open-events');if(openBtn&&openBtn.parentNode){openBtn.parentNode.insertBefore(ref,openBtn.nextSibling);}else{a5.insertBefore(ref,list);}ref.addEventListener('click',function(){if(window.ggA5FetchEvents)window.ggA5FetchEvents();});}var lastBtn=document.getElementById('btn-a5-open-last-attach');if(!lastBtn){lastBtn=document.createElement('button');lastBtn.id='btn-a5-open-last-attach';lastBtn.type='button';lastBtn.className='btn';lastBtn.title='최근 첨부 열기';lastBtn.textContent='최근 첨부 열기';var openBtn2=document.getElementById('btn-a5-open-events');if(openBtn2&&openBtn2.parentNode){openBtn2.parentNode.insertBefore(lastBtn,openBtn2.nextSibling);}else{a5.insertBefore(lastBtn,list);}lastBtn.addEventListener('click',function(){try{var sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';var url='http://127.0.0.1:8000/api/meetings/'+encodeURIComponent(sid)+'/events?limit=50';fetch(url).then(function(r){if(!r.ok)throw new Error('bad');return r.json()}).then(function(j){var arr=(j&&j.data&&j.data.events)||[];var att=null;for(var i=arr.length-1;i>=0;i--){if(arr[i]&&arr[i].attachment){att=String(arr[i].attachment);break;}}if(att&&window.ggOpenAttachment){window.ggOpenAttachment(att);}else{if(window.ggA5Status)ggA5Status('첨부 없음','warn');}}).catch(function(){if(window.ggA5Status)ggA5Status('열기 실패','warn');});}catch(_){}});}}}catch(_){ }try{window.ggOpenAttachment=function(p){var base=(window.ggBridgeBase?window.ggBridgeBase():'http://localhost:3037');var rel=String(p||'');if(/^status\//.test(rel)) rel=rel.slice(7);var req=(window.ggPostJSON?window.ggPostJSON(base+'/api/open',{root:'status',path:rel}):fetch(base+'/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:rel})}));req.then(function(){if(window.ggA5Status)ggA5Status('첨부 열기 요청','ok');}).catch(function(){if(window.ggA5Status)ggA5Status('첨부 열기 실패','warn');});};}catch(_){ }try{window.ggA5FetchEvents=function(){var sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';var url='http://127.0.0.1:8000/api/meetings/'+encodeURIComponent(sid)+'/events?limit=50';return fetch(url).then(function(r){if(!r.ok)throw new Error('bad');return r.json()}).then(function(j){var list=document.getElementById('a5-events');if(!list)return;var arr=(j&&j.data&&j.data.events)||[];var html='';for(var i=0;i<arr.length;i++){var ev=arr[i]||{};var t=String(ev.ts||'');var ty=String(ev.type||'');var note=ev.note||ev.text||'';var safeNote=note?('— '+String(note).replace(/</g,'&lt;')):'';var att=ev.attachment||null;if(att){var pe=String(att).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');html+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);"><span style="color:#94a3b8">'+t+'</span> • <b>'+ty+'</b> <a href="#" onclick="if(window.ggOpenAttachment)ggOpenAttachment(\''+pe+'\');return false;">(첨부)</a> '+safeNote+'</div>';}else{html+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);"><span style="color:#94a3b8">'+t+'</span> • <b>'+ty+'</b> '+safeNote+'</div>';}}if(html===''){html='<div style="padding:8px">이벤트 없음</div>';}list.innerHTML=html;if(window.ggA5Status)ggA5Status('이벤트 '+arr.length+'건','ok');return arr;}).catch(function(){if(window.ggA5Status)ggA5Status('이벤트 불러오기 실패','warn');});};}catch(_){ }try{if(window.ggA5FetchEvents)window.ggA5FetchEvents();}catch(_){ }try{window.ggSetRecordUI=function(on){var a1=document.getElementById('btn-a1-record');var a5=document.getElementById('btn-a5-record');if(a1)a1.setAttribute('aria-pressed',on?'true':'false');if(a5)a5.setAttribute('aria-pressed',on?'true':'false');var rb=document.getElementById('rec-badge');if(rb){rb.textContent='recording: '+(on?'ON':'OFF');rb.style.color=on?'#22c55e':'#94a3b8';}};window.ggSyncRecordState=function(){var sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';fetch('http://127.0.0.1:8000/api/meetings/'+encodeURIComponent(sid)+'/record/status').then(function(r){if(!r.ok)throw new Error('bad');return r.json()}).then(function(j){var on=(j&&j.data&&j.data.state)==='ON';if(window.ggSetRecordUI)window.ggSetRecordUI(on);}).catch(function(){});};var _a1=document.getElementById('btn-a1-record');if(_a1)_a1.addEventListener('click',function(){setTimeout(function(){if(window.ggSyncRecordState)window.ggSyncRecordState();},100);});var _a5=document.getElementById('btn-a5-record');if(_a5)_a5.addEventListener('click',function(){setTimeout(function(){if(window.ggSyncRecordState)window.ggSyncRecordState();},100);});if(window.ggSyncRecordState)window.ggSyncRecordState();}catch(_){ }},{once:true});
window.addEventListener('error',function(e){var er=e.error||{};en({type:'error',ts:T(),msg:e.message||String(er&&er.message||'error'),file:e.filename||null,line:e.lineno||null,col:e.colno||null,stack:er&&er.stack||null});try{if(!window.__crash__){window.__crash__=1;var line=T()+' - '+(e.message||'error')+' @ '+(e.filename||'')+':'+(e.lineno||'')+':'+(e.colno||'')+'\n';fetch(B()+'/api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({root:'status',path:'evidence/ui_crash.log',content:line,overwrite:false,ensureDirs:true})}).catch(function(){})}}catch(_){}});window.addEventListener('unhandledrejection',function(e){var r=e&&e.reason;en({type:'unhandledrejection',ts:T(),msg:String(r&&(r.message||r)||'rejection'),stack:r&&r.stack||null})});
(function(){var E=console.error,W=console.warn;console.error=function(){try{en({type:'console.error',ts:T(),args:[].map.call(arguments,function(a){return a&&a.stack?a.stack:String(a)})})}catch(_){}return E.apply(console,arguments)};console.warn=function(){try{en({type:'console.warn',ts:T(),args:[].map.call(arguments,function(a){return String(a)})})}catch(_){}return W.apply(console,arguments)}})();
setInterval(function(){try{fl()}catch(_){}} ,3000);})();</script>
<script>(function(){
  try{
    function useLocal(){ try { return (localStorage.getItem('gg_a5_tz_local')||'0')==='1'; } catch(_) { return false; } }
    function normTS(u){
      try{
        if(!u) return '';
        var s=String(u);
        var m=s.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(?:\.(\d+))?Z$/);
        if(!m) return s;
        var base=m[1], frac=(m[2]||'');
        if(frac.length>3) frac=frac.slice(0,3);
        while(frac.length<3) frac=frac+'0';
        return base+(frac?('.'+frac):'')+'Z';
      }catch(_){return String(u||'');}
    }
    function fmtTS(u){
      var s=normTS(u);
      try{
        var d=new Date(s);
        if(String(d)==='Invalid Date') return u||'';
        return useLocal()? d.toLocaleString() : u;
      }catch(_){ return u||''; }
    }
    function renderA5List(arr){
      try{
        var list=document.getElementById('a5-events'); if(!list) return;
        var html='';
        for(var i=0;i<(arr||[]).length;i++){
          var ev=arr[i]||{};
          var t=String(ev.ts||''); var ty=String(ev.type||'');
          var note=ev.note||ev.text||''; var safeNote=note?('— '+String(note).replace(/</g,'&lt;')):'';
          var att=ev.attachment||null; var dt=fmtTS(t);
          if(att){
            var pe=String(att).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
            html+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);"><span style="color:#94a3b8">'+dt+'</span> • <b>'+ty+'</b> <a href="#" onclick="if(window.ggOpenAttachment)ggOpenAttachment(\''+pe+'\');return false;">(첨부)</a> '+safeNote+'</div>';
          }else{
            html+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);"><span style="color:#94a3b8">'+dt+'</span> • <b>'+ty+'</b> '+safeNote+'</div>';
          }
        }
        if(html===''){ html='<div style="padding:8px">이벤트 없음</div>'; }
        list.innerHTML=html;
      }catch(_){}
    }
    window.renderA5List = renderA5List;
    // Enforce timezone-aware renderer even if overridden later
    try {
      if (!window.__a5_guard) {
        window.__a5_guard = setInterval(function(){
          try{
            if (typeof window.ggA5FetchEvents !== 'function' || !window.ggA5FetchEvents.toString().includes('renderA5List')) {
              if (typeof window.__a5_fetch === 'function') {
                window.ggA5FetchEvents = window.__a5_fetch;
              }
            }
          }catch(_){}
        }, 1500);
      }
    } catch(_) {}

    // Fetch + cache, then render
    window.ggA5FetchEvents = function(){
      var sid=(document.getElementById('a2-session-id')||{}).value||'GG-SESS-LOCAL';
      var url='http://127.0.0.1:8000/api/meetings/'+encodeURIComponent(sid)+'/events?limit=50';
      return fetch(url).then(function(r){ if(!r.ok) throw new Error('bad'); return r.json(); }).then(function(j){
        var arr=(j&&j.data&&j.data.events)||[];
        window.__a5_last_events = arr;
        renderA5List(arr);
        if(window.ggA5Status) ggA5Status('이벤트 '+arr.length+'건','ok');
        return arr;
      }).catch(function(){ if(window.ggA5Status) ggA5Status('이벤트 불러오기 실패','warn'); });
    };
    // Cache stable override for guard re-apply
    try { window.__a5_fetch = window.ggA5FetchEvents; } catch(_) {}

    // Initialize checkbox state and instant re-render on toggle
    document.addEventListener('DOMContentLoaded', function(){
      try{
        var chk=document.getElementById('chk-a5-tz-local');
        if(chk){
          chk.checked = useLocal();
          chk.addEventListener('change', function(){
            try{
              localStorage.setItem('gg_a5_tz_local', chk.checked ? '1':'0');
              if (window.__a5_last_events && window.renderA5List) {
                window.renderA5List(window.__a5_last_events);
              } else if (window.ggA5FetchEvents) {
                window.ggA5FetchEvents();
              }
              if(window.ggA5Status) ggA5Status(chk.checked?'로컬 시간 표시 ON':'UTC 표시 ON','ok');
            }catch(_){}
          }, {once:false});
        }
      }catch(_){}
    }, {once:true});
  }catch(_){}
})();</script>

<script>(function(){try{if(typeof window==='undefined')return;var hasTauri=!!(window.__TAURI__&&window.__TAURI__.invoke);if(!hasTauri)return;var __origFetch=window.fetch;function isEvidenceSave(input,init){try{var u=new URL(String(input),location.origin);if(!/\/api\/save$/.test(u.pathname))return false;var m=String((init&&init.method)||'POST').toUpperCase();return m==='POST'}catch(_){return false}}window.fetch=function(input,init){try{if(isEvidenceSave(input,init)){var body=init&&init.body?String(init.body):'';var payload=null;try{payload=JSON.parse(body)}catch(_){payload=null}if(payload&&payload.root&&payload.path){return window.__TAURI__.invoke('gg_save',payload).then(function(resp){return{ok:true,json:function(){return Promise.resolve({ok:true,data:resp||null})}}}).catch(function(){return __origFetch.apply(window,[input,init])})}}}catch(_){ }return __origFetch.apply(window,[input,init])};}catch(_){}})();</script>
    <script>
      (function () {
        try {
          // Repaint helpers
          function softRepaint(){
            try {
              var b = document.body;
              b.style.willChange = 'transform';
              void b.offsetHeight; // reflow
              b.style.transform = 'translateZ(0)';
              setTimeout(function(){ try { b.style.transform=''; b.style.willChange='auto'; } catch(_){ } }, 80);
            } catch(_) {}
          }
          function hardRepaint(){
            try { window.scrollBy(0,1); window.scrollBy(0,-1); } catch(_) {}
            softRepaint();
          }

          // Toolbar controls: Reload, Low-FX toggle, Repaint
          var toolbar = document.querySelector('.toolbar');
          if (toolbar) {
            // Reload
            var btn = document.createElement('button');
            btn.id = 'btn-reload';
            btn.type = 'button';
            btn.className = 'btn';
            btn.title = '새로고침 (Reload)';
            btn.textContent = '새로고침';
            btn.addEventListener('click', function () {
              try { location.reload(); } catch (_) {}
            });
            toolbar.appendChild(btn);

            // Low-FX toggle (performance-first)
            var lowBtn = document.createElement('button');
            lowBtn.id = 'btn-lowfx';
            lowBtn.type = 'button';
            lowBtn.className = 'btn';
            lowBtn.title = '저사양 모드(렌더 효과 최소화)';
            var lowOn = ((localStorage.getItem('gg_lowfx')||'0') === '1');
            function syncLowFxUI(){
              try {
                document.body.classList.toggle('lowfx', lowOn);
                lowBtn.textContent = lowOn ? '저사양 ON' : '저사양';
                lowBtn.setAttribute('aria-pressed', lowOn ? 'true' : 'false');
              } catch(_){}
            }
            lowBtn.addEventListener('click', function(){
              lowOn = !lowOn;
              try { localStorage.setItem('gg_lowfx', lowOn ? '1' : '0'); } catch(_){}
              syncLowFxUI();
              softRepaint();
            });
            toolbar.appendChild(lowBtn);
            syncLowFxUI();

            // Manual repaint
            var rpBtn = document.createElement('button');
            rpBtn.id = 'btn-repaint';
            rpBtn.type = 'button';
            rpBtn.className = 'btn';
            rpBtn.title = '화면 복구 (강제 Repaint)';
            rpBtn.textContent = '화면복구';
            rpBtn.addEventListener('click', function(){ hardRepaint(); });
            toolbar.appendChild(rpBtn);

            // Auto-recover toggle (reload after resize end)
            var arBtn = document.createElement('button');
            arBtn.id = 'btn-autorc';
            arBtn.type = 'button';
            arBtn.className = 'btn';
            arBtn.title = '리사이즈 종료 후 자동 복구(재로딩)';
            function getAutoRc(){ try { return ((localStorage.getItem('gg_auto_reload_on_resize')||'1')==='1'); } catch(_){ return true; } }
            function setAutoRc(v){ try { localStorage.setItem('gg_auto_reload_on_resize', v ? '1' : '0'); } catch(_){ } }
            function syncArUI(){
              var on = getAutoRc();
              arBtn.textContent = on ? '자동복구 ON' : '자동복구';
              arBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
            }
            arBtn.addEventListener('click', function(){ setAutoRc(!getAutoRc()); syncArUI(); });
            toolbar.appendChild(arBtn);
            syncArUI();

            // Overlay profile switcher
            (function(){
              try {
                var tb = toolbar;
                if (tb) {
                  var sel = document.createElement('select');
                  sel.id = 'overlay-profile';
                  sel.title = '오버레이 프로필 선택';
                  sel.style.marginLeft = '8px';
                  sel.style.minWidth = '160px';
                  sel.style.padding = '4px 6px';
                  sel.style.border = '1px solid var(--border)';
                  sel.style.borderRadius = '6px';
                  sel.style.background = 'var(--panel)';
                  sel.style.color = 'var(--fg)';
                  var opts = [
                    {label:'Overlay 없음', value:''},
                    {label:'active.css', value:'/ui/overlays/active.css'},
                    {label:'labs/default.css', value:'/ui/overlays/labs/default.css'}
                  ];
                  for (var i=0;i<opts.length;i++){
                    var o = document.createElement('option');
                    o.value = opts[i].value;
                    o.textContent = opts[i].label;
                    sel.appendChild(o);
                  }
                  var btn = document.createElement('button');
                  btn.id = 'btn-overlay-apply';
                  btn.className = 'btn';
                  btn.type = 'button';
                  btn.title = '선택한 오버레이 적용';
                  btn.textContent = '오버레이 적용';
                  btn.addEventListener('click', function(){
                    try {
                      var v = sel.value;
                      var url = new URL(window.location.href);
                      if (v) url.searchParams.set('overlay', v);
                      else url.searchParams.delete('overlay');
                      window.location.href = url.toString();
                    } catch(_) {}
                  });
                  tb.appendChild(sel);
                  tb.appendChild(btn);
                }
              } catch(_) {}
            })();

            // Bridge Health chip and Route Check button
            (function(){
              try {
                var tb = toolbar;
                if (tb) {
                  // Health status chip
                  var chip = document.createElement('span');
                  chip.id = 'bridge-health';
                  chip.className = 'label';
                  chip.title = '브리지 상태';
                  chip.textContent = 'Bridge: ?';
                  chip.style.padding = '2px 6px';
                  chip.style.border = '1px solid var(--border)';
                  chip.style.borderRadius = '8px';
                  chip.style.marginLeft = '8px';
                  tb.appendChild(chip);

                  // Route check button (saves JSON evidence)
                  var hb = document.createElement('button');
                  hb.id = 'btn-health-check';
                  hb.type = 'button';
                  hb.className = 'btn';
                  hb.title = '브리지 라우트 점검 및 Evidence 저장';
                  hb.textContent = '점검';
                  hb.addEventListener('click', function(){
                    var bridge = ((document.getElementById('bridge-url') && document.getElementById('bridge-url').value) || localStorage.getItem('gg_bridge_url') || 'http://localhost:3037').replace(/\/+$/,'');
                    var scope = (function(){ try{ return (localStorage.getItem('gg_session_id')||'GG-SESS-LOCAL').trim(); }catch(_){ return 'GG-SESS-LOCAL'; }})();
                    var d=new Date(); var dateStr=(''+d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0'));
                    var file='evidence/health_check_'+dateStr+'_'+scope+'.json';
                    fetch(bridge+'/api/health',{method:'GET'}).then(function(r){ return r.json(); }).then(function(j){
                      return fetch(bridge+'/api/save',{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({root:'status',path:file,content:JSON.stringify(j,null,2),overwrite:true,ensureDirs:true})
                      });
                    }).then(function(r){
                      if (r && r.ok) {
                        chip.textContent='Bridge: OK';
                        var s=document.getElementById('ops-status'); if(s) s.textContent='Health 저장: '+file;
                      } else {
                        chip.textContent='Bridge: ERR';
                        var s=document.getElementById('ops-status'); if(s) s.textContent='Health 저장 실패';
                      }
                    }).catch(function(){
                      chip.textContent='Bridge: ERR';
                      var s=document.getElementById('ops-status'); if(s) s.textContent='Health 요청 실패';
                    });
                  });
                  tb.appendChild(hb);

                  // Auto ping once on load to set chip quickly
                  (function(){
                    var bridge = ((document.getElementById('bridge-url') && document.getElementById('bridge-url').value) || localStorage.getItem('gg_bridge_url') || 'http://localhost:3037').replace(/\/+$/,'');
                    fetch(bridge+'/api/health',{method:'GET'})
                      .then(function(r){ chip.textContent = r && r.ok ? 'Bridge: OK' : 'Bridge: ERR'; })
                      .catch(function(){ chip.textContent='Bridge: ERR'; });
                  })();
                }
              } catch(_) {}
            })();
            // Hotkeys help button (dispatch Ctrl+Alt+M)
            try {
              var hkBtn = document.createElement('button');
              hkBtn.id = 'btn-hotkeys';
              hkBtn.className = 'btn';
              hkBtn.type = 'button';
              hkBtn.title = '단축키 도움말 (Ctrl+Alt+M)';
              hkBtn.textContent = '단축키';
              hkBtn.addEventListener('click', function(){
                try {
                  var ev = new KeyboardEvent('keydown', { key: 'm', ctrlKey: true, altKey: true, bubbles: true });
                  window.dispatchEvent(ev);
                  var s = document.getElementById('ops-status');
                  if (s) s.textContent = '단축키 도움말 표시 요청';
                } catch(_){}
              });
              toolbar.appendChild(hkBtn);
            } catch(_){}

            // Meeting Quick Panel (β) toggle + shortcut (Ctrl+Alt+H)
            try {
              function toggleMeetingDrawer() {
                try {
                  var d = document.getElementById('a1-meeting-drawer');
                  if (!d) return;
                  var show = (d.style.display || 'none') === 'none';
                  d.style.display = show ? 'block' : 'none';
                  var s = document.getElementById('ops-status');
                  if (s) s.textContent = show ? '회의 퀵패널 열림' : '회의 퀵패널 닫힘';
                } catch(_) {}
              }
              var meetBtn = document.createElement('button');
              meetBtn.id = 'btn-meeting-panel';
              meetBtn.className = 'btn';
              meetBtn.type = 'button';
              meetBtn.title = '회의패널 토글 (Ctrl+Alt+H)';
              meetBtn.textContent = '회의패널(β)';
              meetBtn.addEventListener('click', function(){ toggleMeetingDrawer(); });
              toolbar.appendChild(meetBtn);

              // Keyboard shortcut: Ctrl+Alt+H
              window.addEventListener('keydown', function(e){
                try {
                  // ignore when typing in inputs/textareas
                  var t = e.target || e.srcElement;
                  var tag = (t && t.tagName || '').toLowerCase();
                  if (tag === 'input' || tag === 'textarea' || (t && t.isContentEditable)) return;
                  if (e.ctrlKey && e.altKey && !e.shiftKey && !e.metaKey && (e.key === 'h' || e.key === 'H')) {
                    e.preventDefault();
                    toggleMeetingDrawer();
                  }
                } catch(_) {}
              }, true);
            } catch(_){}
            }
          } catch (_) {}

        // Resize ghosting mitigations (Linux/Tauri)
        try {
          var isLinux = /Linux/i.test(navigator.userAgent || "");
          var isTauri = !!(window.__TAURI__ && window.__TAURI__.invoke);

          // 1) Disable header blur on Linux+Tauri to avoid WebKitGTK artifacts
          if (isLinux && isTauri) {
            try { document.body.setAttribute('data-noblur', '1'); } catch (_) {}
            var hdr = document.querySelector('header');
            if (hdr) {
              hdr.style.backdropFilter = 'none';
              hdr.style.webkitBackdropFilter = 'none';
            }
          }

          // 2) Layer isolation for header/tabs to reduce repaint trails
          (function isolateLayers(){
            var hdr = document.querySelector('header');
            var tabs = document.querySelector('nav.tabs');
            if (hdr) {
              hdr.style.isolation = 'isolate';
              hdr.style.willChange = 'transform';
              hdr.style.transform = 'translateZ(0)';
            }
            if (tabs) {
              tabs.style.isolation = 'isolate';
              tabs.style.willChange = 'transform';
              tabs.style.transform = 'translateZ(0)';
            }
          })();

          // 3) Repaint hack on resize (throttled) + debounce "resizing" mode to clear ghosting
          var __rp_last = 0, __rp_tid = null, __rz_to = null;
          window.addEventListener('resize', function () {
            var now = Date.now();
            var b = document.body;
            try { b.classList.add('resizing'); } catch (_) {}
            if (now - __rp_last < 90) {
              if (__rz_to) clearTimeout(__rz_to);
              __rz_to = setTimeout(function(){
                try {
                  b.classList.remove('resizing');
                  softRepaint();
                  if ((localStorage.getItem('gg_auto_reload_on_resize')||'1')==='1') {
                    setTimeout(function(){ try { location.reload(); } catch(_){ } }, 30);
                  }
                } catch (_) {}
              }, 220);
              return;
            }
            __rp_last = now;
            if (__rp_tid) { cancelAnimationFrame(__rp_tid); __rp_tid = null; }
            __rp_tid = requestAnimationFrame(function () {
              try {
                // Force reflow + GPU tick
                b.style.willChange = 'transform';
                void b.offsetHeight; // reflow
                b.style.transform = 'translateZ(0)';
                setTimeout(function () {
                  b.style.transform = '';
                  b.style.willChange = 'auto';
                }, 120);
              } catch (_) {}
            });
            if (__rz_to) clearTimeout(__rz_to);
            __rz_to = setTimeout(function(){
              try {
                b.classList.remove('resizing');
                softRepaint();
                if ((localStorage.getItem('gg_auto_reload_on_resize')||'1')==='1') {
                  setTimeout(function(){ try { location.reload(); } catch(_){ } }, 30);
                }
              } catch (_) {}
            }, 220);
          });
        } catch (_) {}
      })();
    </script>
    </body>
</html>
