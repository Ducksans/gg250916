<!doctype html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>A6 — 요약(SSV) v0</title>
        <style>
            :root {
                --bg: #0b1020;
                --panel: #121933;
                --panel2: #0d152c;
                --fg: #e6eefb;
                --muted: #9aa8c4;
                --border: #24304f;
                --ok: #14b8a6;
                --warn: #f59e0b;
                --err: #ef4444;
                --accent: #60a5fa;
                --code: #0f1830;
                --hover: #0f1931;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--fg);
                font:
                    14px/1.5 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Noto Sans,
                    Apple SD Gothic Neo,
                    Malgun Gothic,
                    sans-serif;
            }
            .mono {
                font-family:
                    ui-monospace, SFMono-Regular, Consolas, Menlo, Monaco,
                    monospace;
            }
            #app {
                display: grid;
                grid-template-rows: auto 1fr auto;
                min-height: 100%;
            }
            header,
            footer {
                display: flex;
                gap: 0.6rem;
                align-items: center;
                justify-content: space-between;
                padding: 0.6rem 0.9rem;
                background: var(--panel);
                border-bottom: 1px solid var(--border);
            }
            footer {
                border-top: 1px solid var(--border);
                border-bottom: none;
            }
            .row {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                flex-wrap: wrap;
            }
            input,
            select,
            button {
                background: var(--panel2);
                color: var(--fg);
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 0.38rem 0.55rem;
            }
            button {
                cursor: pointer;
            }
            button:hover {
                border-color: #3a518a;
            }
            main {
                display: grid;
                grid-template-columns: 1.2fr 0.8fr;
                min-height: 0;
            }
            @media (max-width: 980px) {
                main {
                    grid-template-columns: 1fr;
                }
            }
            section,
            aside {
                display: flex;
                flex-direction: column;
                min-height: 0;
            }
            .title {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.55rem 0.9rem;
                background: var(--panel2);
                border-bottom: 1px solid var(--border);
                color: var(--muted);
                font-weight: 600;
            }
            .body {
                flex: 1;
                overflow: auto;
            }
            .kv {
                display: grid;
                grid-template-columns: 140px 1fr;
                gap: 0.4rem 0.8rem;
                padding: 0.8rem 0.9rem;
            }
            .k {
                color: var(--muted);
            }
            .grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.6rem;
                padding: 0.8rem 0.9rem;
            }
            .card {
                border: 1px solid var(--border);
                border-radius: 8px;
                background: var(--panel2);
                padding: 0.6rem 0.7rem;
            }
            code {
                background: var(--code);
                border: 1px solid var(--border);
                padding: 0.05rem 0.3rem;
                border-radius: 4px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                padding: 0.45rem 0.55rem;
                border-bottom: 1px solid var(--border);
                vertical-align: top;
            }
            thead {
                position: sticky;
                top: 0;
                background: #0e1730;
                z-index: 1;
            }
            tr:hover td {
                background: var(--hover);
            }
            .badge {
                display: inline-flex;
                gap: 0.4rem;
                align-items: center;
                padding: 0.18rem 0.5rem;
                border-radius: 999px;
                border: 1px solid var(--border);
                color: var(--muted);
            }
            .badge.ok {
                background: rgba(20, 184, 166, 0.12);
                color: var(--ok);
                border-color: rgba(20, 184, 166, 0.35);
            }
            .badge.warn {
                background: rgba(245, 158, 11, 0.12);
                color: var(--warn);
                border-color: rgba(245, 158, 11, 0.35);
            }
            .badge.err {
                background: rgba(239, 68, 68, 0.12);
                color: var(--err);
                border-color: rgba(239, 68, 68, 0.35);
            }
            .pill {
                padding: 0.05rem 0.45rem;
                border: 1px solid var(--border);
                border-radius: 999px;
                background: #0e1730;
            }
            .errbox {
                display: none;
                margin: 0.6rem 0.9rem;
                padding: 0.6rem 0.8rem;
                border-radius: 8px;
            }
            .errbox.show {
                display: block;
                background: rgba(239, 68, 68, 0.08);
                border: 1px solid rgba(239, 68, 68, 0.35);
                color: #fecaca;
            }
        </style>
    </head>
    <body>
        <div id="app" role="application" aria-label="A6 — SSV Summary v0">
            <header>
                <div class="row" style="gap: 0.8rem">
                    <strong>SSV 요약(β)</strong>
                    <label for="lens" class="k">렌즈(Lens)</label>
                    <select id="lens" aria-label="렌즈">
                        <option value="Core">Core</option>
                        <option value="Hub">Hub</option>
                        <option value="API">API</option>
                        <option value="Memory">Memory</option>
                        <option value="Runtime">Runtime</option>
                        <option value="Quarantine">Quarantine</option>
                    </select>
                    <button
                        id="btnRefresh"
                        type="button"
                        title="스냅샷 새로고침 (Refresh)"
                    >
                        새로고침
                    </button>
                    <button
                        id="btnCopyMeta"
                        type="button"
                        title="메타 요약 복사 (Copy)"
                    >
                        메타 복사
                    </button>
                </div>
                <span id="statusBadge" class="badge">상태: —</span>
            </header>

            <div id="err" class="errbox" role="alert" aria-live="polite"></div>

            <main>
                <section aria-labelledby="metaTitle">
                    <div class="title">
                        <span id="metaTitle">Snapshot Meta</span>
                        <span id="metaHint" class="k"></span>
                    </div>
                    <div class="body">
                        <div class="kv">
                            <div class="k">API_BASE</div>
                            <div id="apiBase" class="mono">—</div>
                            <div class="k">path</div>
                            <div id="snapPath" class="mono">—</div>
                            <div class="k">snapshot_id</div>
                            <div id="snapshotId" class="mono">—</div>
                            <div class="k">created_at</div>
                            <div id="createdAt" class="mono">—</div>
                            <div class="k">lens</div>
                            <div id="lensVal" class="mono">—</div>
                            <div class="k">K</div>
                            <div id="kVal" class="mono">—</div>
                            <div class="k">thresholds</div>
                            <div id="thVal" class="mono">—</div>
                            <div class="k">counts</div>
                            <div id="counts" class="mono">—</div>
                        </div>

                        <div class="grid">
                            <div class="card" aria-labelledby="anchorsTitle">
                                <div
                                    class="row"
                                    style="justify-content: space-between"
                                >
                                    <strong id="anchorsTitle"
                                        >Anchors (pinned)</strong
                                    >
                                    <div
                                        id="anchorBadges"
                                        class="row"
                                        aria-live="polite"
                                    ></div>
                                </div>
                                <div class="k" style="margin-top: 0.4rem">
                                    핵심 앵커 4종 존재 여부를 확인합니다.
                                </div>
                            </div>

                            <div class="card" aria-labelledby="topTitle">
                                <div
                                    class="row"
                                    style="justify-content: space-between"
                                >
                                    <strong id="topTitle"
                                        >Top-5 Centrality</strong
                                    >
                                    <div class="row">
                                        <button
                                            id="btnCopyTop"
                                            type="button"
                                            title="Copy visible Top-5 rows"
                                        >
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 0.4rem">
                                    <table aria-label="Top-5 nodes">
                                        <thead>
                                            <tr>
                                                <th style="width: 56px">
                                                    순위
                                                </th>
                                                <th>경로</th>
                                                <th style="width: 120px">
                                                    역할
                                                </th>
                                                <th style="width: 100px">
                                                    중심성
                                                </th>
                                                <th style="width: 160px">
                                                    동작
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="topTbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <aside aria-labelledby="opsTitle">
                    <div class="title">
                        <span id="opsTitle">운영 · 도구</span>
                    </div>
                    <div class="body">
                        <div class="card">
                            <div
                                class="row"
                                style="justify-content: space-between"
                            >
                                <strong>빠른 작업(Quick Actions)</strong>
                                <span class="pill mono" id="ts">—</span>
                            </div>
                            <div class="row" style="margin-top: 0.5rem">
                                <button id="btnOpenJson" type="button">
                                    sitegraph.json 열기
                                </button>
                                <button id="btnCopyPath" type="button">
                                    경로 복사
                                </button>
                                <button id="btnRetry" type="button">
                                    재시도
                                </button>
                            </div>
                            <div class="k" style="margin-top: 0.4rem">
                                “Open”은 브릿지가 켜져 있을 때만 동작합니다.
                                꺼져 있으면 경로 복사로 폴백합니다.
                            </div>
                        </div>

                        <div class="card">
                            <strong>범례(Legend)</strong>
                            <div
                                class="row"
                                style="
                                    margin-top: 0.4rem;
                                    flex-wrap: wrap;
                                    gap: 0.35rem 0.5rem;
                                "
                            >
                                <span class="badge ok">좋음</span>
                                <span class="badge warn">경고</span>
                                <span class="badge err">오류</span>
                                <span
                                    class="pill"
                                    title="코어 — 운영 판단의 중심·결정 근거 (Core/SSOT)"
                                    aria-label="C — 코어 — 운영 판단의 중심·결정 근거 (Core/SSOT)"
                                    >C</span
                                >
                                <span
                                    class="pill"
                                    title="허브 — 요약·인덱스·길잡이 (Hub/Index)"
                                    aria-label="H — 허브 — 요약·인덱스·길잡이 (Hub/Index)"
                                    >H</span
                                >
                                <span
                                    class="pill"
                                    title="정적 문서 — 스펙·규칙 등 변경 빈도 낮음 (Static docs/specs)"
                                    aria-label="S — 정적 문서 — 스펙·규칙 등 변경 빈도 낮음 (Static docs/specs)"
                                    >S</span
                                >
                                <span
                                    class="pill"
                                    title="동적 증거 — 스냅샷·로그·측정치 등 시계열 (Dynamic evidence/data)"
                                    aria-label="D — 동적 증거 — 스냅샷·로그·측정치 등 시계열 (Dynamic evidence/data)"
                                    >D</span
                                >
                                <span
                                    class="pill"
                                    title="API/코드 표면 — 외부/내부 호출 인터페이스 (API/Code surface)"
                                    aria-label="A — API/코드 표면 — 외부/내부 호출 인터페이스 (API/Code surface)"
                                    >A</span
                                >
                                <span
                                    class="pill"
                                    title="프런트/UI — 화면·스타일·자산 (Frontend/UI assets)"
                                    aria-label="UI — 프런트/UI — 화면·스타일·자산 (Frontend/UI assets)"
                                    >UI</span
                                >
                                <span
                                    class="pill"
                                    title="런타임 — 실행 환경·설정·로그 (Runtime/Logs/Env)"
                                    aria-label="R — 런타임 — 실행 환경·설정·로그 (Runtime/Logs/Env)"
                                    >R</span
                                >
                                <span
                                    class="pill"
                                    title="격리 — 민감/대용량 등 격리 보관 (Quarantine/Isolated)"
                                    aria-label="Q — 격리 — 민감/대용량 등 격리 보관 (Quarantine/Isolated)"
                                    >Q</span
                                >
                                <span
                                    class="pill"
                                    title="메모리 계층 — 저장→검색→회상 루프 (Memory-tier)"
                                    aria-label="M — 메모리 계층 — 저장→검색→회상 루프 (Memory-tier)"
                                    >M</span
                                >
                                <span
                                    class="pill"
                                    title="레거시/외부 — 과거 유산·외부 연계 (Legacy/External)"
                                    aria-label="X — 레거시/외부 — 과거 유산·외부 연계 (Legacy/External)"
                                    >X</span
                                >
                            </div>
                        </div>
                    </div>
                </aside>
            </main>

            <footer>
                <div id="status" aria-live="polite" class="k">준비</div>
                <div id="tsFoot" class="mono"></div>
            </footer>
        </div>

        <script>
            (function () {
                "use strict";

                // Elements
                const $ = (id) => document.getElementById(id);
                const statusBadge = $("statusBadge");
                const errBox = $("err");
                const lensSel = $("lens");
                const apiBaseEl = $("apiBase");
                const snapPathEl = $("snapPath");
                const snapshotIdEl = $("snapshotId");
                const createdAtEl = $("createdAt");
                const lensValEl = $("lensVal");
                const kValEl = $("kVal");
                const thValEl = $("thVal");
                const countsEl = $("counts");
                const anchorBadges = $("anchorBadges");
                const topTbody = $("topTbody");
                const tsEl = $("ts");
                const tsFoot = $("tsFoot");
                const statusEl = $("status");

                // Config
                const qs = new URLSearchParams(location.search);
                const DEFAULT_BASE = "http://127.0.0.1:8000";
                const API_BASE =
                    (qs.get("base") && qs.get("base").replace(/\/+$/, "")) ||
                    (localStorage.getItem("gg_backend_url") || "").replace(
                        /\/+$/,
                        "",
                    ) ||
                    (location.origin && location.origin.startsWith("http")
                        ? location.origin
                        : DEFAULT_BASE);
                apiBaseEl.textContent = API_BASE;

                // Helpers
                function setBadge(kind, text) {
                    statusBadge.classList.remove("ok", "warn", "err");
                    if (kind) statusBadge.classList.add(kind);
                    statusBadge.textContent = "상태: " + (text || "—");
                }
                function setStatus(text) {
                    statusEl.textContent = text || "";
                }
                function showError(msg) {
                    errBox.classList.add("show");
                    errBox.textContent = msg;
                }
                function clearError() {
                    errBox.classList.remove("show");
                    errBox.textContent = "";
                }
                function setLoading(loading) {
                    const ids = [
                        "btnRefresh",
                        "btnRetry",
                        "btnCopyMeta",
                        "btnCopyPath",
                        "btnOpenJson",
                        "btnCopyTop",
                        "btnForce",
                    ];
                    ids.forEach((id) => {
                        const el = $(id);
                        if (el) el.disabled = !!loading;
                    });
                }
                async function jget(url, opts = {}) {
                    const timeout0 = Number.isFinite(opts.timeoutMs)
                        ? Math.max(500, opts.timeoutMs)
                        : 6000;
                    const retries = Number.isFinite(opts.retries)
                        ? Math.max(0, opts.retries)
                        : 2;
                    for (let attempt = 0; attempt <= retries; attempt++) {
                        const ac = new AbortController();
                        const t = setTimeout(
                            () => ac.abort("timeout"),
                            Math.floor(timeout0 * Math.pow(1.5, attempt)),
                        );
                        try {
                            const r = await fetch(url, {
                                headers: { Accept: "application/json" },
                                signal: ac.signal,
                                cache: "no-store",
                            });
                            clearTimeout(t);
                            if (!r.ok)
                                throw new Error(r.status + " " + r.statusText);
                            return r.json();
                        } catch (e) {
                            clearTimeout(t);
                            if (attempt >= retries) throw e;
                            // exponential backoff
                            const delay = 400 * Math.pow(2, attempt);
                            await new Promise((res) => setTimeout(res, delay));
                        }
                    }
                }
                function copy(text) {
                    if (!navigator.clipboard) throw new Error("no clipboard");
                    return navigator.clipboard.writeText(String(text || ""));
                }
                function bridgeBase() {
                    const b =
                        (window.ggBridgeBase && window.ggBridgeBase()) ||
                        localStorage.getItem("gg_bridge_url") ||
                        "http://localhost:3037";
                    return String(b).replace(/\/+$/, "");
                }
                async function bridgeOpenRepoPath(repoPath) {
                    let root = "gumgang_meeting";
                    let path = String(repoPath || "");
                    if (path.startsWith("gumgang_meeting/status/")) {
                        root = "status";
                        path = path.slice("gumgang_meeting/status/".length);
                    } else if (path.startsWith("gumgang_meeting/")) {
                        path = path.slice("gumgang_meeting/".length);
                    }
                    const r = await fetch(bridgeBase() + "/api/open", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ root, path }),
                    });
                    if (!r.ok) throw new Error("bridge " + r.status);
                }
                function rolesStr(r) {
                    return Array.isArray(r) ? r.join(",") : "";
                }

                // Anchors
                const MUST_ANCHORS = [
                    "gumgang_meeting/.rules",
                    "gumgang_meeting/status/checkpoints/CKPT_72H_RUN.md",
                    "gumgang_meeting/app/api.py",
                    "gumgang_meeting/status/design/memory_gate/SSOT.md",
                ];
                function renderAnchors(pinned) {
                    anchorBadges.innerHTML = "";
                    const have = new Set(Array.isArray(pinned) ? pinned : []);
                    MUST_ANCHORS.forEach((p) => {
                        const label = p.replace("gumgang_meeting/", "");
                        const span = document.createElement("span");
                        const ok = have.has(p);
                        span.className = "badge " + (ok ? "ok" : "warn");
                        span.textContent = (ok ? "OK " : "MISS ") + label;
                        span.setAttribute("role", "button");
                        span.setAttribute("tabindex", "0");
                        span.title = "열기(브릿지) 또는 경로 복사";
                        async function doOpen() {
                            try {
                                await bridgeOpenRepoPath(p);
                                setBadge("ok", "열림");
                            } catch {
                                try {
                                    await copy(p);
                                    setBadge(
                                        "warn",
                                        "브릿지 꺼짐 — 경로 복사됨",
                                    );
                                } catch {
                                    setBadge("err", "열기/복사 실패");
                                }
                            }
                        }
                        span.addEventListener("click", doOpen);
                        span.addEventListener("keydown", (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                                e.preventDefault();
                                doOpen();
                            }
                        });
                        anchorBadges.appendChild(span);
                    });
                }

                // Top-5
                function pickTop5(nodes) {
                    const arr = Array.isArray(nodes) ? nodes.slice() : [];
                    arr.sort((a, b) => {
                        const sa = ((a || {}).scores || {}).centrality || 0;
                        const sb = ((b || {}).scores || {}).centrality || 0;
                        if (sb !== sa) return sb - sa; // primary: centrality desc
                        const ia = (a && a.id) || "";
                        const ib = (b && b.id) || "";
                        if (ia < ib) return -1; // tie-break: id asc
                        if (ia > ib) return 1;
                        return 0;
                    });
                    return arr.slice(0, 5);
                }
                function renderTop5(list) {
                    topTbody.innerHTML = "";
                    list.forEach((n, i) => {
                        const tr = document.createElement("tr");
                        const td = (t) => {
                            const el = document.createElement("td");
                            el.textContent = t;
                            return el;
                        };
                        tr.appendChild(td(String(i + 1)));
                        const pathTd = document.createElement("td");
                        const code = document.createElement("code");
                        code.textContent = n.id || "";
                        pathTd.appendChild(code);
                        tr.appendChild(pathTd);
                        const rolesTd = document.createElement("td");
                        (n.roles || []).forEach((code) => {
                            const chip = document.createElement("span");
                            chip.className = "pill";
                            chip.textContent = code;
                            const roleDict = {
                                C: "코어 — 운영 판단의 중심·결정 근거 (Core/SSOT)",
                                H: "허브 — 요약·인덱스·길잡이 (Hub/Index)",
                                S: "정적 문서 — 스펙·규칙 등 변경 빈도 낮음 (Static docs/specs)",
                                D: "동적 증거 — 스냅샷·로그·측정치 등 시계열 (Dynamic evidence/data)",
                                A: "API/코드 표면 — 외부/내부 호출 인터페이스 (API/Code surface)",
                                UI: "프런트/UI — 화면·스타일·자산 (Frontend/UI assets)",
                                R: "런타임 — 실행 환경·설정·로그 (Runtime/Logs/Env)",
                                Q: "격리 — 민감/대용량 등 격리 보관 (Quarantine/Isolated)",
                                M: "메모리 계층 — 저장→검색→회상 루프 (Memory-tier)",
                                X: "레거시/외부 — 과거 유산·외부 연계 (Legacy/External)",
                            };
                            chip.title = roleDict[code] || code;
                            chip.setAttribute(
                                "aria-label",
                                roleDict[code]
                                    ? code + " — " + roleDict[code]
                                    : code,
                            );
                            chip.style.marginRight = "4px";
                            rolesTd.appendChild(chip);
                        });
                        tr.appendChild(rolesTd);
                        tr.appendChild(
                            td(
                                (
                                    ((n || {}).scores || {}).centrality || 0
                                ).toFixed(3),
                            ),
                        );
                        const act = document.createElement("td");
                        const btnOpen = document.createElement("button");
                        btnOpen.textContent = "열기";
                        btnOpen.title =
                            "열기(브릿지 필요; 꺼져 있으면 경로 복사)";
                        btnOpen.onclick = async () => {
                            try {
                                await bridgeOpenRepoPath(n.id || "");
                                setBadge("ok", "열림");
                            } catch {
                                try {
                                    await copy(n.id || "");
                                    setBadge(
                                        "warn",
                                        "브릿지 꺼짐 — 경로 복사됨",
                                    );
                                } catch {
                                    setBadge("err", "열기/복사 실패");
                                }
                            }
                        };
                        const btnCopy = document.createElement("button");
                        btnCopy.textContent = "복사";
                        btnCopy.title = "경로 복사";
                        btnCopy.onclick = () =>
                            copy(n.id || "")
                                .then(() => setBadge("ok", "복사됨"))
                                .catch(() => setBadge("err", "복사 실패"));
                        act.appendChild(btnOpen);
                        act.appendChild(btnCopy);
                        tr.appendChild(act);
                        topTbody.appendChild(tr);
                    });
                }

                // Controller
                async function refresh(opts) {
                    opts = opts || {};
                    const bust = !!opts.bust;

                    clearError();
                    setBadge(null, "loading…");
                    setLoading(true);

                    const now = new Date().toISOString();
                    tsEl.textContent = now;
                    tsFoot.textContent = now;

                    // One-time button injection and handler upgrades
                    try {
                        if (!window.__ggA6_injected) {
                            window.__ggA6_injected = true;
                            const r = $("btnRefresh");
                            if (r) {
                                r.onclick = (e) =>
                                    refresh({
                                        bust: !!(e && (e.shiftKey || e.altKey)),
                                    });
                                if (!document.getElementById("btnForce")) {
                                    const b = document.createElement("button");
                                    b.id = "btnForce";
                                    b.type = "button";
                                    b.title = "Force reload (cache-busting)";
                                    b.textContent = "Force Reload";
                                    r.insertAdjacentElement("afterend", b);
                                    b.onclick = () => refresh({ bust: true });
                                }
                            }
                            const ry = $("btnRetry");
                            if (ry) ry.onclick = () => refresh({ bust: false });
                        }
                    } catch (_) {}

                    try {
                        const lensQ = encodeURIComponent(
                            lensSel.value || "Core",
                        );
                        const bustQ = bust ? "&_=" + Date.now() : "";
                        const url =
                            API_BASE +
                            "/api/sitegraph/latest?lens=" +
                            lensQ +
                            bustQ;
                        const data = await jget(url, {
                            timeoutMs: 7000,
                            retries: 2,
                        });
                        const snap = (data && data.data) || {};
                        const meta = snap.meta || {};
                        const nodes = snap.nodes || [];
                        const edges = snap.edges || [];
                        const anchors = snap.anchors || {};

                        snapPathEl.textContent = (data && data.path) || "—";
                        snapshotIdEl.textContent = meta.snapshot_id || "—";
                        createdAtEl.textContent = meta.created_at || "—";
                        lensValEl.textContent = meta.lens || "—";
                        kValEl.textContent = JSON.stringify(meta.K || {});
                        thValEl.textContent = JSON.stringify(
                            meta.thresholds || {},
                        );
                        countsEl.textContent =
                            "nodes:" + nodes.length + ", edges:" + edges.length;

                        renderAnchors(anchors.pinned || []);
                        renderTop5(pickTop5(nodes));
                        setBadge("ok", "로드 완료");
                        setStatus("로드 완료");
                    } catch (e) {
                        showError(
                            "로드 실패: " + (e && e.message ? e.message : e),
                        );
                        setBadge("warn", "로드 실패");
                        setStatus("로드 실패");
                    } finally {
                        setLoading(false);
                        if (typeof window.localizeKR === "function") {
                            try {
                                window.localizeKR();
                            } catch (_) {}
                        }
                    }
                }

                // Wire buttons
                $("btnRefresh").onclick = refresh;
                $("btnRetry").onclick = refresh;
                $("btnCopyMeta").onclick = () => {
                    const lines = [
                        "API_BASE=" + API_BASE,
                        "snapshot_id=" + (snapshotIdEl.textContent || ""),
                        "created_at=" + (createdAtEl.textContent || ""),
                        "lens=" + (lensValEl.textContent || ""),
                        "K=" + (kValEl.textContent || ""),
                        "thresholds=" + (thValEl.textContent || ""),
                        "counts=" + (countsEl.textContent || ""),
                        "path=" + (snapPathEl.textContent || ""),
                    ];
                    copy(lines.join("\n"))
                        .then(() => setBadge("ok", "메타 복사됨"))
                        .catch(() => setBadge("err", "복사 실패"));
                };
                $("btnCopyPath").onclick = () => {
                    copy(snapPathEl.textContent || "")
                        .then(() => setBadge("ok", "경로 복사됨"))
                        .catch(() => setBadge("err", "복사 실패"));
                };
                $("btnOpenJson").onclick = async () => {
                    const p = snapPathEl.textContent || "";
                    if (!p || p === "—") {
                        setBadge("warn", "no path");
                        return;
                    }
                    try {
                        await bridgeOpenRepoPath(p);
                        setBadge("ok", "열림");
                    } catch {
                        try {
                            await copy(p);
                            setBadge("warn", "브릿지 꺼짐 — 경로 복사됨");
                        } catch {
                            setBadge("err", "열기/복사 실패");
                        }
                    }
                };
                const btnCopyTop = $("btnCopyTop");
                if (btnCopyTop) {
                    btnCopyTop.onclick = () => {
                        const rows = Array.from(topTbody.querySelectorAll("tr"))
                            .map((tr) => {
                                const tds = tr.querySelectorAll("td");
                                return [
                                    tds[0]?.textContent || "",
                                    tds[1]?.textContent || "",
                                    tds[2]?.textContent || "",
                                    tds[3]?.textContent || "",
                                ].join("\t");
                            })
                            .join("\n");
                        copy(rows)
                            .then(() => setBadge("ok", "상위 5개 복사됨"))
                            .catch(() => setBadge("err", "복사 실패"));
                    };
                }

                // Init
                document.addEventListener(
                    "DOMContentLoaded",
                    () => {
                        // Lightweight KR localization without changing data keys
                        window.localizeKR = function () {
                            try {
                                document.title = "A6 — 요약(SSV) v0";
                                const sBadge =
                                    document.getElementById("statusBadge");
                                if (
                                    sBadge &&
                                    /^Status:/.test(sBadge.textContent)
                                ) {
                                    sBadge.textContent =
                                        sBadge.textContent.replace(
                                            /^Status:/,
                                            "상태:",
                                        );
                                }
                                const hdrStrong =
                                    document.querySelector(
                                        "header .row strong",
                                    );
                                if (hdrStrong)
                                    hdrStrong.textContent = "SSV 요약(β)";
                                const lensLabel =
                                    document.querySelector('label[for="lens"]');
                                if (lensLabel) lensLabel.textContent = "렌즈";
                                const btnRefresh =
                                    document.getElementById("btnRefresh");
                                if (btnRefresh) {
                                    btnRefresh.textContent = "새로고침";
                                    btnRefresh.title = "스냅샷 새로고침";
                                }
                                const btnCopyMeta =
                                    document.getElementById("btnCopyMeta");
                                if (btnCopyMeta) {
                                    btnCopyMeta.textContent = "메타 복사";
                                    btnCopyMeta.title = "메타 요약 복사";
                                }
                                const btnForce =
                                    document.getElementById("btnForce");
                                if (btnForce) {
                                    btnForce.textContent = "강제 새로고침";
                                    btnForce.title = "캐시 무시하고 새로고침";
                                }

                                const anchorsTitle =
                                    document.getElementById("anchorsTitle");
                                if (anchorsTitle)
                                    anchorsTitle.textContent = "핵심 앵커";
                                const topTitle =
                                    document.getElementById("topTitle");
                                if (topTitle)
                                    topTitle.textContent = "상위 5개(중심성)";
                                const metaTitle =
                                    document.getElementById("metaTitle");
                                if (metaTitle)
                                    metaTitle.textContent = "스냅샷 메타";
                                const metaHint =
                                    document.getElementById("metaHint");
                                if (metaHint && !metaHint.textContent)
                                    metaHint.textContent =
                                        "상단에서 렌즈 선택 후 새로고침하세요";

                                const opsTitle =
                                    document.getElementById("opsTitle");
                                if (opsTitle)
                                    opsTitle.textContent = "운영 · 도구";
                                const qaStrong =
                                    document.querySelector(
                                        "aside .card strong",
                                    );
                                if (qaStrong)
                                    qaStrong.textContent = "빠른 작업";

                                const btnOpenJson =
                                    document.getElementById("btnOpenJson");
                                if (btnOpenJson)
                                    btnOpenJson.textContent =
                                        "sitegraph.json 열기";
                                const btnCopyPath =
                                    document.getElementById("btnCopyPath");
                                if (btnCopyPath)
                                    btnCopyPath.textContent = "경로 복사";
                                const btnRetry =
                                    document.getElementById("btnRetry");
                                if (btnRetry) btnRetry.textContent = "재시도";

                                const legendStrong = Array.from(
                                    document.querySelectorAll(
                                        "aside .card strong",
                                    ),
                                ).find((el) => el.textContent === "Legend");
                                if (legendStrong)
                                    legendStrong.textContent = "범례";
                                const ok =
                                    document.querySelector("aside .badge.ok");
                                if (ok) ok.textContent = "좋음";
                                const warn =
                                    document.querySelector("aside .badge.warn");
                                if (warn) warn.textContent = "경고";
                                const err =
                                    document.querySelector("aside .badge.err");
                                if (err) err.textContent = "오류";

                                const ths =
                                    document.querySelectorAll("table thead th");
                                if (ths.length >= 5) {
                                    ths[0].textContent = "순위";
                                    ths[1].textContent = "경로";
                                    ths[2].textContent = "역할";
                                    ths[3].textContent = "중심성";
                                    ths[4].textContent = "동작";
                                }

                                const btnCopyTop =
                                    document.getElementById("btnCopyTop");
                                if (btnCopyTop) {
                                    btnCopyTop.textContent = "복사";
                                    btnCopyTop.title = "표시된 Top‑5 행 복사";
                                }

                                // Action buttons inside Top‑5 rows
                                document
                                    .querySelectorAll("#topTbody button")
                                    .forEach((b) => {
                                        const t = (b.textContent || "").trim();
                                        if (t === "Open")
                                            b.textContent = "열기";
                                        else if (t === "Copy")
                                            b.textContent = "복사";
                                    });
                            } catch (_) {}
                        };

                        // First localization, then observe dynamic changes and refresh data
                        window.localizeKR();
                        // live localization removed to avoid loops

                        refresh();
                    },
                    { once: true },
                );
            })();
        </script>
    </body>
</html>
