<!doctype html>
<html lang="ko">
    <head>
        <!-- FIX: head를 올바르게 구성 -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>A7 — 비즈니스 (Evidence 카드)</title>
        <style>
            :root {
                --bg: #0b1020;
                --panel: #0f172a;
                --panel2: #111827;
                --fg: #e6eefb;
                --muted: #9aa8c4;
                --border: #24304f;
                --ok: #22c55e;
                --warn: #f59e0b;
                --err: #ef4444;
                --hover: #0f1931;
                --shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
                --container: clamp(960px, 90vw, 1400px);
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--fg);
                font:
                    14px/1.5 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Noto Sans,
                    Apple SD Gothic Neo,
                    Malgun Gothic,
                    sans-serif;
            }
            .mono {
                font-family:
                    ui-monospace, SFMono-Regular, Consolas, Menlo, Monaco,
                    monospace;
            }
            header,
            footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.8rem;
                padding: 0.7rem 1rem;
                background: var(--panel);
                border-bottom: 1px solid var(--border);
            }
            footer {
                border-top: 1px solid var(--border);
                border-bottom: none;
                background: var(--panel2);
            }
            .row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            input,
            select,
            button {
                background: var(--panel2);
                color: var(--fg);
                border: 1px solid var(--border);
                padding: 0.42rem 0.6rem;
                border-radius: 8px;
            }
            button {
                cursor: pointer;
            }
            button:hover {
                border-color: #3a518a;
            }
            main {
                max-width: var(--container);
                margin: 12px auto 28px;
                padding: 0 10px;
                min-height: 60vh;
            }
            .grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            @media (max-width: 1200px) {
                .grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            @media (max-width: 820px) {
                .grid {
                    grid-template-columns: 1fr;
                }
            }
            .card {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                border: 1px solid var(--border);
                border-radius: 12px;
                background: var(--panel2);
                padding: 0.8rem 0.9rem;
                box-shadow: var(--shadow);
            }
            .card h3 {
                margin: 0;
                font-size: 16px;
            }
            .meta {
                display: flex;
                gap: 0.6rem;
                color: var(--muted);
                font-size: 12px;
            }
            .bullets {
                margin: 0.2rem 0 0.4rem 1.1rem;
                color: var(--fg);
            }
            .bullets li {
                margin: 0.15rem 0;
            }
            .badge {
                display: inline-flex;
                align-items: center;
                gap: 0.35rem;
                padding: 0.12rem 0.5rem;
                border-radius: 999px;
                border: 1px solid var(--border);
                color: var(--muted);
                font-size: 12px;
            }
            .badge.ok {
                background: rgba(34, 197, 94, 0.12);
                color: var(--ok);
                border-color: rgba(34, 197, 94, 0.35);
            }
            .badge.warn {
                background: rgba(245, 158, 11, 0.12);
                color: var(--warn);
                border-color: rgba(245, 158, 11, 0.35);
            }
            .badge.err {
                background: rgba(239, 68, 68, 0.12);
                color: var(--err);
                border-color: rgba(239, 68, 68, 0.35);
            }
            .actions {
                display: flex;
                gap: 0.45rem;
                margin-top: 0.2rem;
            }
            .muted {
                color: var(--muted);
            }
            .status {
                display: flex;
                align-items: center;
                gap: 0.4rem;
            }
            .errbox {
                display: none;
                margin: 0.6rem 0;
                padding: 0.55rem 0.7rem;
                border-radius: 8px;
            }
            .errbox.show {
                display: block;
                background: rgba(239, 68, 68, 0.08);
                border: 1px solid rgba(239, 68, 68, 0.35);
                color: #fecaca;
            }
            .hint {
                color: var(--muted);
                font-size: 12px;
            }
            .pill {
                padding: 0.05rem 0.45rem;
                border: 1px solid var(--border);
                border-radius: 999px;
                background: var(--panel2);
            }
        </style>
    </head>
    <body>
        <div id="app" role="application" aria-label="A7 — Business">
            <header>
                <div class="row">
                    <strong style="font-size: 16px">A7 — 비즈니스</strong>
                    <span class="hint"
                        >Evidence/ideas/* 문서를 카드로 보여줍니다 (manifest
                        기반)</span
                    >
                </div>
                <div class="row">
                    <button
                        id="btn-refresh"
                        type="button"
                        title="목록 새로고침 (Refresh)"
                    >
                        새로고침
                    </button>
                    <button
                        id="btn-open-dir"
                        type="button"
                        title="아이디어 디렉토리 열기(브릿지 필요, Open directory)"
                    >
                        디렉토리 열기
                    </button>
                    <span id="ts" class="badge">—</span>
                </div>
            </header>

            <main>
                <div
                    id="err"
                    class="errbox"
                    role="alert"
                    aria-live="polite"
                ></div>
                <section aria-label="Business cards">
                    <div
                        class="row"
                        style="
                            justify-content: space-between;
                            margin: 0.2rem 0 0.6rem;
                        "
                    >
                        <div class="status">
                            <span id="status-badge" class="badge">상태: —</span>
                        </div>
                        <span class="hint mono"
                            >매니페스트: ui/proto/atlas_A7/manifest.json</span
                        >
                    </div>
                    <div id="cards" class="grid" aria-live="polite"></div>
                </section>
            </main>

            <footer>
                <div class="row">
                    <span class="muted">Evidence 카드 뷰 — 읽기 전용</span>
                </div>
                <div class="row">
                    <span id="foot-ts" class="mono muted"></span>
                </div>
            </footer>
        </div>

        <script>
            (function () {
                "use strict";

                // --------- Config (manifest 후보 경로) ---------
                const MANIFEST_CANDIDATES = [
                    "/ui/proto/atlas_A7/manifest.json", // 프로젝트 고정 경로
                    new URL("manifest.json", location.href).toString(), // 기존 상대 경로(루트/manifest.json로 해석될 수 있음)
                ];

                // --------- Helpers ---------
                const $ = (id) => document.getElementById(id);
                const cards = $("cards");
                const errBox = $("err");
                const badge = $("status-badge");
                const ts = $("ts");
                const tsFoot = $("foot-ts");

                function setBadge(kind, text) {
                    badge.classList.remove("ok", "warn", "err");
                    if (kind) badge.classList.add(kind);
                    badge.textContent = "상태: " + (text || "—");
                }
                function showErr(msg) {
                    errBox.classList.add("show");
                    errBox.textContent = msg;
                }
                function clearErr() {
                    errBox.classList.remove("show");
                    errBox.textContent = "";
                }
                function nowISO() {
                    const s = new Date().toISOString();
                    ts.textContent = s;
                    tsFoot.textContent = s;
                    return s;
                }

                function bridgeBase() {
                    try {
                        const b =
                            (window.ggBridgeBase && window.ggBridgeBase()) ||
                            localStorage.getItem("gg_bridge_url") ||
                            "http://localhost:3037";
                        return String(b).replace(/\/+$/, "");
                    } catch (_) {
                        return "http://localhost:3037";
                    }
                }
                async function bridgeOpenRepoPath(repoPath) {
                    let root = "gumgang_meeting";
                    let path = String(repoPath || "");
                    if (path.startsWith("gumgang_meeting/status/")) {
                        root = "status";
                        path = path.slice("gumgang_meeting/status/".length);
                    } else if (path.startsWith("gumgang_meeting/")) {
                        path = path.slice("gumgang_meeting/".length);
                    }
                    const r = await fetch(bridgeBase() + "/api/open", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ root, path }),
                    });
                    if (!r.ok) throw new Error("bridge " + r.status);
                }
                function copy(text) {
                    if (!navigator.clipboard) throw new Error("no clipboard");
                    return navigator.clipboard.writeText(String(text || ""));
                }

                // Role dictionary (KR summary + EN full name)
                const ROLE_DICT = {
                    C: "코어 — 운영 판단의 중심·결정 근거 (Core/SSOT)",
                    H: "허브 — 요약·인덱스·길잡이 (Hub/Index)",
                    S: "정적 문서 — 스펙·규칙 등 변경 빈도 낮음 (Static docs/specs)",
                    D: "동적 증거 — 스냅샷·로그·측정치 등 시계열 (Dynamic evidence/data)",
                    A: "API/코드 표면 — 외부/내부 호출 인터페이스 (API/Code surface)",
                    UI: "프런트/UI — 화면·스타일·자산 (Frontend/UI assets)",
                    R: "런타임 — 실행 환경·설정·로그 (Runtime/Logs/Env)",
                    Q: "격리 — 민감/대용량 등 격리 보관 (Quarantine/Isolated)",
                    M: "메모리 계층 — 저장→검색→회상 루프 (Memory-tier)",
                    X: "레거시/외부 — 과거 유산·외부 연계 (Legacy/External)",
                };

                function roleChip(code) {
                    const chip = document.createElement("span");
                    chip.className = "pill";
                    chip.textContent = code;
                    const tip = ROLE_DICT[code] || code;
                    chip.title = tip;
                    chip.setAttribute(
                        "aria-label",
                        ROLE_DICT[code] ? code + " — " + tip : code,
                    );
                    chip.style.marginRight = "4px";
                    return chip;
                }

                function ensureRoleLegend() {
                    const section = cards.parentElement; // section aria-label="Business cards"
                    if (!section) return;
                    let legend = section.querySelector("#role-legend-row");
                    if (!legend) {
                        legend = document.createElement("div");
                        legend.id = "role-legend-row";
                        legend.className = "row";
                        legend.style.margin = "0 0 0.4rem 0";
                        const title = document.createElement("strong");
                        title.textContent = "역할 사전";
                        legend.appendChild(title);
                        section.insertBefore(legend, cards);
                    } else {
                        legend.innerHTML = "<strong>역할 사전</strong>";
                    }
                    ["C", "H", "S", "D", "A", "UI", "R", "Q", "M", "X"].forEach(
                        (k) => {
                            legend.appendChild(roleChip(k));
                        },
                    );
                }

                // --------- Manifest loading ---------
                // Schema: { items: [ { path, title, date, status, bullets?[] } ] }
                async function fetchManifest() {
                    let lastErr = "not tried";
                    for (const href of MANIFEST_CANDIDATES) {
                        try {
                            const url = new URL(href, location.origin);
                            url.searchParams.set("v", String(Date.now())); // dev 캐시 방지
                            const r = await fetch(url.toString(), {
                                headers: { Accept: "application/json" },
                            });
                            if (!r.ok) {
                                lastErr =
                                    "HTTP " + r.status + " @ " + url.pathname;
                                continue;
                            }
                            const j = await r.json();
                            if (j && Array.isArray(j.items)) return j.items;
                            lastErr =
                                "invalid manifest structure @ " + url.pathname;
                        } catch (e) {
                            lastErr = e && e.message ? e.message : String(e);
                        }
                    }
                    throw new Error(lastErr);
                }
                function ensureFields(item) {
                    return {
                        path: String(item.path || ""),
                        title: String(item.title || "(untitled)"),
                        date: String(item.date || "—"),
                        status: String(item.status || "IDEA"),
                        bullets: Array.isArray(item.bullets)
                            ? item.bullets.slice(0, 3)
                            : [],
                        roles: Array.isArray(item.roles)
                            ? item.roles.slice(0, 8)
                            : [],
                    };
                }

                // --------- Rendering ---------
                function cardEl(meta) {
                    const div = document.createElement("div");
                    div.className = "card";

                    const h3 = document.createElement("h3");
                    h3.textContent = meta.title || "(untitled)";

                    const metaLine = document.createElement("div");
                    metaLine.className = "meta";
                    const dateSpan = document.createElement("span");
                    dateSpan.textContent = meta.date || "—";
                    const statusSpan = document.createElement("span");
                    statusSpan.className = "badge ok";
                    statusSpan.textContent = meta.status || "IDEA";
                    metaLine.appendChild(dateSpan);
                    metaLine.appendChild(statusSpan);

                    // Roles chips (optional in manifest)
                    if (Array.isArray(meta.roles) && meta.roles.length) {
                        const rolesRow = document.createElement("div");
                        rolesRow.className = "row";
                        meta.roles.forEach((code) => {
                            rolesRow.appendChild(roleChip(code));
                        });
                        div.appendChild(rolesRow);
                    }

                    const ul = document.createElement("ul");
                    ul.className = "bullets";
                    (meta.bullets || []).forEach((t) => {
                        const li = document.createElement("li");
                        li.textContent = t;
                        ul.appendChild(li);
                    });

                    const actions = document.createElement("div");
                    actions.className = "actions";
                    const btnOpen = document.createElement("button");
                    btnOpen.textContent = "열기";
                    btnOpen.title =
                        "브릿지 ON 시 파일 열기(Open), OFF 시 경로 복사(Copy path)";
                    btnOpen.onclick = async () => {
                        try {
                            await bridgeOpenRepoPath(meta.path);
                            setBadge("ok", "열림");
                        } catch {
                            try {
                                await copy(meta.path);
                                setBadge("warn", "브릿지 꺼짐 — 경로 복사됨");
                            } catch {
                                setBadge("err", "열기/복사 실패");
                            }
                        }
                    };
                    const btnCopy = document.createElement("button");
                    btnCopy.textContent = "경로 복사";
                    btnCopy.title = "경로 복사(Copy path)";
                    btnCopy.onclick = () =>
                        copy(meta.path)
                            .then(() => setBadge("ok", "복사됨"))
                            .catch(() => setBadge("err", "복사 실패"));
                    actions.appendChild(btnOpen);
                    actions.appendChild(btnCopy);

                    const pathNote = document.createElement("div");
                    pathNote.className = "hint mono";
                    pathNote.textContent = meta.path;

                    div.appendChild(h3);
                    div.appendChild(metaLine);
                    if ((meta.bullets || []).length) {
                        div.appendChild(ul);
                    }
                    div.appendChild(actions);
                    div.appendChild(pathNote);
                    return div;
                }

                async function refresh() {
                    clearErr();
                    setBadge(null, "불러오는 중…");
                    nowISO();
                    cards.innerHTML = "";
                    try {
                        const items = await fetchManifest();
                        if (!items.length) setBadge("warn", "목록 비어 있음");
                        items
                            .map(ensureFields)
                            .forEach((meta) => cards.appendChild(cardEl(meta)));
                        ensureRoleLegend();
                        setBadge("ok", "불러옴");
                    } catch (e) {
                        const fallback = ensureFields({
                            path: "gumgang_meeting/status/evidence/business/ideas/20250821_busapp_easteregg.md",
                            title: "비즈니스 아이디어 카드 — 버스 도착 앱 (매니페스트 없음)",
                            date: "—",
                            status: "PLACEHOLDER",
                            bullets: [
                                "manifest.json을 생성하면 목록이 자동으로 로드됩니다",
                                "위 경로의 Evidence를 Open/Copy로 확인할 수 있습니다",
                                "manifest 경로: ui/proto/atlas_A7/manifest.json",
                            ],
                        });
                        cards.appendChild(cardEl(fallback));
                        setBadge("warn", "매니페스트 없음");
                        showErr(
                            "목록 로드 실패: " +
                                (e && e.message ? e.message : String(e)),
                        );
                    }
                }

                // --------- Events ---------
                $("btn-refresh").onclick = refresh;
                $("btn-open-dir").onclick = async () => {
                    const dir =
                        "gumgang_meeting/status/evidence/business/ideas/";
                    try {
                        await bridgeOpenRepoPath(dir);
                        setBadge("ok", "디렉토리 열림");
                    } catch {
                        try {
                            await copy(dir);
                            setBadge("warn", "브릿지 꺼짐 — 경로 복사됨");
                        } catch {
                            setBadge("err", "열기/복사 실패");
                        }
                    }
                };

                // --------- Init ---------
                document.addEventListener("DOMContentLoaded", refresh, {
                    once: true,
                });
            })();
        </script>
    </body>
</html>
