# 지오코드/지도 기반 **부동산 콘텐츠 허브** 청사진  
(대한민국 공식/권위 데이터 활용 + 풍부한 인터랙션 중심)

> 목적: “지도에 점 찍기”를 넘어 **주소→필지(PNU)→규제/가격/생활 인프라→실무 액션**까지 끊김 없이 안내.  
> 원칙: **권위 소스 우선(Juso/NSDI/LX·EUM)** → 민간 API는 보조. **Canonical(허브) First**, 모든 배포는 UTM/딥링크.

---

## 6하원칙 요약(지오/지도 허브)
- 누가(Who): 지도/데이터 엔지니어, 백엔드(API), 프론트(지도), 운영/법무
- 어디서(Where): `geo/*` DB 스키마, 지도 타일/벡터 서비스, 허브 웹 지도, 규제 TL;DR 엔진
- 무엇을(What): 주소 정규화, 좌표계 표준화, PNU/경계 조회, 규제/인프라/가격 레이어, 검색/아이소크론 API
- 어떻게(How): 권위 소스 우선(Juso/NSDI/EUM), 좌표 변환 계층, 캐시/타일링, JSON-LD/딥링크 연계
- 왜(Why): 사용자에게 실무 판단 가능한 ‘지도 기반 의사결정’ 제공, 허브 신뢰와 체류 증대
- 언제(When): MVP(주소→PNU→TL;DR) → V1(히스토리/레이더) → V2(개인화/제휴)

## 0) 핵심 인사이트(현행 생태계 점검 요약)
- **주소 표준화의 단일 출발점**: 도로명주소 API는 **행정구역코드/도로명코드/건물관리번호 + 좌표(entX/entY)**까지 제공. 이를 1차 정답지로 채택.  
- **좌표계 혼재**: 중앙·지자체 데이터는 **WGS84(EPSG:4326)**뿐 아니라 **Korea 2000(예: EPSG:5181/5186)**, ITRF2000 등 혼재. **통합 좌표 변환 계층**이 필수.  
- **규제/용도 레이어**: **토지이음(EUM)**가 용도지역/지구/구역과 행위제한의 정본. 허브는 “필지 선택→규제 의미(용적률/건폐율/허용행위) 요약”을 자동 제공.  
- **가격·지수 레이어**: **공시가격(Realtyprice)** 및 **부동산원 R-ONE(지수/동향)**은 직접 스크래핑이 아닌 링크·다운로드·허용 API로 안전하게 연계.  
- **민간 로컬/지도 API는 보조**: 키워드 장소·행정동 변환·경로·좌표변환 등 풍부하나 정책적 예외(“보안주소” 등)가 존재 → **권위 소스로 보정**.  
- **지자체 오픈데이터**: 서울 등은 좌표계가 섞여 제공(ITRF2000/WTM/WGS84). 전처리 파이프라인에서 **자동 좌표 인지→표준화** 필요.

---

## 1) 사용자에게 ‘와우’를 주는 **인터랙션 설계 12선**
1. **주소 한 줄 → 필지 경계·규제 요약 카드**  
   - 입력: 도로명/지번/랜드마크/좌표  
   - 출력: PNU·지번/도로명 정규화, 필지 폴리곤, **용도지역+주요 제한(용적률/건폐율)·고도지구/지구단위** TL;DR, 관련 고시문 링크.
2. **생활 인프라 영향반경(커스텀 버퍼/아이소크론)**  
   - 학교/지하철/버스/공원/병원/상권 등 **반경/통행시간** 기반 가중치 스코어.  
   - 출퇴근지 입력 시 **도어-투-도어 시간 분포**를 카드로.
3. **가격/세금 즉시 계산**  
   - 공시가격 참조 + 취득세/인지세/중개보수/전월세전환/DSR 가늠치. 결과는 **앱 계산기**로 딥링크.
4. **실거래 & 공시 타임라인**  
   - 단지/필지 축으로 과거 N년 시계열 차트(신고가/거래량/분포) + 공시가격 변동율.
5. **규제 변화 히스토리**  
   - 필지/동 단위로 **지구 지정/해제/변경** 이력(고시문 라벨), 투자/개발 리스크 인포그래픽.
6. **개발사업·공공분양/임대 레이더**  
   - 청약홈/지자체 공고를 **거리·가점·전용면적** 필터로 통합 열람·알림.
7. **권리·계약 체크리스트**  
   - 주소 입력→등기 열람 링크(IROS)·확정일자/전입/전자계약 가이드·체크박스 완료율 추적.
8. **허위/신뢰 인프라**  
   - 신고 도우미(증거 첨부) + 실매물 인증 배지(메타데이터 규격) + SLA 안내.
9. **현장 촬영 도우미(프로툴)**  
   - 체크샷 가이드, EXIF 검증, 워터마크, 품질 스코어. 에이전트가 “누락 컷” 경고.
10. **인근 비교(대체안 탐색)**  
   - 10~20분 통행시간/학군/예산을 유지하면서 **대체 후보 10개** 제시.
11. **문서 생성 1-click**  
   - 매물 카드·투어 루트·비용 산출표·계약 전 체크리스트를 **PDF/링크**로 내보내기.
12. **대화형 에이전트**  
   - “이 필지, 뭘 지을 수 있지?” → 규제·허용행위·성능지표를 **근거 링크 포함** 대화로 안내(허브 정본 딥링크).

---

## 2) **데이터/지도 파이프라인** (권위→표준화→지오서비스)
**A. 주소·지오코딩 계층(권위 소스 우선)**  
- 1차: 도로명주소 API(행안부) → `admCd / rnMgtSn / bdMgtSn / entX / entY` 획득.  
- 2차: (옵션) VWorld/카카오 로컬 API로 보강(좌표계 변환·행정동/법정동 역변환·POI).  
- 예외: “보안주소” 등 반환 불가 케이스는 **정책상 미노출 처리**(대체 절차/안내).

**B. 좌표계/코드 표준화**  
- 입력 좌표계 자동 감지(메타/샘플링) → **통합 표준 = WGS84(4326)**.  
- 한국 좌표군(5181·5186·5179·WTM·ITRF2000) 지원.  
- 코드: 법정동/행정동 코드, 도로명코드, **PNU** 매핑.

**C. 규제/공간 레이어**  
- EUM/지자체 도시계획/NSDI 데이터셋으로 **용도/지구/구역·도면** 오버레이.  
- 지도 타일/벡터 레이어 캐시(타일 서버 자체 운영 or VWorld 타일).

**D. 가격/지수/거래 레이어**  
- 공시가격(Realtyprice) 열람 링크 + 연도별 데이터 인제스트(허용 범위).  
- 실거래가: 공공데이터포털 API 경유(법적/정책 준수).

**E. 인덱스/검색**  
- 주소·법정동·필지·단지·POI·규제 레이어를 **단일 검색(FTS + 지오 쿼리)**로 노출.

---

## 3) **DB 스키마+API 계약(요지)**
- `geo.addresses`: 입력 원문/정규화 주소, admCd/rnMgtSn/bdMgtSn, 좌표(WGS84), 소스/증거.  
- `geo.parcels`: PNU, 폴리곤, 면적/지목, 행정코드, 좌표계.  
- `geo.regulations`: parcel_id ↔ 용도지역/지구/구역/고시문, 요약/원문링크.  
- `market.public_prices`: 연도별 공시가격, 유형, 링크.  
- `market.transactions`: 실거래(요약) + 원문 링크/증거 스냅샷 경로.  
- `infra.poi`: 학교/역/버스/병원/공원/상권… 카테고리/좌표/권위소스.  
- `calc.rules`: 세금/보수/전월세전환/DSR 규칙(버전 관리).  
- `ops.evidence`: 수집 스냅샷(append-only), 해시/라이선스/robots 준수 플래그.  

**핵심 API**  
- `POST /api/geo/normalize` → Juso→표준화 주소·좌표·코드  
- `GET /api/parcel/:pnu` → 경계, 규제 TL;DR, 링크  
- `GET /api/overlay?layers=use,zones,...&bbox=...` → 지도 레이어 타일/벡터  
- `GET /api/price/public?parcel|apt=...` → 공시/지수/시계열  
- `GET /api/infra/isochrone?from=...&modes=...` → 통행시간 등고선  
- `POST /api/doc/brief` → PDF/카드 생성(계산기/체크리스트 포함)

---

## 4) **MVP → V1 → V2** (현실적 타임라인)
- **MVP(3–6주)**  
  - 주소 정규화(Juso) + 좌표계 표준화 + 필지 경계 조회 + **규제 TL;DR 카드**  
  - 공시가격·실거래 요약 링크/검색, 인근 인프라 반경 조회, 계산기 3종(취득세/전월세/중개보수)  
  - 지도 레이어: 용도지역·지구·구역 + 학교/역/병원  
- **V1(2–3개월)**  
  - 아이소크론(출퇴근), 규제 변화 히스토리, 개발/청약 레이더, 대체안 추천, 문서 생성 1-click  
  - 사진/EXIF 체크·워터마크, 신고/인증 워크플로(승인 게이트)  
- **V2(6–9개월)**  
  - 개인화 추천(가중치 학습), 지역 리포트 자동 발행, 파트너 CRM/리드 라우팅, 제휴/광고 네트워크 연동

---

## 5) **에이전트/앱 연동 패턴**
- 모든 카드 하단에 **허브 Canonical + 앱 딥링크(gumgang://...)** 자동 주입.  
- `agent_id / utm_*`를 KPI에 귀속(허브↔앱↔배포 루프 최적화).  
- 계산/체크/예약/신고는 **마이크로 앱**으로 쪼개서 설치·재방문 유도.

---

## 6) **품질/신뢰/법적 가드레일**
- **robots/약관 준수**: API 우선, HTML 크롤링은 요청량 제한·지연·변경감지(diff)·스냅샷 보관.  
- **예외 주소(보안주소)**는 정책상 미노출·대체 안내.  
- 모든 화면에 **출처/갱신시각/라이선스** 표기.  
- 개인정보/민감정보 마스킹, 신고·인증 컨텐츠는 **리뷰/승인** 후 공개.

---

## 7) **선행 구현 레퍼런스에서 얻는 교훈 → 즉시 적용**
- **Juso**: 주소→코드/좌표까지 한 번에(행안부 표준 체계).  
- **카카오 로컬/VWorld**: 좌표↔주소, 좌표계 변환, 키워드/카테고리 장소, 행정동/법정동 역변환(보조).  
- **서울/지자체 오픈데이터**: 좌표계가 섞여 있음(ITRF2000/WTM/WGS84) → **좌표 표준화 계층을 제품 핵심로직**으로.  
- **NSDI/좌표 코드표**: 한국형 좌표군을 공식 EPSG로 통일 관리 → 변환 정확도·성능 확보.  
- **정책 포털/공시/지수**: 스크래핑 회피, 링크/공식 파일 인제스트 중심 → 법적 리스크 최소.

---

## 8) 오늘 바로 착수 체크리스트(개발)
- [ ] `geo-normalize` 마이크로서비스(Juso → 표준화 → 코드/좌표 반환)  
- [ ] 좌표계 변환 유닛(proj 파생) + **자동 좌표 인지**  
- [ ] `parcel-regulation` 조합(EUM/도시계획) TL;DR 규칙 엔진(v0)  
- [ ] 지도 레이어 프리셋(용도지역/지구/구역/학교/지하철/병원)  
- [ ] 계산기 3종 + 카드 PDF 내보내기  
- [ ] KPI 스키마에 `platform, agent_id, deeplink_ref` 추가
참고/출처(핵심만):

도로명주소 API: 요청/응답 필드(행정코드·좌표 entX/entY 등)와 에러코드, 보안 필터 가이드. 
Juso Information Portal

카카오 로컬 API: 주소↔좌표·행정동/법정동 역변환·좌표계 변환(지원 좌표계), REST 가이드. 
Kakao Developers
+1

카카오 DevTalk: 보안주소 정책 – 일부 주소는 좌표 미제공(정책상 미노출). 
카카오 데브톡

서울 오픈데이터: 데이터셋 좌표계 표기(ITRF2000, WGS1984) 사례 → 좌표 표준화 필요. 
data.seoul.go.kr
+1

한국 좌표계 코드표(통계청 SGIS): 4326/5181/5179/5186/WTM 등. 
KOSIS

VWorld 지오코딩(공식 가이드 경로·예시, 인증키 발급/주소→좌표 API): 레퍼런스 페이지/예시. 
홍시의 씽크탱크
+1

서울 부동산정보광장 소개(통합 조회 UX 레퍼런스). 
서울정책아카이브 Seoul Solution



# 실행 템플릿 묶음 (드롭인 파일세트)
> 한 번에 복붙하여 저장소에 넣고 바로 개발 착수할 수 있도록 **엔드포인트 명세**, **좌표계 변환 코드**, **규제 TL;DR 룰셋**, **지도 레이어 스타일(JSON)**을 한 블록에 제공합니다.  
> ⚠️ 법률/세무/행정 해석이 필요한 값(용적률/건폐율 등)은 **지자체 조례**에 따라 달라질 수 있으므로, 본 템플릿의 수치 예시는 *플레이스홀더*입니다. 실제 서비스 반영 시 반드시 **공식 고시/조례 데이터셋**으로 덮어써 주세요.

---

## ── BEGIN FILE: `openapi/openapi.yaml`
openapi: 3.1.0
info:
  title: Gumgang RealEstate Geo/Content API
  version: 0.1.0
servers:
  - url: https://hub.example.com
    description: production (placeholder)
  - url: http://localhost:5175
    description: dev
security:
  - ApiKeyAuth: []
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
  schemas:
    Error:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        details: { type: object }
    AddressNormalizeRequest:
      type: object
      required: [query]
      properties:
        query: { type: string, description: "도로명/지번/POI/좌표 문자열" }
        prefer:
          type: object
          properties:
            source: { type: string, enum: [juso, vworld, kakao], description: "선호 지오코더" }
            lang: { type: string, enum: [ko, en] }
    AddressNormalized:
      type: object
      properties:
        query: { type: string }
        road_addr: { type: string }
        jibun_addr: { type: string }
        law_dong: { type: string, description: "법정동명" }
        adm_cd: { type: string, description: "행정구역코드" }
        rnMgtSn: { type: string, description: "도로명코드" }
        bdMgtSn: { type: string, description: "건물관리번호" }
        coord:
          type: object
          properties:
            wgs84: { type: array, items: { type: number }, minItems: 2, maxItems: 2, description: "[lon,lat]" }
            epsg:   { type: object, additionalProperties: { type: array, items: { type: number } } }
        pnu: { type: string, nullable: true }
        source: { type: string, enum: [juso, cache, vworld, kakao] }
        evidence: { type: string, description: "증거 스냅샷 경로" }
    ParcelResponse:
      type: object
      properties:
        pnu: { type: string }
        area_m2: { type: number }
        polygon: { type: object, description: "GeoJSON Polygon/MultiPolygon EPSG:4326" }
        centroid: { type: array, items: { type: number }, minItems: 2, maxItems: 2 }
        regulations:
          type: array
          items:
            type: object
            properties:
              category: { type: string, enum: [용도지역, 용도지구, 용도구역, 기타] }
              code: { type: string }
              name: { type: string }
              tldr: { type: string }
              constraints:
                type: object
                properties:
                  far_range: { type: string, nullable: true }
                  bcr_range: { type: string, nullable: true }
                  height: { type: string, nullable: true }
                  notes: { type: string, nullable: true }
              sources: { type: array, items: { type: string } }
              updated_at: { type: string, format: date-time }
        links: { type: object, additionalProperties: { type: string } }
    PriceSeries:
      type: object
      properties:
        series: { type: array, items:
          type: object
          properties:
            date: { type: string, format: date }
            value: { type: number }
            unit: { type: string }
        }
        source: { type: string }
paths:
  /api/geo/normalize:
    post:
      summary: "주소/POI/좌표 문자열을 표준화 주소·코드·좌표로 변환"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AddressNormalizeRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AddressNormalized" }
        "400":
          description: Bad Request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/parcel/{pnu}:
    get:
      summary: "PNU로 필지 경계·규제 TL;DR·링크 반환"
      parameters:
        - name: pnu
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ParcelResponse" }
        "404":
          description: Not Found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
  /api/overlay/tiles/{z}/{x}/{y}:
    get:
      summary: "벡터 타일(MVT) — layers=parcels,use_zones,districts,infra"
      parameters:
        - { name: z, in: path, required: true, schema: { type: integer } }
        - { name: x, in: path, required: true, schema: { type: integer } }
        - { name: y, in: path, required: true, schema: { type: integer } }
        - { name: layers, in: query, required: false, schema: { type: string } }
      responses:
        "200":
          description: MVT
          content:
            application/x-protobuf: {}
  /api/overlay/features:
    get:
      summary: "GeoJSON 피처 — bbox/레이어로 질의"
      parameters:
        - { name: layers, in: query, schema: { type: string } }
        - { name: bbox, in: query, schema: { type: string }, description: "minLon,minLat,maxLon,maxLat" }
      responses:
        "200":
          description: OK (FeatureCollection)
          content:
            application/geo+json: {}
  /api/market/public_price:
    get:
      summary: "공시가격 시계열(요약)"
      parameters:
        - { name: pnu, in: query, schema: { type: string } }
        - { name: years, in: query, schema: { type: string }, description: "e.g., 2015-2025" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PriceSeries" }
  /api/market/transactions:
    get:
      summary: "실거래 요약(공공데이터포털 API 경유)"
      parameters:
        - { name: admCd, in: query, schema: { type: string } }
        - { name: type, in: query, schema: { type: string, enum: [sale, rent] } }
        - { name: year, in: query, schema: { type: integer } }
      responses:
        "200": { description: OK }
  /api/infra/isochrone:
    get:
      summary: "아이소크론(등시간 곡선) — walk/transit/drive"
      parameters:
        - { name: from, in: query, schema: { type: string }, description: "lon,lat" }
        - { name: minutes, in: query, schema: { type: integer, default: 30 } }
        - { name: modes, in: query, schema: { type: string, default: "transit" } }
      responses:
        "200": { description: OK }
  /api/doc/brief:
    post:
      summary: "PDF/카드 생성 — 계산/체크리스트/지도 스냅샷 포함"
      responses:
        "200": { description: OK }
## ── END FILE: `openapi/openapi.yaml`

---

## ── BEGIN FILE: `server/routes/geo_normalize.ts` (Next.js Route Handlers 스타일, TS 스텁)
import type { NextRequest } from "next/server";
import { NextResponse } from "next/server";
import { normalizeAddress } from "../../services/geo/normalize";

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const result = await normalizeAddress(body);
    return NextResponse.json(result, { status: 200 });
  } catch (e: any) {
    return NextResponse.json({ code: "BAD_REQUEST", message: e?.message || "invalid" }, { status: 400 });
  }
}
## ── END FILE

---

## ── BEGIN FILE: `server/services/geo/normalize.ts` (Juso→표준화 어댑터 스텁)
import { fetchJuso } from "./providers/juso";
import { ensureAllEpsg } from "./proj/transform";

export async function normalizeAddress(body: { query: string; prefer?: { source?: string } }) {
  const raw = await fetchJuso(body.query); // TODO: fallback vworld/kakao
  // shape: { roadAddr, jibunAddr, admCd, rnMgtSn, bdMgtSn, entX, entY }
  const wgs84 = ensureAllEpsg({ x: Number(raw.entX), y: Number(raw.entY), srcEpsg: 4326 });
  return {
    query: body.query,
    road_addr: raw.roadAddr,
    jibun_addr: raw.jibunAddr,
    law_dong: raw.lawDong,
    adm_cd: raw.admCd,
    rnMgtSn: raw.rnMgtSn,
    bdMgtSn: raw.bdMgtSn,
    coord: { wgs84: [wgs84.lon, wgs84.lat], epsg: { "5179": wgs84.epsg5179, "5181": wgs84.epsg5181 } },
    pnu: null, // TODO: parcel lookup by coord
    source: "juso",
    evidence: `status/evidence/geo/${Date.now()}.json`
  };
}
## ── END FILE

---

## ── BEGIN FILE: `server/services/geo/proj/transform.py` (파이썬 좌표계 변환 유틸)
# requirements: pyproj>=3.5, shapely(optional)
from typing import Tuple, Dict, Any, Iterable
from pyproj import Transformer, CRS

KOREA_BOUNDS_WGS84 = (124.0, 33.0, 132.0, 39.5)  # lon_min, lat_min, lon_max, lat_max

TRANSFORMERS = {
    (5179, 4326): Transformer.from_crs("EPSG:5179", "EPSG:4326", always_xy=True),  # UTM-K -> WGS84
    (5181, 4326): Transformer.from_crs("EPSG:5181", "EPSG:4326", always_xy=True),  # Korea2000 / Unified CS
    (5186, 4326): Transformer.from_crs("EPSG:5186", "EPSG:4326", always_xy=True),
    (4326, 5179): Transformer.from_crs("EPSG:4326", "EPSG:5179", always_xy=True),
    (4326, 5181): Transformer.from_crs("EPSG:4326", "EPSG:5181", always_xy=True),
    (4326, 5186): Transformer.from_crs("EPSG:4326", "EPSG:5186", always_xy=True),
}

def infer_epsg(x: float, y: float) -> int:
    # 단순 휴리스틱: 위경도 범위면 4326, 아니면 UTM-K/Unified 등 후보 중 한국 영역으로 변환했을 때 정상인지 검사
    if -180.0 <= x <= 180.0 and -90.0 <= y <= 90.0:
        return 4326
    for src in (5179, 5181, 5186):
        lon, lat = TRANSFORMERS[(src, 4326)].transform(x, y)
        if KOREA_BOUNDS_WGS84[0] <= lon <= KOREA_BOUNDS_WGS84[2] and KOREA_BOUNDS_WGS84[1] <= lat <= KOREA_BOUNDS_WGS84[3]:
            return src
    raise ValueError("Unable to infer EPSG for given coordinates")

def to_wgs84(x: float, y: float, src_epsg: int | None = None) -> Dict[str, Any]:
    if src_epsg is None:
        src_epsg = infer_epsg(x, y)
    if src_epsg == 4326:
        lon, lat = x, y
    else:
        lon, lat = TRANSFORMERS[(src_epsg, 4326)].transform(x, y)
    # 역변환도 같이 제공
    epsg5179 = TRANSFORMERS[(4326, 5179)].transform(lon, lat)
    epsg5181 = TRANSFORMERS[(4326, 5181)].transform(lon, lat)
    return {"lon": lon, "lat": lat, "src_epsg": src_epsg, "epsg5179": epsg5179, "epsg5181": epsg5181}

def transform_coords(coords: Iterable[Tuple[float, float]], src: int, dst: int) -> list[tuple[float, float]]:
    tr = TRANSFORMERS[(src, dst)]
    return [tr.transform(x, y) for (x, y) in coords]

# GeoJSON Geometry 변환 (Polygon/MultiPolygon)
def transform_geom(geom: Dict[str, Any], src: int, dst: int) -> Dict[str, Any]:
    t = TRANSFORMERS[(src, dst)]
    gtype = geom.get("type")
    coords = geom.get("coordinates")
    if gtype == "Point":
        x, y = coords
        return {"type": "Point", "coordinates": list(t.transform(x, y))}
    def ring(r): return [list(t.transform(x, y)) for (x, y) in r]
    if gtype == "Polygon":
        return {"type": "Polygon", "coordinates": [ring(r) for r in coords]}
    if gtype == "MultiPolygon":
        return {"type": "MultiPolygon", "coordinates": [[ring(r) for r in poly] for poly in coords]}
    raise NotImplementedError(f"Unsupported geometry: {gtype}")
## ── END FILE

---

## ── BEGIN FILE: `server/services/geo/proj/transform.ts` (Node/TS 버전, proj4+epsg-index)
import proj4 from "proj4";
import epsg from "epsg-index/all.json" assert { type: "json" };

// 필요한 EPSG 정의 등록 (런타임 로딩)
function ensureDef(code: number) {
  const rec = (epsg as any)[code];
  if (!rec) throw new Error(`EPSG ${code} not found in epsg-index`);
  if (!(proj4 as any).defs[`EPSG:${code}`]) {
    (proj4 as any).defs(`EPSG:${code}`, rec.proj4);
  }
}
["4326","5179","5181","5186"].forEach(c => ensureDef(Number(c)));

export function toWgs84(x: number, y: number, srcEpsg?: number) {
  const src = srcEpsg ?? inferEpsg(x, y);
  const [lon, lat] = src === 4326 ? [x, y] : proj4(`EPSG:${src}`, "EPSG:4326", [x, y]);
  const epsg5179 = proj4("EPSG:4326","EPSG:5179",[lon,lat]);
  const epsg5181 = proj4("EPSG:4326","EPSG:5181",[lon,lat]);
  return { lon, lat, srcEpsg: src, epsg5179, epsg5181 };
}

export function inferEpsg(x: number, y: number): number {
  if (Math.abs(x) <= 180 && Math.abs(y) <= 90) return 4326;
  for (const candidate of [5179,5181,5186]) {
    const [lon,lat] = proj4(`EPSG:${candidate}`,"EPSG:4326",[x,y]) as [number,number];
    if (lon>=124 && lon<=132 && lat>=33 && lat<=39.5) return candidate;
  }
  throw new Error("Cannot infer EPSG");
}
## ── END FILE

---

## ── BEGIN FILE: `rules/regulation_tldr_kr.yml` (규제 TL;DR 룰셋 — *예시/플레이스홀더*)
meta:
  version: 0.1.0
  disclaimer: >
    본 룰셋의 수치(용적률/건폐율/높이 등)는 예시입니다.
    실제 적용은 각 지자체 조례·지구단위계획 결정서·고시문을 데이터셋으로 연동해야 합니다.
defaults:
  notes: "지자체 조례 확인 필요"
  sources:
    - "https://www.eum.go.kr"
use_zone:  # 용도지역 (예시 키워드 매칭)
  - key: "제1종일반주거지역"
    code: R1
    color: "#F2F7FF"
    icon: "home"
    tldr: "저층 위주 주거지역. 근린생활시설 일부 허용."
    typical_constraints:
      far_range: "100–200% (조례별 상이)"
      bcr_range: "50–60% (조례별 상이)"
      height: "저층/중층 제한 가능"
  - key: "제2종일반주거지역"
    code: R2
    color: "#E3EEFF"
    icon: "home-2"
    tldr: "중층 주거지역. 소규모 근생 허용 범위 확대."
    typical_constraints:
      far_range: "150–250%"
      bcr_range: "50–60%"
      height: "중층"
  - key: "제3종일반주거지역"
    code: R3
    color: "#D6E6FF"
    tldr: "중고층 주거지역. 공동주택 비율 상승."
    typical_constraints:
      far_range: "200–300%"
      bcr_range: "50–60%"
  - key: "중심상업지역"
    code: C1
    color: "#FFE8D6"
    tldr: "상업/업무 중심. 주거·숙박 혼합 가능(조례)."
    typical_constraints:
      far_range: "400–800% (지구단위에 따름)"
      bcr_range: "60–80%"
  - key: "일반공업지역"
    code: I1
    color: "#FFF4CC"
    tldr: "공업·창고·도소매 혼재 가능. 환경·안전 규제 유의."
    typical_constraints:
      far_range: "200–350%"
      bcr_range: "60–70%"

use_district:  # 용도지구/기타 지구(예시)
  - key: "경관지구"
    code: D_VIEW
    color: "#E8F5E9"
    tldr: "경관 보전·형성. 높이·색채·마감 제한 빈번."
    effects:
      height: "경관축·조망권 제한"
      notes: "立面·색채 지침 확인"
  - key: "고도지구"
    code: D_HEIGHT
    color: "#E0F2F1"
    tldr: "높이 제한 강함. 층수/최고높이 명확."
    effects:
      height: "최고높이 N m (고시별)"
  - key: "지구단위계획구역"
    code: D_UDZ
    color: "#FFFDE7"
    tldr: "블록 단위 상세지침(용도혼합, 공개공지, 보행동선 등)."
    effects:
      far_range: "블록별 상이"
      bcr_range: "블록별 상이"
      notes: "결정서/도서 확인 필수"
  - key: "개발제한구역"
    code: D_GB
    color: "#FBE9E7"
    tldr: "도시확산 억제. 건축/용도전환 매우 제한."
    effects:
      far_range: "극제한"
      notes: "보전/복구 의무"

composition:  # TL;DR 생성 규칙
  priority: ["use_district.D_GB", "use_district.D_HEIGHT", "use_district.D_UDZ", "use_zone.*"]
  rules:
    - id: combine_far_bcr
      when: "any of effects.far_range/bcr_range present"
      action: "pick strictest if numeric range, else '조례 확인'"
    - id: summarize
      action: "compose tldr lines: [주용도지역 TLDR, 중첩지구 핵심, 주의사항]"
  output:
    format: |
      • 주용도지역: {zone_name} — {zone_tldr}
      • 중첩지구: {districts_short}
      • 예상 제약: 용적률 {far} / 건폐율 {bcr} / 높이 {height}
      • 비고: {notes}
## ── END FILE

---

## ── BEGIN FILE: `map/styles/realestate_kr.json` (MapLibre/Mapbox 스타일 v8)
{
  "version": 8,
  "name": "Gumgang RealEstate KR",
  "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
  "sprite": "https://demotiles.maplibre.org/styles/osm-bright/sprite",
  "sources": {
    "basemap": {
      "type": "raster",
      "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
      "tileSize": 256
    },
    "overlays": {
      "type": "vector",
      "tiles": ["https://hub.example.com/api/overlay/tiles/{z}/{x}/{y}?layers=parcels,use_zones,districts,infra"],
      "minzoom": 6,
      "maxzoom": 18
    }
  },
  "layers": [
    { "id": "basemap", "type": "raster", "source": "basemap" },

    { "id": "parcels-fill",
      "type": "fill",
      "source": "overlays",
      "source-layer": "parcels",
      "paint": {
        "fill-color": "rgba(255,255,255,0.0)",
        "fill-outline-color": "rgba(0,0,0,0.2)"
      }
    },
    { "id": "use-zones-fill",
      "type": "fill",
      "source": "overlays",
      "source-layer": "use_zones",
      "paint": {
        "fill-color": [
          "match",
          ["get","code"],
          "R1", "#F2F7FF",
          "R2", "#E3EEFF",
          "R3", "#D6E6FF",
          "C1", "#FFE8D6",
          "I1", "#FFF4CC",
          /* other */ "#ECEFF1"
        ],
        "fill-opacity": [
          "interpolate", ["linear"], ["zoom"],
          10, 0.25,
          14, 0.5
        ]
      }
    },
    { "id": "use-zones-line",
      "type": "line",
      "source": "overlays",
      "source-layer": "use_zones",
      "paint": { "line-color": "rgba(0,0,0,0.25)", "line-width": 0.5 }
    },

    { "id": "districts-fill",
      "type": "fill",
      "source": "overlays",
      "source-layer": "districts",
      "paint": {
        "fill-color": [
          "match",
          ["get","code"],
          "D_GB", "#FBE9E7",    /* 개발제한구역 */
          "D_HEIGHT", "#E0F2F1",/* 고도지구 */
          "D_UDZ", "#FFFDE7",   /* 지구단위계획구역 */
          "D_VIEW", "#E8F5E9",  /* 경관지구 */
          "#F3E5F5"
        ],
        "fill-opacity": [
          "interpolate", ["linear"], ["zoom"],
          10, 0.12,
          14, 0.3
        ]
      }
    },
    { "id": "districts-line",
      "type": "line",
      "source": "overlays",
      "source-layer": "districts",
      "paint": { "line-color": "rgba(0,0,0,0.25)", "line-width": 0.6, "line-dasharray": [2,2] }
    },

    { "id": "parcels-hover",
      "type": "line",
      "source": "overlays",
      "source-layer": "parcels",
      "filter": ["==", ["get","pnu"], ["get","hover_pnu"]],
      "paint": { "line-color": "#2962FF", "line-width": 2.0 }
    },

    { "id": "labels-zones",
      "type": "symbol",
      "source": "overlays",
      "source-layer": "use_zones",
      "minzoom": 13,
      "layout": {
        "text-field": ["get","name"],
        "text-size": 12,
        "text-allow-overlap": false
      },
      "paint": {
        "text-color": "#263238",
        "text-halo-color": "#ffffff",
        "text-halo-width": 1.5
      }
    }
  ]
}
## ── END FILE

---

## ── 추가: 빠른 로컬 검증용 cURL (참고)
# 주소 표준화
# curl -X POST http://localhost:5175/api/geo/normalize -H "Content-Type: application/json" -d '{"query":"서울특별시 중구 세종대로 110"}'
# 필지 조회
# curl "http://localhost:5175/api/parcel/1111010100100000000"
# 오버레이 GeoJSON
# curl "http://localhost:5175/api/overlay/features?layers=use_zones,districts&bbox=126.9,37.5,127.1,37.6"

---

## ▶ 적용 가이드
- **수치/제약치**: `rules/regulation_tldr_kr.yml` 내 범위값은 *예시*입니다. 지자체별 조례·지구단위 **공식 데이터셋**으로 자동 갱신하세요.  
- **좌표계**: 모든 입력 좌표를 `transform.py/ts`로 **WGS84 표준화** 후 저장/색인.  
- **타일서버**: `/api/overlay/tiles`는 벡터 타일 생성기(tegola/tippecanoe+tileserver 혹은 PostGIS+ST_AsMVT)로 구현 권장.  
- **법적 표시**: 지도·카드·PDF 하단에 반드시 **출처/갱신시각/라이선스** 표기.  

완료입니다. 필요하면 **타일 생성 SQL 예시(PostGIS)**와 **지오코딩 공급자(Juso/VWorld) 연결 어댑터** 샘플도 이어서 내려드릴게요.
