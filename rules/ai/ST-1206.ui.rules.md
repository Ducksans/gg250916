# ST-1206 — UI Guardrails (Simple mode only)
Last-Updated: 2025-08-25
Applies-To: A1 Chat “Simple” Layout (body.simple), non-destructive

Purpose
- Prevent accidental layout regressions during T3 (S1–S2).
- Codify non‑negotiable UI invariants for the ChatGPT-like single-scroll UX.

Why this exists
- Natural-language driven edits can bypass local conventions. We freeze the core invariants in a rules file, add a static checker to block bad merges, and run a runtime sensor in dev to surface violations immediately.

Scope
- Simple mode only (body.simple). Pro mode remains unaffected.
- Files mainly involved:
  - ui/overlays/active.css
  - ui/overlays/active.js
  - ui/snapshots/unified_A1-A4_v0/index.html

MUST (invariants)
- Single-scroll topology
  - Global scrollbars hidden (Simple only): html, body { overflow: hidden }.
  - Exactly two scroll containers inside A1: #gg-threads (left), #chat-msgs (right timeline).
- Grid wrapper
  - #a1-wrap is CSS grid: grid-template-rows: auto 1fr auto (or auto minmax(0,1fr) auto to clamp).
  - #a1-wrap height must track strip: height: calc(100dvh - var(--gg-strip-h)).
- Timeline/Composer alignment
  - Use a single width token: --gg-chat-width: clamp(720px, 82vw, 902px).
  - #chat-msgs and the composer block share the same centered width.
- Composer actions marking
  - The button row is marked [data-gg="composer-actions"] and is placed at grid column 2 on the same row as the input (row 3).
- Centered, stretch, and scroll rules
  - #chat-msgs consumes the middle track and owns the vertical scroll: overflow-y: auto; min-height: 0.
  - The track uses minmax(0,1fr) to allow shrinking (prevents min-content expansion).
- Evidence lists never introduce a third scroller in A1
  - Evidence detail lists inside #chat-msgs must not create extra overflow:auto containers in Simple mode.

MUST-NOT
- No inline display:flex on #a1-wrap (this disables grid).
- No self-closing wrapper for #a1-wrap (e.g., <div id="a1-wrap"></div>). Open at section start, close only once at section end.
- No additional overflow:auto containers under #a1 beyond the whitelisted two (#gg-threads, #chat-msgs).
- Do not center #chat-msgs via align-self:center in Simple mode (breaks vertical fill/scroll); use align-self:stretch.

AC (Acceptance Criteria)
- Global scrollbar hidden (Simple only), inside A1 exactly two overflow:auto: ["gg-threads","chat-msgs"].
- #a1-wrap display:grid; row template = auto minmax(0,1fr) auto; height = calc(100dvh - var(--gg-strip-h)).
- Timeline and composer share the same centered width (—gg-chat-width).
- Composer buttons (send/anchor) are on the same line, placed at grid column 2 (right edge).
- Mobile rotation/keyboard: composer remains fully visible (100dvh + safe-area padding).
- Console errors: 0. Runtime sensor warnings: 0.

How to use these rules in Zed/GPT tasks
- Always attach this file to the prompt when asking AI to edit A1 chat layout/CSS/JS.
- Any proposed change must answer:
  1) Does it keep exactly two scroll containers? 2) Does it preserve #a1-wrap grid? 3) Does it keep composer-actions on col2?

Static check (pre-commit/CI)
- scripts/check_ui_guardrails.cjs
  - Verifies:
    - body.simple #a1-wrap is grid.
    - Only the two allowed scroll containers are referenced in CSS (heuristic).
    - data-gg="composer-actions" exists in the snapshot HTML (warn if runtime-only).
- Package script:
  - "guard:ui": "node scripts/check_ui_guardrails.cjs"
- Run in CI and/or pre-commit; block on failure.

Runtime sensor (dev only)
- In ui/overlays/active.js, add assertUIPitstop() executed when localStorage.gg_env !== 'prod' and body.simple:
  - Checks:
    - SCROLLER_VIOLATION if overflow:auto containers in #a1 subtree != ["gg-threads","chat-msgs"].
    - WRAP_NOT_GRID if #a1-wrap is not grid.
    - MISSING_COMPOSER_ACTIONS_MARK if [data-gg="composer-actions"] is absent.
  - Log via console.error with structured payload.

Implementation anchors (for reviewers)
- Two scrollers: enforce via CSS reset inside #a1 subtree (overflow:visible by default; auto only for #gg-threads, #chat-msgs).
- Grid clamp: grid-template-rows: auto minmax(0,1fr) auto; ensure min-height:0 chain on #a1/#a1-right/#a1-wrap/#chat-msgs.
- Composer row pinning: grid-row:3 for #chat-input, [data-gg="composer-actions"], and #anchor-result; safe-area bottom padding for composer comfort.
- Width parity: set --gg-chat-width; apply to #chat-msgs and composer.

Quick QA — 5 minutes
1) Global: no page scrollbar (Simple only).
2) A1 subtree (DevTools):
   [...document.querySelectorAll('#a1 *')]
     .filter(e=>{const cs=getComputedStyle(e);return cs.overflow==='auto'||cs.overflowY==='auto';})
     .map(e=>e.id||e.className)
   → exactly ["gg-threads","chat-msgs"]
3) getComputedStyle(document.getElementById('a1-wrap')).display === "grid".
4) !!document.querySelector('[data-gg="composer-actions"]') === true.
5) Desktop + mobile portrait screenshots:
   - Timeline scrolls; composer fully visible; buttons on the same line (right side).

Stop-the-line policy
- If any guard fails (static or runtime), stop and fix before continuing T3.
- If a legitimate change needs a 3rd scroller, update this file + static checker + sensor together and request approval.

Changelog discipline
- Commit/PR title: "[ST-1206] UI guardrails (rules + static + sensor)".
- Attach QA captures and static/sensor logs to the PR.

Notes
- These guardrails are Simple-mode only; Pro/other tabs are unaffected.
- Use minmax(0,1fr) (not plain 1fr) to avoid min-content vertical expansion.
- Prefer data-gg markers for durable CSS targeting across DOM refactors.
